<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Barry Harris Complete Music Theory Generator</title>
    <style>
        /* Role colors */
        .key-root{ 
            background: linear-gradient(135deg,#10b981,#059669) !important; 
            color:#fff !important;
        }
        
        .key-third{ 
            background: linear-gradient(135deg,#3b82f6,#2563eb) !important; 
            color:#fff !important;
        }
        
        .key-fifth{ 
            background: linear-gradient(135deg,#f59e0b,#d97706) !important; 
            color:#fff !important;
        }
        
        .key-seventh{ 
            background: linear-gradient(135deg,#7209b7,#6d28d9) !important; 
            color:#fff !important;
        }
        
        .key-ext{ 
            background: linear-gradient(135deg,#06b6d4,#0891b2) !important; 
            color:#fff !important;
        }

        /* Piano toolbar */
        .piano-toolbar{ 
            display:flex; 
            gap:8px; 
            align-items:center; 
            margin-top:14px; 
            flex-wrap:wrap;
        }

        .piano-toolbar button{ 
            padding:8px 12px; 
            border-radius:6px; 
            border:1px solid #e5e7eb; 
            background:#fff; 
            cursor:pointer; 
            font-weight:600;
            transition: var(--transition);
        }

        .piano-toolbar button:hover {
            background: var(--light);
            transform: translateY(-1px);
        }

        .piano-toolbar button.primary{ 
            background:#4361ee; 
            color:#fff; 
            border-color:#4361ee;
        }

        .piano-toolbar button.primary:hover {
            background:#3a56d4;
        }

        .piano-toolbar .badge{ 
            padding:6px 10px; 
            border-radius:12px; 
            background:#e5e7eb; 
            font-size:0.85rem;
            font-weight: 600;
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1400px) {
            .app-container {
                grid-template-columns: 1fr 500px;
            }
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .step-content {
                grid-template-columns: 1fr;
            }
            
            .piano-stage {
                min-width: 400px;
                height: 120px;
            }

            .pw-white {
                height: 110px;
            }

            .pw-black {
                height: 70px;
                bottom: 40px; /* 110 - 70 */
            }
        }

        /* ==================== UTILITY ==================== */
        .hidden {
            display: none !important;
        }

        .history-panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            display: none;
            max-height: 200px;
            overflow: auto;
        }
    </style>
    <!-- Three.js (Phase 0 scaffold) -->
    <script src="https://unpkg.com/three@0.156.1/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.156.1/examples/js/controls/OrbitControls.js"></script>
    <style id="ui-polish-overrides">
        /* ===== UI Polish: readable defaults and balanced sizing ===== */
        html, body { color:#0f172a; background:#f8fafc; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; font-size:14px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header h1 { font-size:2rem; line-height:1.2; color:#0f172a; margin-bottom:6px; }
        .header p { color:#334155; font-size:1rem; }

        /* Step cards */
        .flow-step { background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
        .step-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
        .step-number { background:#0ea5e9; color:#ffffff; width:24px; height:24px; border-radius:999px; display:grid; place-items:center; font-weight:700; font-size:12px; }
        .step-title { font-weight:700; color:#0f172a; }
        .step-controls { gap:8px !important; }

        /* Controls */
        .btn-step, select.btn-step, input.btn-step { height:34px; padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1; background:#ffffff; color:#0f172a; font-weight:600; }
        .btn-step:hover { background:#f1f5f9; }
        .btn-step.btn-generate { background:#2563eb; border-color:#2563eb; color:#ffffff; }
        .btn-step.btn-generate:hover { background:#1d4ed8; }
        .btn-step.btn-clear { background:#ef4444; border-color:#ef4444; color:#ffffff; }
        .btn-step.btn-clear:hover { background:#dc2626; }
        input[type="number"].btn-step, select.btn-step { background:#ffffff; }

        /* Results */
        .result-label { color:#334155; font-weight:700; font-size:0.95rem; margin:8px 0 4px; }
        .result-value { color:#0f172a; font-size:0.95rem; }

        /* Numbers chips */
        .num-chip { font-size:0.95rem; padding:6px 8px; border-radius:8px; border:1px solid #e5e7eb; background:#f8fafc; color:#0f172a; }
        #numbers-display { gap:6px; }

        /* Panels and sidebars */
        #ui-shell { background:#0f172a; color:#e2e8f0; }
        #ui-shell .panel-item { border-radius:8px; }
        #ui-shell .panel-item:hover { background:#111827; }
        #ui-shell .tag, .tag { background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1; border-radius:999px; padding:4px 10px; font-size:12px; }

        /* Zones */
        #layout-zones { gap:12px; }
        .tool-window { background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; }
        .tool-window .resize-handle { background:#cbd5e1; border-color:#94a3b8; }

        /* Piano */
        .piano-toolbar button { border-color:#cbd5e1; }
        .piano-stage { background:#0b1324; border-radius:8px; }

        /* Smaller on compact screens */
        @media (max-width: 1024px){
            html, body { font-size:13.5px; }
            .header h1 { font-size:1.8rem; }
        }
        @media (max-width: 768px){
            html, body { font-size:13px; }
            .step-content { grid-template-columns: 1fr !important; }
        }
    </style>
    <style id="ui-simplify-overrides">
        /* Sticky mini-toolbar */
        #mini-toolbar{ position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(4px); background:rgba(248,250,252,0.8); border-bottom:1px solid #e5e7eb; padding:6px 10px; display:flex; gap:8px; align-items:center; }
        #mini-toolbar .mt-btn{ height:32px; border-radius:8px; border:1px solid #cbd5e1; background:#ffffff; color:#0f172a; font-weight:600; padding:4px 10px; cursor:pointer; }
        #mini-toolbar .primary{ background:#2563eb; border-color:#2563eb; color:#fff; }
        #mini-toolbar .danger{ background:#ef4444; border-color:#ef4444; color:#fff; }
        #mini-toolbar .sep{ flex:1; opacity:0; }
        /* Step-1 transform collapse */
        .transform-menu{ position:relative; display:inline-block; }
        .transform-menu .tm-panel{ position:absolute; top:36px; left:0; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:8px; display:none; box-shadow:0 10px 20px rgba(2,6,23,.12); min-width:240px; z-index:60; }
        .transform-menu.open .tm-panel{ display:block; }
        .transform-menu .tm-row{ display:flex; flex-wrap:wrap; gap:6px; }
        .transform-menu .tm-row > *{ margin:0 !important; }
        /* Hide duplicate controls we moved into menu (only when menu exists) */
        .has-transform-menu #step-1 #btn-retrograde,
        .has-transform-menu #step-1 #btn-invert,
        .has-transform-menu #step-1 #btn-rot-left,
        .has-transform-menu #step-1 #btn-rot-right,
        .has-transform-menu #step-1 #rotate-n,
        .has-transform-menu #step-1 #btn-rotate-n,
        .has-transform-menu #step-1 #invert-axis,
        .has-transform-menu #step-1 #btn-randomize{ display:none !important; }
        /* Focus Mode */
        body.focus-mode #ui-shell, body.focus-mode #layout-zones > :not(.tool-window), body.focus-mode .header { display:none !important; }
        #focus-bar{ position:sticky; top:0; z-index:60; background:#0f172a; color:#e2e8f0; border-bottom:1px solid #1f2937; padding:8px 10px; display:none; align-items:center; gap:8px; }
        body.focus-mode #focus-bar{ display:flex; }
        #focus-bar .fb-btn{ height:32px; border-radius:8px; border:1px solid #334155; background:#111827; color:#e2e8f0; font-weight:600; padding:4px 10px; cursor:pointer; }
        #focus-bar .fb-title{ font-weight:700; margin:0 8px; }
        /* Minimal Tabs */
        #top-tabs{ position:sticky; top:0; z-index:55; background:#ffffffcc; backdrop-filter:blur(4px); border-bottom:1px solid #e5e7eb; display:flex; gap:6px; padding:8px 10px; }
        #top-tabs .tab{ border:1px solid #cbd5e1; background:#ffffff; color:#0f172a; border-radius:999px; padding:6px 12px; font-weight:700; cursor:pointer; }
        #top-tabs .tab.active{ background:#0ea5e9; color:#ffffff; border-color:#0ea5e9; }
        /* Do NOT hide shell/toolflow/zones - keep all panels accessible */
        /* body.minimal-mode #ui-shell, body.minimal-mode #layout-zones, body.minimal-mode #toolflow{ display:none !important; } */
        /* Ensure main container stays readable */
        body.minimal-mode .container{ max-width: 1100px; margin: 8px auto; }
        /* Compact panel layouts: group related tools */
        .panel-section{ background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-bottom:12px; }
        .panel-section .section-title{ font-weight:700; color:#0f172a; margin-bottom:8px; }
        .panel-section .controls-row{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
        .panel-section .controls-row > *{ margin:0; }
        .panel-section .result-block{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:8px; margin-top:8px; }
        .panel-section .result-block .label{ font-weight:700; color:#334155; font-size:0.9rem; }
        .panel-section .result-block .value{ color:#0f172a; margin-top:4px; }
        /* Do not hide native controls in minimal mode */
        body.minimal-mode .step-controls{ display:initial !important; }
        body.minimal-mode #step-1{ display:initial !important; }
        body.minimal-mode #numbers-display,
        body.minimal-mode #current-numbers { display:initial !important; }
        /* Numbers Strip (always visible under header) */
        #numbers-strip{ background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin:10px 0; }
        #numbers-strip .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
        #numbers-strip .label{ font-weight:700; color:#334155; }
        #numbers-strip .value{ color:#0f172a; }
        #numbers-strip .spacer{ flex:1; }
        #ns-transforms .btn-step{ height:32px; }
        /* Keep tabs/mini-toolbar/menus visible */
        #top-tabs{ display:flex !important; }
        #mini-toolbar, .transform-menu{ display:initial !important; }
        /* Results Toolbar (under Results > Current Numbers) */
        #results-toolbar{ background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:8px; margin:8px 0; }
        #results-toolbar .row{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
        #results-toolbar .spacer{ flex:1; }
        #results-toolbar .btn-step{ height:32px; }
        
        /* ==================== DETAILED CHORD DISPLAY ==================== */
        .chord-function-group {
            margin-bottom: 16px;
            border-left: 4px solid #cbd5e1;
            padding-left: 12px;
        }
        
        .function-group-title {
            font-weight: 700;
            color: #0f172a;
            font-size: 0.95rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }
        
        .detailed-chord {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .detailed-chord:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .detailed-chord.grade-perfect {
            border-left: 4px solid #10b981;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
        }
        
        .detailed-chord.grade-excellent {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent);
        }
        
        .detailed-chord.grade-good {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, rgba(245, 158, 11, 0.05), transparent);
        }
        
        .detailed-chord.grade-fair {
            border-left: 4px solid #6b7280;
            background: linear-gradient(to right, rgba(107, 114, 128, 0.05), transparent);
        }
        
        .chord-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .chord-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #0f172a;
        }
        
        .chord-grade {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .chord-grade.grade-perfect {
            background: #d1fae5;
            color: #065f46;
        }
        
        .chord-grade.grade-excellent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .chord-grade.grade-good {
            background: #fef3c7;
            color: #92400e;
        }
        
        .chord-grade.grade-fair {
            background: #e5e7eb;
            color: #374151;
        }
        
        .chord-notes {
            color: #475569;
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        .chord-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .detail-row {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .detail-label {
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.3px;
        }
        
        .detail-value {
            color: #0f172a;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        
        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .role-root {
            background: #d1fae5;
            color: #065f46;
        }
        
        .role-third {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .role-fifth {
            background: #fef3c7;
            color: #92400e;
        }
        
        .role-seventh {
            background: #e9d5ff;
            color: #6b21a8;
        }
        
        .role-ninth {
            background: #fed7aa;
            color: #92400e;
        }
        
        .role-eleventh {
            background: #c7d2fe;
            color: #3730a3;
        }
        
        .role-thirteenth {
            background: #fbcfe8;
            color: #831843;
        }
        
        .role-extension {
            background: #f3f4f6;
            color: #374151;
        }
        
        /* ==================== LEFT-TO-RIGHT LAYOUT ==================== */
        .app-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 16px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: flex-start;
        }
        
        .tool-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 320px;
            flex-shrink: 0;
        }
        
        .column-header {
            font-weight: 700;
            font-size: 0.95rem;
            color: #0f172a;
            padding: 8px 12px;
            background: #ffffff;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .column-input .column-header { border-left-color: #10b981; }
        .column-visual .column-header { border-left-color: #3b82f6; }
        .column-analysis .column-header { border-left-color: #f59e0b; }
        .column-exploration .column-header { border-left-color: #7209b7; }
        .column-utilities .column-header { border-left-color: #06b6d4; }
        
        .tool-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tool-section:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .tool-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: #0f172a;
            margin-bottom: 4px;
        }
        
        .step-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        
        .btn-step {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: #ffffff;
            color: #0f172a;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-step:hover {
            background: #f1f5f9;
            border-color: #94a3b8;
        }
        
        .btn-generate {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }
        
        .btn-generate:hover {
            background: #1d4ed8;
        }
        
        .btn-clear {
            background: #ef4444;
            color: #ffffff;
            border-color: #ef4444;
        }
        
        .btn-clear:hover {
            background: #dc2626;
        }
        
        .numbers-display {
            background: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            color: #0f172a;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .piano-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .piano-roll {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            overflow-x: auto;
        }
        
        .piano-wrap {
            display: inline-block;
        }
        
        .option-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .option-card:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }
        
        .option-title {
            font-weight: 700;
            font-size: 0.85rem;
            color: #0f172a;
        }
        
        .option-description {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 2px;
            transition: opacity 0.2s ease;
        }
        
        .option-card.expanded .option-description {
            opacity: 0.7;
        }
        
        .option-results {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            border-top: none;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        .option-results.expanded {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .exploration-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .exploration-content {
            font-size: 0.8rem;
            color: #475569;
            line-height: 1.4;
        }

        .progression-example, .reharm-section, .voicing-section, .numbers-section, .analysis-section {
            margin-bottom: 12px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 4px;
        }

        .close-results {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-results:hover {
            background: #dc2626;
        }

        .column-exploration .option-results {
            max-width: 100%;
            box-sizing: border-box;
        }

        .option-description {
            transition: opacity 0.2s ease;
        }

        .option-card.expanded .option-description {
            opacity: 0.7;
        }
        
        .result-value {
            color: #0f172a;
            font-size: 0.9rem;
            word-break: break-word;
        }
        
        .filter-toggle:hover {
            background: #f1f5f9;
            border-color: #94a3b8;
        }
        
        .filter-toggle.active {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }
        
        .muted {
            color: #94a3b8;
            font-size: 0.85rem;
        }
        
        /* ==================== EXPANDABLE NUMBER DISPLAY ==================== */
        .numbers-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 6px;
            font-weight: 600;
            color: #0f172a;
            font-size: 0.9rem;
        }
        
        .number-item {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
            min-width: 50px;
            text-align: center;
        }
        
        .number-item:hover {
            border-color: #2563eb;
            background: #dbeafe;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }
        
        .number-item.active {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        #number-expansions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-start;
        }
        
        .number-expansion {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            min-width: 200px;
            position: relative;
        }
        
        .number-expansion.expanded {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .number-expansion-inline {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            transition: all 0.3s ease;
        }
        
        .number-expansion-inline.expanded {
            background: #f8fafc;
            border-color: #2563eb;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.15);
        }
        
        .number-inline {
            background: #f1f5f9;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .number-inline:hover {
            border-color: #2563eb;
            background: #dbeafe;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }
        
        .number-inline.active {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .expansion-content-inline {
            display: none;
            flex: 1;
            padding: 8px;
        }
        
        .expansion-content-inline.expanded {
            display: block;
        }
        
        .expansion-header {
            background: #f8fafc;
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .expansion-header:hover {
            background: #f1f5f9;
        }
        
        .expansion-title {
            font-size: 0.95rem;
            color: #0f172a;
        }
        
        .expansion-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #64748b;
            transition: transform 0.2s ease;
        }
        
        .expansion-content {
            display: none;
            padding: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .expansion-content.expanded {
            display: block;
            max-height: 2000px;
        }
        
        .chord-sections {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chord-section {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background: #f8fafc;
        }
        
        .section-title {
            font-weight: 700;
            font-size: 0.85rem;
            color: #0f172a;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .chord-option {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chord-option:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }
        
        .chord-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: #0f172a;
        }
        
        .chord-notes {
            font-size: 0.75rem;
            color: #475569;
            margin-top: 2px;
        }
        
        .chord-function {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        /* ==================== INLINE EXPANSION STYLES ==================== */
        .chord-sections-inline {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chord-section-inline {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
        }
        
        .section-title-inline {
            font-weight: 700;
            font-size: 0.8rem;
            color: #0f172a;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .chord-grid-small {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 6px;
        }
        
        .chord-option-small {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chord-option-small:hover {
            border-color: #2563eb;
            background: #dbeafe;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.15);
        }
        
        .chord-name-small {
            font-weight: 700;
            font-size: 0.85rem;
            color: #0f172a;
        }
        
        .chord-notes-small {
            font-size: 0.7rem;
            color: #475569;
            margin-top: 2px;
        }
        
        .chord-function-small {
            font-size: 0.65rem;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .tone-btn-small {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .tone-btn-small:hover {
            background: #dbeafe;
            border-color: #2563eb;
        }
        
        .tone-deg {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-left: 2px;
        }
        
        /* ==================== CONTAINER CHORDS ORGANIZATION ==================== */
        .match-group-expander {
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .match-group-header {
            background: #f8fafc;
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 0.9rem;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .match-group-header:hover {
            background: #f1f5f9;
        }
        
        .match-grade {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .match-grade.grade-perfect {
            background: #d1fae5;
            color: #065f46;
        }
        
        .match-grade.grade-excellent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .match-grade.grade-good {
            background: #fef3c7;
            color: #92400e;
        }
        
        .match-grade.grade-fair {
            background: #e5e7eb;
            color: #374151;
        }
        
        .expander-icon {
            font-size: 0.8rem;
            transition: transform 0.2s ease;
        }
        
        .match-group-expander:not(.expanded) .expander-icon {
            transform: rotate(-90deg);
        }
        
        .match-group-content {
            display: none;
            padding: 12px;
            background: #ffffff;
        }
        
        .match-group-expander.expanded .match-group-content {
            display: block;
        }
        
        .function-subsection {
            margin-bottom: 12px;
        }
        
        .function-subsection:last-child {
            margin-bottom: 0;
        }
        
        .function-subsection-title {
            font-weight: 700;
            font-size: 0.85rem;
            color: #0f172a;
            padding: 6px 8px;
            background: #f1f5f9;
            border-left: 3px solid #2563eb;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .chord-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }
        
        .chord-item-compact {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .chord-item-compact:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .chord-item-compact.selected {
            background: #dbeafe;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        
        .chord-item-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: #0f172a;
        }
        
        .chord-item-notes {
            font-size: 0.75rem;
            color: #475569;
            word-break: break-word;
        }
        
        .chord-item-meta {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.2px;
        }
    </style>
    <link rel="stylesheet" href="aperture-theme.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéµ Parker Chace Complete Music Theory Generator</h1>
            <p>
                Explore numbers as melody, chords, and harmonic possibilities using Barry Harris's random number approach and Parker Chace music theory visualization.
                Discover ALL chords that contain your notes‚Äîprioritized by scale membership. Interactive piano with voice leading.
            </p>
            <div class="header-controls">
                <button class="reset-btn" id="save-session">üíæ Save Session</button>
                <button class="reset-btn" id="load-session">üìÇ Load Session</button>
                <button class="reset-btn" id="export-midi">üéπ Export MIDI</button>
            </div>
        </div>

        <!-- Main App Container -->
        <div class="app-container">
            <!-- Column 1: INPUT & GENERATION -->
            <div class="tool-column column-input">
                <div class="column-header">üì• Input & Generation</div>
                
                <!-- Generate Numbers -->
                <div class="tool-section" id="step-1">
                    <div class="tool-title">‚ë† Generate Numbers</div>
                    <div class="step-controls">
                            <select id="number-type" class="btn-step" style="flex:2">
                                <option value="diatonic">Diatonic (1-7)</option>
                                <option value="barry8">Barry Harris 8-Tone (1-8)</option>
                                <option value="extended">Extended (1-14)</option>
                                <option value="chromatic">Chromatic/Altered</option>
                            </select>
                            <input id="number-seq-len" type="number" min="2" max="12" value="4" style="width:70px" class="btn-step">
                            <button class="btn-step btn-generate" id="btn-gen-numbers">Generate</button>
                            <button class="btn-step btn-clear" id="btn-clear-numbers">Clear</button>
                            <button class="btn-step" id="btn-undo-numbers">Undo</button>
                            <button class="btn-step" id="btn-history-numbers">History</button>
                            <button class="btn-step" id="btn-retrograde" title="Reverse order">Retrograde</button>
                            <button class="btn-step" id="btn-invert" title="Degree complement within scale">Invert</button>
                            <button class="btn-step" id="btn-rot-left" title="Rotate left">‚ü≤</button>
                            <button class="btn-step" id="btn-rot-right" title="Rotate right">‚ü≥</button>
                            <input id="rotate-n" type="number" min="1" max="32" value="1" class="btn-step" style="width:72px" title="Rotate by N" />
                            <button class="btn-step" id="btn-rotate-n">Rotate N</button>
                            <select id="invert-axis" class="btn-step" style="min-width:120px" title="Invert around axis N">
                                <option value="auto" selected>Axis: Auto</option>
                                <option value="7">Axis: 7</option>
                                <option value="8">Axis: 8</option>
                                <option value="14">Axis: 14</option>
                            </select>
                            <button class="btn-step" id="btn-randomize" title="Randomize with constraints">Randomize</button>
                        </div>
                        <div class="numbers-display" id="numbers-display">7, 2, 4, 3</div>
                        <div id="numbers-history" class="history-panel"></div>
                    </div>
                </div>

                <!-- Select Key & Scale -->
                <div class="tool-section" id="step-2">
                    <div class="tool-title">‚ë° Select Key & Scale</div>
                    <div class="step-content">
                            <select id="key-select" class="btn-step">
                                <option value="C">C</option>
                                <option value="G">G</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="E">E</option>
                                <option value="B">B</option>
                                <option value="F#">F#</option>
                                <option value="F">F</option>
                                <option value="Bb">Bb</option>
                                <option value="Eb">Eb</option>
                                <option value="Ab">Ab</option>
                                <option value="Db">Db</option>
                            </select>
                            <select id="scale-select" class="btn-step">
                                <optgroup label="Major & Modes">
                                    <option value="major">Major (Ionian)</option>
                                    <option value="dorian">Dorian</option>
                                    <option value="phrygian">Phrygian</option>
                                    <option value="lydian">Lydian</option>
                                    <option value="mixolydian">Mixolydian</option>
                                    <option value="aeolian">Minor (Aeolian)</option>
                                    <option value="locrian">Locrian</option>
                                </optgroup>
                                <optgroup label="Melodic Minor Modes">
                                    <option value="melodic">Melodic Minor</option>
                                    <option value="lydian_aug">Lydian Augmented</option>
                                    <option value="lydian_dom">Lydian Dominant</option>
                                    <option value="mixolydian_b6">Mixolydian b6</option>
                                    <option value="altered">Altered (Super Locrian)</option>
                                    <option value="locrian_nat2">Locrian #2 (Half Diminished)</option>
                                </optgroup>
                                <optgroup label="Harmonic/Hybrid">
                                    <option value="harmonic">Harmonic Minor</option>
                                    <option value="harmonic_major">Harmonic Major</option>
                                    <option value="double_harmonic_major">Double Harmonic (Byzantine)</option>
                                    <option value="phrygian_dominant">Phrygian Dominant</option>
                                </optgroup>
                                <optgroup label="Symmetric">
                                    <option value="whole_tone">Whole Tone</option>
                                    <option value="octatonic_dim">Octatonic (Dim)</option>
                                </optgroup>
                                <optgroup label="Pentatonic & Blues (Africa/Americas)">
                                    <option value="major_pentatonic">Major Pentatonic</option>
                                    <option value="minor_pentatonic">Minor Pentatonic</option>
                                    <option value="egyptian_pentatonic">Egyptian Pentatonic</option>
                                    <option value="west_african_pentatonic">West African Pentatonic (Yo)</option>
                                    <option value="andean_pentatonic">Andean Pentatonic</option>
                                    <option value="blues_hexatonic">Blues Hexatonic</option>
                                </optgroup>
                                <optgroup label="Middle East (12-TET approx)">
                                    <option value="hijaz">Hijaz</option>
                                </optgroup>
                                <optgroup label="Japan (12-TET pentatonics)">
                                    <option value="japanese_hirajoshi">Hirajoshi</option>
                                    <option value="japanese_kumoi">Kumoi</option>
                                    <option value="japanese_in_sen">In Sen</option>
                                    <option value="japanese_yo">Yo</option>
                                </optgroup>
                                <optgroup label="India (12-TET approx)">
                                    <option value="raga_bhairav_approx">Raga Bhairav (approx)</option>
                                </optgroup>
                                <optgroup label="Barry Harris 8-Tone Scales">
                                    <option value="barry_major6dim">Barry Harris Major 6 Dim</option>
                                    <option value="barry_dom7dim">Barry Harris Dom 7 Dim</option>
                                    <option value="barry_minor6dim">Barry Harris Minor 6 Dim</option>
                                </optgroup>
                            </select>
                            <button class="btn-step btn-generate" id="btn-set-keyscale">Apply</button>

                            <!-- Piano Visualizer for Scale Degrees -->
                            <div class="piano-section">
                                <div class="result-label">üéπ Scale Degrees</div>
                                <div class="piano-roll">
                                    <div class="piano-wrap">
                                        <div id="piano-stage" class="piano-stage"></div>
                                    </div>
                                </div>
                                <div class="piano-info">
                                    <span class="badge" id="voicing-label">Scale: ‚Äî</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: VISUAL REFERENCE -->
            <div class="tool-column column-visual">
                <div class="column-header">üé® Visual Reference</div>
                
                <!-- Scale Degrees Piano -->
                <div class="tool-section">
                    <div class="tool-title">‚ë¢ Scale Degrees</div>
                    <div class="piano-section">
                        <div class="piano-roll">
                            <div class="piano-wrap">
                                <div id="piano-stage" class="piano-stage"></div>
                            </div>
                        </div>
                        <div class="piano-info">
                            <span class="badge" id="voicing-label">Scale: ‚Äî</span>
                        </div>
                    </div>
                </div>

                <!-- Scale Circle Explorer -->
                <div class="tool-section" id="chord-circle-section">
                    <div class="tool-title">‚ë£ Scale Circle Explorer</div>
                    <div class="chord-wheel-container">
                        <div class="chord-wheel" id="chord-wheel">
                            <div class="chord-wheel-center" id="wheel-center">I</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 3: DIRECT ANALYSIS -->
            <div class="tool-column column-analysis">
                <div class="column-header">üîç Direct Analysis</div>
                
                <!-- Number Chord Explorer -->
                <div class="tool-section" id="number-expansions-section">
                    <div class="tool-title">‚ë§ Number Chord Explorer</div>
                    <div class="muted" style="font-size:0.85rem; margin-bottom:8px;">(Click numbers above to expand)</div>
                    <div id="number-expansions-list"></div>
                </div>

                <!-- Container Chords Explorer -->
                <div class="tool-section" id="container-section">
                    <div class="tool-title">‚ë• Container Chords Explorer</div>
                    <div class="container-filter-bar">
                        <button class="filter-toggle active" data-filter="all">All Chords</button>
                        <button class="filter-toggle" data-filter="scale">In Scale Only</button>
                        <button class="filter-toggle" data-filter="triads">Triads</button>
                        <button class="filter-toggle" data-filter="sevenths">7ths</button>
                        <button class="filter-toggle" data-filter="extended">Extended</button>
                    </div>
                    <div id="container-chords-list"></div>
                </div>
            </div>

            <!-- Column 4: DEEP EXPLORATION -->
            <div class="tool-column column-exploration">
                <div class="column-header">üöÄ Deep Exploration</div>
                
                <!-- Advanced Exploration -->
                <div class="tool-section" id="step-3">
                    <div class="tool-title">‚ë¶ Advanced Exploration</div>
                    <div class="step-content" id="step-4-content">
                        <div class="option-card" data-explore="progressions">
                            <div class="option-title">Progressions</div>
                            <div class="option-description">Generate chord progressions</div>
                        </div>
                        <div class="option-card" data-explore="reharmonization">
                            <div class="option-title">Reharmonization</div>
                            <div class="option-description">Alternate harmonic options</div>
                        </div>
                        <div class="option-card" data-explore="voicing">
                            <div class="option-title">Voicings</div>
                            <div class="option-description">Different chord voicings</div>
                        </div>
                        <div class="option-card" data-explore="numbers_progression">
                            <div class="option-title">Progression from Numbers</div>
                            <div class="option-description">Build chords from numbers and explore substitutions</div>
                        </div>
                        <div class="option-card" data-explore="analysis">
                            <div class="option-title">Deep Analysis</div>
                            <div class="option-description">ML-inspired insights</div>
                        </div>
                    </div>
                </div>
                <div id="exploration-results"></div>
            </div>

            <!-- Column 5: UTILITIES & INFO -->
            <div class="tool-column column-utilities">
                <div class="column-header">üìã Reference & Control</div>
                
                <!-- Core Info -->
                <div class="tool-section">
                    <div class="tool-title">Current State</div>
                    <div class="result-section">
                        <div class="result-label">üî¢ Numbers</div>
                        <div class="numbers-display" id="current-numbers">7, 2, 4, 3</div>
                    </div>
                    <div class="result-section">
                        <div class="result-label">üéπ Key & Scale</div>
                        <div class="result-value" id="key-scale-context">C Major</div>
                    </div>
                    <div class="result-section">
                        <div class="result-label">üéµ As Notes</div>
                        <div class="result-value" id="notes-result">B, D, F, E</div>
                    </div>
                    <div class="result-section">
                        <div class="result-label">üéº As Diatonic Chords</div>
                        <div class="result-value" id="chords-result">Bm7‚ô≠5, Dm7, Fmaj7, Em7</div>
                    </div>
                </div>

                <!-- Session Controls -->
                <div class="tool-section">
                    <div class="tool-title">Session</div>
                    <button class="reset-btn" id="reset-all" style="width:100%; margin-bottom:6px;">üîÑ Reset All</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== MUSIC THEORY ENGINE ====================
        const MusicTheory = {
            chromaticNotes: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
            
            noteValues: {
                'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8,
                'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
            },

            scales: {
                // Western common (validated)
                major: [0, 2, 4, 5, 7, 9, 11],
                dorian: [0, 2, 3, 5, 7, 9, 10],
                phrygian: [0, 1, 3, 5, 7, 8, 10],
                lydian: [0, 2, 4, 6, 7, 9, 11],
                mixolydian: [0, 2, 4, 5, 7, 9, 10],
                aeolian: [0, 2, 3, 5, 7, 8, 10],
                locrian: [0, 1, 3, 5, 6, 8, 10],
                melodic: [0, 2, 3, 5, 7, 9, 11], // melodic minor (jazz ascending)
                altered: [0, 1, 3, 4, 6, 8, 10], // Super-Locrian
                harmonic: [0, 2, 3, 5, 7, 8, 11], // harmonic minor
                harmonic_major: [0, 2, 4, 5, 7, 8, 11],
                double_harmonic_major: [0, 1, 4, 5, 7, 8, 11], // Byzantine
                phrygian_dominant: [0, 1, 4, 5, 7, 8, 10], // 5th mode of harmonic minor
                whole_tone: [0, 2, 4, 6, 8, 10],
                octatonic_dim: [0, 2, 3, 5, 6, 8, 9, 11],

                // Barry Harris (existing)
                barry_major6dim: [0, 2, 3, 4, 5, 7, 9, 10],
                barry_dom7dim: [0, 2, 3, 4, 6, 7, 9, 10],
                barry_minor6dim: [0, 2, 3, 5, 6, 8, 9, 11],

                // Pentatonics and blues (Africa, Americas, pan-cultural)
                major_pentatonic: [0, 2, 4, 7, 9], // widely used (incl. Andean)
                minor_pentatonic: [0, 3, 5, 7, 10],
                egyptian_pentatonic: [0, 2, 5, 7, 10], // "suspended" pentatonic
                west_african_pentatonic: [0, 2, 5, 7, 9], // Yo scale (pentatonic)
                andean_pentatonic: [0, 2, 4, 7, 9], // alias of major pentatonic
                blues_hexatonic: [0, 3, 5, 6, 7, 10],

                // Middle East (12-TET approximations)
                hijaz: [0, 1, 4, 5, 7, 8, 11], // same pitch set as double harmonic on the same tonic

                // East Asia (Japanese pentatonics in 12-TET)
                japanese_hirajoshi: [0, 2, 3, 7, 8],
                japanese_kumoi: [0, 2, 3, 7, 9],
                japanese_in_sen: [0, 1, 5, 7, 10],
                japanese_yo: [0, 2, 5, 7, 9],

                // Indic (12-TET approximation)
                raga_bhairav_approx: [0, 1, 4, 5, 7, 8, 11]
            },

            diatonicChordTypes: ['maj7', 'm7', 'm7', 'maj7', '7', 'm7', 'm7b5'],
            barry8ChordTypes: ['6', 'dim7', 'm7', 'maj7', '7', 'm7', 'dim7', 'm7b5'],

            chordFormulas: {
                'maj': [0, 4, 7],
                'm': [0, 3, 7],
                'dim': [0, 3, 6],
                'aug': [0, 4, 8],
                'sus2': [0, 2, 7],
                'sus4': [0, 5, 7],
                'maj7': [0, 4, 7, 11],
                'm7': [0, 3, 7, 10],
                '7': [0, 4, 7, 10],
                'm7b5': [0, 3, 6, 10],
                'dim7': [0, 3, 6, 9],
                'mMaj7': [0, 3, 7, 11],
                '7sus4': [0, 5, 7, 10],
                'maj7#5': [0, 4, 8, 11],
                '6': [0, 4, 7, 9],
                'm6': [0, 3, 7, 9],
                '9': [0, 4, 7, 10, 14],
                'maj9': [0, 4, 7, 11, 14],
                'm9': [0, 3, 7, 10, 14],
                '7b9': [0, 4, 7, 10, 13],
                '7#9': [0, 4, 7, 10, 15],
                '11': [0, 4, 7, 10, 14, 17],
                'm11': [0, 3, 7, 10, 14, 17],
                '7#11': [0, 4, 7, 10, 18],
                '13': [0, 4, 7, 10, 14, 21],
                'maj13': [0, 4, 7, 11, 14, 21],
                '7b13': [0, 4, 7, 10, 20],
                'alt': [0, 3, 6, 10, 13, 15],
                'm7#5': [0, 3, 8, 10],
                '7b5': [0, 4, 6, 10],
                '7#5': [0, 4, 8, 10],
                'maj7#11': [0, 4, 7, 11, 18]
            },

            getNoteFromInterval(root, semitones) {
                const rootValue = this.noteValues[root];
                const targetValue = (rootValue + semitones) % 12;
                return this.chromaticNotes[targetValue];
            },

            getScaleNotes(key, scaleType) {
                const intervals = this.scales[scaleType] || this.scales.major;
                return intervals.map(interval => this.getNoteFromInterval(key, interval));
            },

            getChordNotes(root, chordType) {
                const formula = this.chordFormulas[chordType];
                if (!formula) return [];
                return formula.map(interval => this.getNoteFromInterval(root, interval));
            },

            getChordComplexity(chordType) {
                if (chordType.includes('13') || chordType.includes('11') || chordType.includes('9')) {
                    return 'extended';
                } else if (chordType.includes('7') || chordType.includes('6')) {
                    return 'seventh';
                } else {
                    return 'triad';
                }
            },

            // Build a chord by stacking diatonic "thirds" within any scale.
            // degree: 1-based index into the scale; size: 3=triad, 4=seventh, etc.
            buildScaleChord(key, scaleType, degree=1, size=3) {
                const scaleNotes = this.getScaleNotes(key, scaleType);
                if (!scaleNotes.length) return { notes: [], degrees: [] };
                const n = scaleNotes.length;
                // Clamp chord size to available scale tones to avoid unrealistic repeats on small scales
                const effSize = Math.max(1, Math.min(size, n));
                const start = ((degree - 1) % n + n) % n;
                const notes = [];
                const degrees = [];
                for (let k = 0; k < effSize; k++) {
                    const idx = (start + k*2) % n; // stacked diatonic 3rds within the scale
                    notes.push(scaleNotes[idx]);
                    // Label degrees relative to the chosen degree within this scale (1..n)
                    const rel = ((idx - start + n) % n);
                    degrees.push(rel === 0 ? 1 : (rel + 1));
                }
                return { notes, degrees };
            },

            findAllContainerChords(notes, scaleNotes) {
                const results = [];

                const key = scaleNotes && scaleNotes.length ? scaleNotes[0] : null;
                const keyVal = key ? this.noteValues[key] : null;
                const semis = (a, b) => (this.noteValues[a] - this.noteValues[b] + 12) % 12;
                const hasMaj3 = (type) => {
                    const f = this.chordFormulas[type];
                    return f && f.includes(4);
                };
                const hasMin3 = (type) => {
                    const f = this.chordFormulas[type];
                    return f && f.includes(3);
                };
                const isDominantQuality = (type) => type.includes('7') && !type.includes('maj7');

                function computeFunctions(root, chordType, keyName) {
                    if (!keyName) return { functions: [], resolutions: [] };
                    const rootToKey = (MusicTheory.noteValues[root] - MusicTheory.noteValues[keyName] + 12) % 12;
                    const funcs = new Set();
                    const res = new Set();

                    const domQual = isDominantQuality(chordType) && hasMaj3(chordType);
                    const majTriad = hasMaj3(chordType) && !chordType.includes('7');
                    const minQual = hasMin3(chordType) && !hasMaj3(chordType);

                    switch (rootToKey) {
                        case 0: // I
                            if (chordType.includes('#5') || chordType.includes('aug')) funcs.add('Tonic (color)');
                            else funcs.add('Tonic');
                            res.add('‚Äî');
                            break;
                        case 2: // II
                            if (minQual) funcs.add('Predominant');
                            if (domQual) { funcs.add('Secondary Dominant (to V)'); res.add('‚Üí V'); }
                            else res.add('‚Üí V');
                            break;
                        case 4: // III
                            if (domQual || majTriad) { funcs.add('Secondary Dominant (to vi)'); res.add('‚Üí vi'); }
                            else funcs.add('Tonic Prolongation');
                            break;
                        case 5: // IV
                            funcs.add('Predominant'); res.add('‚Üí V');
                            break;
                        case 7: // V
                            funcs.add('Dominant'); res.add('‚Üí I');
                            break;
                        case 9: // VI
                            if (minQual) funcs.add('Tonic Prolongation'); else funcs.add('Predominant');
                            res.add('‚Üí ii or ‚Üí V');
                            break;
                        case 11: // VII
                            if (chordType.includes('dim')) { funcs.add('Leading-tone'); res.add('‚Üí I or ‚Üí V'); }
                            else funcs.add('Dominant Color');
                            break;
                        case 1: // bII
                            if (domQual || majTriad) { funcs.add('Tritone Sub (of V)'); res.add('‚Üí V'); }
                            else funcs.add('Modal Interchange');
                            break;
                        case 8: // bVI
                            funcs.add('Modal Interchange (bVI)'); res.add('‚Üí V');
                            break;
                        case 10: // bVII
                            funcs.add('Modal Interchange (bVII)'); res.add('‚Üí I or ‚Üí V');
                            break;
                        case 3: // bIII
                            funcs.add('Modal Interchange (bIII)'); res.add('‚Üí IV or ‚Üí I');
                            break;
                        default:
                            funcs.add('Chromatic/Pivot');
                            res.add('contextual');
                    }

                    if (domQual && !funcs.has('Secondary Dominant (to vi)') && !funcs.has('Tritone Sub (of V)') && !funcs.has('Dominant')) {
                        funcs.add('Dominant-like');
                    }

                    return { functions: Array.from(funcs), resolutions: Array.from(res) };
                }

                this.chromaticNotes.forEach(root => {
                    Object.entries(this.chordFormulas).forEach(([chordType, formula]) => {
                        const chordNotes = this.getChordNotes(root, chordType);
                        const anyNoteContained = notes.some(note => chordNotes.includes(note));
                        if (!anyNoteContained) return;

                        const scaleMatchCount = chordNotes.filter(cn => scaleNotes.includes(cn)).length;
                        const scaleMatchPercent = Math.round((scaleMatchCount / chordNotes.length) * 100);

                        const roles = notes.map(note => {
                            const noteValue = this.noteValues[note];
                            const rootValue = this.noteValues[root];
                            const interval = (noteValue - rootValue + 12) % 12;

                            let role = 'Extension';
                            let roleClass = 'extension';

                            if (interval === 0) { role = 'Root'; roleClass = 'root'; }
                            else if (interval === 3) { role = 'Minor 3rd'; roleClass = 'third'; }
                            else if (interval === 4) { role = 'Major 3rd'; roleClass = 'third'; }
                            else if (interval === 7) { role = 'Fifth'; roleClass = 'fifth'; }
                            else if (interval === 10) { role = 'Minor 7th'; roleClass = 'seventh'; }
                            else if (interval === 11) { role = 'Major 7th'; roleClass = 'seventh'; }
                            else if (interval === 9) { role = '6th/13th'; roleClass = 'thirteenth'; }
                            else if (interval === 2 || interval === 14) { role = '9th'; roleClass = 'ninth'; }
                            else if (interval === 5 || interval === 17) { role = '11th'; roleClass = 'eleventh'; }
                            else if (interval === 21) { role = '13th'; roleClass = 'thirteenth'; }

                            return { note, role, roleClass, interval };
                        });

                        let complexity = 'triad';
                        if (formula.length >= 5) complexity = 'extended';
                        else if (formula.length === 4) complexity = 'seventh';

                        const { functions, resolutions } = computeFunctions(root, chordType, key);

                        results.push({
                            root,
                            chordType,
                            fullName: root + chordType,
                            chordNotes,
                            scaleMatchCount,
                            scaleMatchPercent,
                            roles,
                            complexity,
                            functions,
                            resolutions
                        });
                    });
                });

                results.sort((a, b) => {
                    if (b.scaleMatchPercent !== a.scaleMatchPercent) {
                        return b.scaleMatchPercent - a.scaleMatchPercent;
                    }
                    // Prefer simpler chords slightly and those with clear functions
                    const funcScore = (x) => (x.functions && x.functions.length ? 0 : 1);
                    const cmpFunc = funcScore(a) - funcScore(b);
                    if (cmpFunc !== 0) return cmpFunc;
                    return a.chordNotes.length - b.chordNotes.length;
                });

                return results;
            },

            getDiatonicChord(degree, key, scaleType = 'major') {
                const scaleNotes = this.getScaleNotes(key, scaleType);
                const root = scaleNotes[(degree - 1) % scaleNotes.length];
                const isBarryScale = scaleType.startsWith('barry_');
                const chordTypes = isBarryScale ? this.barry8ChordTypes : this.diatonicChordTypes;
                const chordType = chordTypes[(degree - 1) % chordTypes.length];
                return { root, chordType, fullName: root + chordType };
            }
        };

        // ==================== ACCURATE PIANO RENDERER ====================
        const PIANO = {
            startMidi: 48,
            octaves: 2,
            whiteW: 60,
            stage: null
        };

        const WHITE_ORDER = ['C','D','E','F','G','A','B'];
        const BLACK_IN_OCT = ['C#','D#',null,'F#','G#','A#',null];
        const NAME_TO_SEMI = {C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11};
        const SEMI_TO_NAME = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

        function midiToName(n){ return SEMI_TO_NAME[n%12]; }
        function nameToSemi(n){ return NAME_TO_SEMI[n]; }

        function buildOctaveLayout(x0){
            const W = PIANO.whiteW;
            const leftsWhite = WHITE_ORDER.map((_,i)=> x0 + i*W); // left edges of whites
            // Center blacks on the boundary between adjacent whites; translateX(-50%) centers the black at this x
            const leftsBlack = [
                leftsWhite[1], // C# between C (0) and D (1)
                leftsWhite[2], // D# between D (1) and E (2)
                null,
                leftsWhite[4], // F# between F (3) and G (4)
                leftsWhite[5], // G# between G (4) and A (5)
                leftsWhite[6], // A# between A (5) and B (6)
                null
            ];
            return {leftsWhite,leftsBlack};
        }

        function renderPianoAccurate(activeNotes = [], rolesMap = {}){
            const preferred = document.getElementById('piano-inline') || document.getElementById('piano-stage');
            const stage = PIANO.stage || (PIANO.stage = preferred);

            if (!stage) {
                console.error('Piano stage not found!');
                return;
            }

            stage.innerHTML = '';
            const W = PIANO.whiteW;

            const totalW = PIANO.octaves*7*W;
            stage.style.width = `${totalW}px`;
            stage.style.minWidth = `${totalW}px`;

            // Create stacking layers
            const whitesLayer = document.createElement('div');
            whitesLayer.className = 'whites-layer';
            const blacksLayer = document.createElement('div');
            blacksLayer.className = 'blacks-layer';
            stage.appendChild(whitesLayer);
            stage.appendChild(blacksLayer);

            for(let o=0;o<PIANO.octaves;o++){
                const x0 = o*7*W;
                const {leftsWhite} = buildOctaveLayout(x0);
                WHITE_ORDER.forEach((name,i)=>{
                    const el = document.createElement('div');
                    el.className = 'pw-white';
                    el.style.left = `${leftsWhite[i]}px`;
                    el.style.width = `${W}px`;
                    el.style.height = '70px';
                    el.textContent = name;
                    const midi = PIANO.startMidi + o*12 + nameToSemi(name);
                    el.dataset.midi = midi;
                    const nName = midiToName(midi);
                    if(activeNotes.includes(nName)) el.classList.add('active');
                    const role = rolesMap[nName];
                    if(role) el.classList.add(role);
                    el.onclick = () => handleKeyClick(midi, nName);
                    whitesLayer.appendChild(el);
                });
            }

            for(let o=0;o<PIANO.octaves;o++){
                const x0 = o*7*W;
                const {leftsBlack} = buildOctaveLayout(x0);
                BLACK_IN_OCT.forEach((b,i)=>{
                    if(!b) return;
                    const el = document.createElement('div');
                    el.className = 'pw-black';
                    el.style.left = `${leftsBlack[i]}px`;
                    el.style.width = `${W * 0.6}px`;
                    el.style.height = '45px';
                    el.textContent = b;
                    const midi = PIANO.startMidi + o*12 + nameToSemi(b);
                    el.dataset.midi = midi;
                    const nName = midiToName(midi);
                    if(activeNotes.includes(nName)) el.classList.add('active');
                    const role = rolesMap[nName];
                    if(role) el.classList.add(role);
                    el.onclick = () => handleKeyClick(midi, nName);
                    blacksLayer.appendChild(el);
                });
            }
        }

        // ==================== VOICE LEADING STEPPER ====================
        let VL_STATE = {
            progression: [],
            index: -1,
            locked: false,
            voicing: [],
            currentChordName: ''
        };

        function chordNameToPitchSet(chordName){
            const m = chordName.match(/^([A-G](?:#|b)?)(.*)$/);
            if(!m) return [];
            const root = m[1];
            const type = m[2] || '';
            const rootSemi = nameToSemi(root);
            const lookup = MusicTheory.chordFormulas[type] || MusicTheory.chordFormulas['maj'];
            return lookup.map(s => (rootSemi+s)%12);
        }

        function pickRegister(pcs, base=48){
            let last = base-3, out=[];
            pcs.forEach(pc=>{
                let cand = base + ((pc - (base%12) + 12) % 12);
                while(cand <= last) cand += 12;
                out.push(cand);
                last = cand;
            });
            return out;
        }

        function nearestVoicing(prev, targetPcs){
            const base = (prev && prev.length)? Math.round(prev.reduce((a,b)=>a+b,0)/prev.length) : 52;
            const rootStack = pickRegister(targetPcs, base-6);
            const invs = [
                rootStack,
                [...rootStack.slice(1), rootStack[0]+12],
                rootStack.length>2 ? [...rootStack.slice(2), rootStack[0]+12, rootStack[1]+12] : rootStack
            ];
            let best = invs[0], bestCost = 1e9;
            for(const inv of invs){
                const cost = voiceCost(prev, inv);
                if(cost < bestCost){ bestCost = cost; best = inv; }
            }
            return best;
        }

        function voiceCost(a=[], b=[]){
            if(a.length===0) return 0;
            const len = Math.max(a.length,b.length);
            const aa = [...a]; while(aa.length<len) aa.push(aa[aa.length-1]);
            const bb = [...b]; while(bb.length<len) bb.push(bb[bb.length-1]);
            return aa.reduce((sum,ai,i)=> sum + Math.abs(ai-bb[i]), 0);
        }

        function setActiveChord(chordName){
            VL_STATE.currentChordName = chordName;
            const pcs = chordNameToPitchSet(chordName);
            const prev = VL_STATE.voicing;
            const nextV = nearestVoicing(prev, pcs);
            VL_STATE.voicing = nextV;
            const names = nextV.map(midiToName);
            const roles = roleColorMapFromChord(chordName);
            renderPianoAccurate(names, roles);
            document.getElementById('voicing-label').textContent = `Chord: ${chordName} ‚Ä¢ ${names.join('-')}`;
        }

        function roleColorMapFromChord(chordName){
            const m = chordName.match(/^([A-G](?:#|b)?)(.*)$/);
            if(!m) return {};
            const root = m[1], type = m[2]||'';
            const rootSemi = nameToSemi(root);
            const ints = MusicTheory.chordFormulas[type] || MusicTheory.chordFormulas['maj'];
            const map = {};
            ints.forEach(iv=>{
                const name = SEMI_TO_NAME[(rootSemi+iv)%12];
                let cls = 'key-ext';
                if(iv===0) cls='key-root';
                else if(iv===3||iv===4) cls='key-third';
                else if(iv===7) cls='key-fifth';
                else if(iv===10||iv===11) cls='key-seventh';
                map[name]=cls;
            });
            return map;
        }

        function handleKeyClick(midi, name){
            const present = VL_STATE.voicing.findIndex(v=>v===midi);
            if(present>=0) VL_STATE.voicing.splice(present,1);
            else VL_STATE.voicing.push(midi);
            const names = VL_STATE.voicing.map(midiToName);
            renderPianoAccurate(names, {});
            document.getElementById('voicing-label').textContent = `Custom: ${names.join('-')}`;
        }

        // ==================== APP STATE ====================
        const AppState = {
            currentNumbers: [7, 2, 4, 3],
            numberType: 'diatonic',
            currentKey: 'C',
            currentScale: 'major',
            currentFilter: 'all',
            currentExploration: null,
            completedSteps: [1],
            keyScaleSet: false
        };

        const HISTORY_KEY = 'bh_numbers_history';
        let UNDO_STACK = [];
        function readHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); }catch(e){ return []; } }
        function writeHistory(list){ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,50))); }catch(e){} }
        function pushHistory(entry){ const list = [entry, ...readHistory()].slice(0,50); writeHistory(list); }
        function renderNumbersHistory(){
            const panel = document.getElementById('numbers-history');
            if(!panel) return;
            const list = readHistory();
            if(!list.length){ panel.innerHTML = '<div style="color:#6b7280">No recent generations</div>'; return; }
            const rows = list.map((it,idx)=>{
                const btn = `<button class="filter-toggle" data-idx="${idx}">${(it.numbers||[]).join(', ')}</button>`;
                const meta = `<span style=\"color:#6b7280;font-size:0.85rem;\">${it.type||''} ‚Ä¢ ${it.key||''} ${it.scale||''}</span>`;
                return `<div style=\"margin:4px 0; display:flex; align-items:center; gap:8px; flex-wrap:wrap;\">${btn} ${meta}</div>`;
            }).join('');
            panel.innerHTML = rows;
            panel.querySelectorAll('button[data-idx]').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const idx = parseInt(btn.dataset.idx,10);
                    const item = readHistory()[idx];
                    if(item && item.numbers){
                        AppState.currentNumbers = item.numbers.slice();
                        AppState.numberType = item.type||AppState.numberType;
                        AppState.currentKey = item.key||AppState.currentKey;
                        AppState.currentScale = item.scale||AppState.currentScale;
                        AppState.keyScaleSet = true;
                        updateAllResults();
                        updateNumberTypeLabels();
                    }
                });
            });

            // Helper to refresh the containers grid for a specific single note
            function getColorGrade(scaleMatchPercent) {
                if (scaleMatchPercent === 100) return { class: 'grade-perfect', label: '‚òÖ‚òÖ‚òÖ Perfect' };
                if (scaleMatchPercent >= 75) return { class: 'grade-excellent', label: '‚òÖ‚òÖ Excellent' };
                if (scaleMatchPercent >= 50) return { class: 'grade-good', label: '‚òÖ Good' };
                return { class: 'grade-fair', label: 'Fair' };
            }

            function refreshContainersFor(singleNote){
                try{
                    const grid = content.querySelector('[data-role="containers-grid"]');
                    if (!grid) return;
                    const scaleNotesNow = MusicTheory.getScaleNotes(AppState.currentKey || 'C', AppState.currentScale || 'major') || [];
                    const all = MusicTheory.findAllContainerChords([singleNote], scaleNotesNow) || [];
                    
                    // Group chords by their primary function
                    const grouped = {};
                    all.forEach(chord => {
                        const primaryFunc = chord.functions && chord.functions.length > 0 ? chord.functions[0] : 'Other';
                        if (!grouped[primaryFunc]) grouped[primaryFunc] = [];
                        grouped[primaryFunc].push(chord);
                    });
                    
                    // Sort groups by likelihood (Tonic > Dominant > Predominant > etc)
                    const groupOrder = ['Tonic', 'Dominant', 'Predominant', 'Secondary Dominant', 'Tritone Sub', 'Modal Interchange', 'Chromatic/Pivot', 'Other'];
                    const sortedGroups = groupOrder.filter(g => grouped[g]).concat(Object.keys(grouped).filter(g => !groupOrder.includes(g)));
                    
                    let html = '';
                    sortedGroups.forEach(funcGroup => {
                        const chords = grouped[funcGroup];
                        html += `<div class="chord-function-group">
                            <div class="function-group-title">${funcGroup}</div>`;
                        
                        chords.forEach(chord => {
                            const grade = getColorGrade(chord.scaleMatchPercent);
                            const roleInfo = chord.roles && chord.roles.length > 0 
                                ? chord.roles.map(r => `<span class="role-badge role-${r.roleClass}">${r.role}</span>`).join('')
                                : '';
                            const resolutionInfo = chord.resolutions && chord.resolutions.length > 0
                                ? chord.resolutions.join(', ')
                                : '‚Äî';
                            
                            html += `
                                <div class="chord-option detailed-chord ${grade.class}" data-chord="${chord.fullName}" data-action="replace" data-index="${index}" data-scale-match="${chord.scaleMatchPercent}">
                                    <div class="chord-header">
                                        <div class="chord-name">${chord.fullName}</div>
                                        <div class="chord-grade ${grade.class}">${grade.label}</div>
                                    </div>
                                    <div class="chord-notes">${chord.chordNotes.join(' ‚Ä¢ ')}</div>
                                    <div class="chord-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Roles:</span>
                                            <span class="detail-value">${roleInfo || 'N/A'}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Function:</span>
                                            <span class="detail-value">${chord.functions.join(', ') || 'N/A'}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Resolution:</span>
                                            <span class="detail-value">${resolutionInfo}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Scale Match:</span>
                                            <span class="detail-value">${chord.scaleMatchPercent}% (${chord.scaleMatchCount}/${chord.chordNotes.length})</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    });
                    
                    grid.innerHTML = html;
                    
                    // Rebind click handlers for newly created options
                    grid.querySelectorAll('.chord-option').forEach(opt=>{
                        opt.addEventListener('click', function(event){
                            if (event.target.classList.contains('suggestion-action') || event.target.closest('.suggestion-action')) return;
                            if (!content.classList.contains('expanded')){
                                content.classList.add('expanded');
                                const toggle = header.querySelector('.expansion-toggle');
                                if (toggle) toggle.textContent = '‚ñ≤';
                            }
                            const chordName = this.dataset.chord;
                            const action = this.dataset.action;
                            const targetIndex = this.dataset.index;
                            setActiveChord(chordName);
                            handleChordSuggestion(chordName, action, targetIndex, undefined);
                        });
                    });
                }catch(err){ console.error('refreshContainersFor failed', err); }
            }

            // Wire chord tone buttons: clicking a tone filters containers to chords that contain that tone
            content.querySelectorAll('.tone-btn').forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                    e.preventDefault(); e.stopPropagation();
                    const n = btn.dataset.note;
                    if (n) refreshContainersFor(n);
                });
            });

            // ===== Global rearrangement handlers =====
            function chordRoot(name){ const m=name.match(/^([A-G](?:#|b)?)/); return m? m[1]: AppState.currentKey; }
            function ensureCadence(prog){
                const I = `${AppState.currentKey}maj7`;
                const V = `${MusicTheory.getNoteFromInterval(AppState.currentKey, 7)}7`;
                if (prog[prog.length-1]!==I){
                    if (prog[prog.length-1]!==V) prog.push(V);
                    prog.push(I);
                }
                return prog;
            }
            function appendIIVI(prog){
                const ii = `${MusicTheory.getNoteFromInterval(AppState.currentKey, 2)}m7`;
                const V  = `${MusicTheory.getNoteFromInterval(AppState.currentKey, 7)}7`;
                const I  = `${AppState.currentKey}maj7`;
                prog.push(ii, V, I); return prog;
            }
            function circleRank(root, dir){ // dir: +1 clockwise (fifths), -1 counter
                const semi = nameToSemi(root);
                // map semitone to circle of fifths index relative to C
                // order starting at C: C G D A E B F# C# G# D# A# F
                const order = ['C','G','D','A','E','B','F#','C#','G#','D#','A#','F'];
                const idx = order.findIndex(n=> nameToSemi(n)===semi);
                return dir>0? idx : (order.length - idx);
            }
            function applyDirection(mode){
                // pair chords with meta, operate together
                let pairs = VL_STATE.progression.map((ch,i)=> ({ ch, meta: (VL_STATE.progMeta||[])[i]||{degree:null,source:'unknown'} }));
                if (mode==='to_tonic'){
                    let prog = ensureCadence(pairs.map(p=>p.ch));
                    // when appending, add meta placeholders
                    while (pairs.length < prog.length) pairs.push({ ch: prog[pairs.length], meta:{degree:null, source:'cadence'} });
                    pairs = prog.map((ch,i)=> pairs[i] && pairs[i].ch===ch ? pairs[i] : { ch, meta: pairs[i]?.meta || {degree:null,source:'cadence'} });
                } else if (mode==='away_tonic'){
                    // move tonic away from start; rotate so first chord isn't I
                    const I = `${AppState.currentKey}maj7`;
                    if (pairs[0]?.ch===I && pairs.length>1){ pairs.push(pairs.shift()); }
                } else if (mode==='circle_cw' || mode==='circle_ccw'){
                    const dir = mode==='circle_cw'? +1 : -1;
                    pairs = pairs.slice().sort((a,b)=> circleRank(chordRoot(a.ch),dir)-circleRank(chordRoot(b.ch),dir));
                }
                VL_STATE.progression = pairs.map(p=>p.ch);
                VL_STATE.progMeta = pairs.map(p=>p.meta);
                generateNumbersProgression();
            }
            const dirSel = document.getElementById('direction-select');
            const dirBtn = document.getElementById('apply-direction');
            const btnCad = document.getElementById('btn-add-cadence');
            const btnIIVI = document.getElementById('btn-ii-v-i');
            const btnReset = document.getElementById('btn-reset-prog');
            if (dirBtn && dirSel) dirBtn.addEventListener('click', ()=> applyDirection(dirSel.value));
            if (btnCad) btnCad.addEventListener('click', ()=>{ 
                const before = VL_STATE.progression.slice();
                const after = ensureCadence(before.slice());
                // append meta for any new items
                while ((VL_STATE.progMeta||[]).length < after.length) (VL_STATE.progMeta||[]).push({degree:null,source:'cadence'});
                VL_STATE.progression = after; 
                generateNumbersProgression(); 
            });
            if (btnIIVI) btnIIVI.addEventListener('click', ()=>{ 
                const after = appendIIVI(VL_STATE.progression.slice());
                while ((VL_STATE.progMeta||[]).length < after.length) (VL_STATE.progMeta||[]).push({degree:null,source:'append'});
                VL_STATE.progression = after; 
                generateNumbersProgression(); 
            });
            if (btnReset) btnReset.addEventListener('click', ()=>{ 
                VL_STATE.progression = buildProgressionFromNumbers(); 
                VL_STATE.progMeta = buildProgressionMetaFromNumbers(); 
                generateNumbersProgression(); 
            });

            // Presets
            const pTonic = document.getElementById('preset-tonic');
            const pDec   = document.getElementById('preset-deceptive');
            const pModal = document.getElementById('preset-modal');
            function applyPreset(name){
                let prog = VL_STATE.progression.slice();
                if (name==='tonic'){
                    prog = ensureCadence(prog);
                } else if (name==='deceptive'){
                    const I  = `${AppState.currentKey}maj7`;
                    const vi = `${MusicTheory.getNoteFromInterval(AppState.currentKey, 9)}m7`;
                    if (prog.length){
                        if (prog[prog.length-1]===I) prog[prog.length-1]=vi; else prog.push(vi);
                    }
                } else if (name==='modal'){
                    const bVII = `${MusicTheory.getNoteFromInterval(AppState.currentKey,10)}maj7`;
                    if (!prog.includes(bVII)) prog.splice(Math.max(0, prog.length-1),0,bVII);
                }
                VL_STATE.progression = prog; generateNumbersProgression();
            }
            if (pTonic) pTonic.addEventListener('click', ()=> applyPreset('tonic'));
            if (pDec)   pDec.addEventListener('click',   ()=> applyPreset('deceptive'));
            if (pModal) pModal.addEventListener('click', ()=> applyPreset('modal'));

            // Direction wheel
            const wheel = document.getElementById('direction-wheel');
            if (wheel){
                const ctx = wheel.getContext('2d');
                const cx = wheel.width/2, cy = wheel.height/2, r = Math.min(cx,cy)-6;
                const sectors = [
                    {mode:'to_tonic',   color:'#d1fae5', start:-Math.PI/4, end: Math.PI/4, label:'‚Üí I'},
                    {mode:'circle_cw',  color:'#e0e7ff', start: Math.PI/4,  end: 3*Math.PI/4, label:'‚Üª'},
                    {mode:'away_tonic', color:'#fee2e2', start: 3*Math.PI/4,end: 5*Math.PI/4, label:'‚Üó away'},
                    {mode:'circle_ccw', color:'#e0f2fe', start: 5*Math.PI/4,end: 7*Math.PI/4, label:'‚Ü∫'}
                ];
                function draw(){
                    ctx.clearRect(0,0,wheel.width,wheel.height);
                    // ring
                    sectors.forEach(s=>{
                        ctx.beginPath();
                        ctx.moveTo(cx,cy);
                        ctx.arc(cx,cy,r,s.start,s.end);
                        ctx.closePath();
                        ctx.fillStyle = s.color;
                        ctx.fill();
                        ctx.strokeStyle = '#cbd5e1';
                        ctx.stroke();
                    });
                    // neutral center
                    ctx.beginPath(); ctx.arc(cx,cy, r*0.28, 0, Math.PI*2);
                    ctx.fillStyle = '#f1f5f9'; ctx.fill(); ctx.strokeStyle='#cbd5e1'; ctx.stroke();
                    ctx.fillStyle = '#475569'; ctx.font='bold 12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
                    ctx.fillText('Neutral', cx, cy);
                }
                function pickMode(x,y){
                    const dx=x-cx, dy=y-cy; const dist=Math.hypot(dx,dy);
                    if (dist < r*0.28) return 'none';
                    if (dist>r) return null;
                    let ang=Math.atan2(dy,dx); // -pi..pi
                    // normalize to 0..2pi starting at -pi
                    for(const s of sectors){ if (ang>=s.start && ang<s.end) return s.mode; }
                    return null;
                }
                function setModeFromXY(x,y){
                    const mode = pickMode(x,y);
                    if (mode){ if (dirSel) dirSel.value = mode; applyDirection(mode); }
                }
                draw();
                let dragging=false;
                wheel.addEventListener('mousedown', (e)=>{ dragging=true; const rect=wheel.getBoundingClientRect(); setModeFromXY(e.clientX-rect.left, e.clientY-rect.top); });
                window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const rect=wheel.getBoundingClientRect(); setModeFromXY(e.clientX-rect.left, e.clientY-rect.top); });
                window.addEventListener('mouseup', ()=> dragging=false);
                wheel.addEventListener('click', (e)=>{ const rect=wheel.getBoundingClientRect(); setModeFromXY(e.clientX-rect.left, e.clientY-rect.top); });
            }
        }

        // ==================== UI UPDATES ====================
        function updateAllResults() {
            updateCurrentNumbers();
            updateKeyScale();
            updateNotes();
            updateDiatonicChords();
            // Update the new inline expansion system
            updateNumberExpansions();
            // If the progression is still purely derived from numbers (no subs/ideas), keep it in sync
            try {
                const pureNumbers = !VL_STATE.progression || !VL_STATE.progression.length || (VL_STATE.progMeta||[]).every(m=>!m || m.source==='numbers');
                if (pureNumbers) {
                    VL_STATE.progression = buildProgressionFromNumbers();
                    VL_STATE.progMeta = buildProgressionMetaFromNumbers();
                    // Re-render Step 4 panel if it is already shown
                    const step4Content = document.getElementById('step-4-content');
                    if (step4Content && step4Content.parentElement.querySelector('.exploration-results')) {
                        generateNumbersProgression();
                    }
                }
            } catch(e) { /* non-fatal */ }
        }

        // Ensure per-number metadata exists and aligned with current numbers
        function ensureNumbersMeta(){
            if (!Array.isArray(AppState.numbersMeta)) AppState.numbersMeta = [];
            for (let i=0;i<(AppState.currentNumbers||[]).length;i++){
                AppState.numbersMeta[i] = AppState.numbersMeta[i] || { locked:false, cadence:false };
            }
            AppState.numbersMeta = AppState.numbersMeta.slice(0, (AppState.currentNumbers||[]).length);
        }

        // Global state for number selection
        let SELECTED_NUMBERS = new Set();

        function updateCurrentNumbers() {
            ensureNumbersMeta();
            const classify = (n)=>{
                if (typeof n !== 'number') return {cls:'', label:`${n}`};
                let N = 7;
                if (AppState.numberType==='barry8') N=8; else if (AppState.numberType==='extended') N=7; // map visual classes to 7-scale centers
                const d = ((n-1)%N)+1; // 1..N
                let cls = 'num-fem';
                if (d===1 || d===5) cls='num-masc';
                if (d===3 || d===7) cls='num-tend';
                return {cls, label:`${n}`};
            };
            const scaleNotesUCN = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale) || [];
            const chips = (AppState.currentNumbers||[]).map((n,i)=>{
                const {cls,label} = classify(n);
                const tip = cls==='num-masc'? 'Stable point: try I or V harmony' : cls==='num-fem'? 'Predominant: try ii/iv colors' : cls==='num-tend'? 'Tendency: prepare/resolving harmony' : '';
                const meta = AppState.numbersMeta[i]||{locked:false,cadence:false};
                const lock = meta.locked? 'locked' : '';
                const cad  = meta.cadence? 'cadence' : '';
                const selected = SELECTED_NUMBERS.has(i) ? 'selected' : '';
                const note = typeof n==='number' && scaleNotesUCN.length? scaleNotesUCN[( (n-1)%(scaleNotesUCN.length) + scaleNotesUCN.length) % scaleNotesUCN.length] : (''+n);
                return `<span class="number-chip ${cls} ${lock} ${cad} ${selected}" data-idx="${i}" title="${tip}" data-number="${n}">${label} <span class="note-mini">(${note})</span></span>`;
            }).join('');
            const plain = (AppState.currentNumbers||[]).join(', ');
            const nd = document.getElementById('numbers-display');
            if (nd) nd.innerHTML = chips;
            const cn = document.getElementById('current-numbers');
            if (cn) cn.textContent = plain;

            // Add click handlers to number chips
            document.querySelectorAll('.number-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.idx);
                    toggleNumberSelection(idx, this.dataset.number);
                });
            });
        }

        function toggleNumberSelection(index, number) {
            if (SELECTED_NUMBERS.has(index)) {
                SELECTED_NUMBERS.delete(index);
            } else {
                SELECTED_NUMBERS.add(index);
            }

            updateCurrentNumbers();
            updateNumberExpansions();
        }

        // Track which number expansion is currently expanded
        let expandedNumberIndex = null;

        function collapseAllNumberExpansions() {
            document.querySelectorAll('.number-expansion-inline.expanded').forEach(exp => {
                exp.classList.remove('expanded');
            });
            expandedNumberIndex = null;
        }

        function expandNumberExpansion(index) {
            collapseAllNumberExpansions();
            const exp = document.querySelector(`.number-expansion-inline[data-index="${index}"]`);
            if (exp) {
                exp.classList.add('expanded');
                expandedNumberIndex = index;
            }
        }

        function updateNumberExpansions() {
            const container = document.getElementById('number-expansions-list');
            if (!container) return;

            container.innerHTML = '';

            if (SELECTED_NUMBERS.size === 0) {
                container.innerHTML = '<div class="result-value" style="opacity:0.7; font-style:italic;">Click numbers above to see chord options</div>';
                return;
            }

            // Create expansion for each selected number
            Array.from(SELECTED_NUMBERS).forEach(idx => {
                const number = AppState.currentNumbers[idx];
                const expansion = createNumberExpansion(idx, number);
                container.appendChild(expansion);
            });
        }

        function createNumberExpansion(index, number) {
            const scaleNotes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale) || [];
            const note = typeof number === 'number' ? scaleNotes[(number - 1) % scaleNotes.length] : number;

            const expansion = document.createElement('div');
            expansion.className = 'number-expansion-inline';
            expansion.dataset.index = index;

            const numberElement = document.createElement('div');
            numberElement.className = 'number-inline';
            numberElement.textContent = number;
            numberElement.title = `Click to expand ${note} chord options`;

            const content = document.createElement('div');
            content.className = 'expansion-content-inline';

            // Generate chord options for this number
            const chordOptions = generateChordOptionsForNumber(number, note, index);
            // Build diatonic seventh chord tones for this scale degree (1-3-5-7)
            let chordTones = [];
            try {
                const built = MusicTheory.buildScaleChord(AppState.currentKey || 'C', AppState.currentScale || 'major', typeof number==='number'? number: 1, 4) || {notes:[], degrees:[]};
                // Map degrees to 1,3,5,7 labels
                const degLabels = [1,3,5,7];
                chordTones = (built.notes||[]).map((n,i)=>({ note:n, degree: degLabels[i]||i+1 }));
            } catch(_) { chordTones = []; }

            content.innerHTML = `
                <div class="chord-sections-inline">
                    ${chordTones.length ? `
                        <div class="chord-section-inline">
                            <div class="section-title-inline">üéº Chord Tones</div>
                            <div class="chord-grid-small">
                                ${chordTones.map(t => `
                                    <button class="tone-btn-small" data-note="${t.note}" title="Show container chords containing ${t.note}">
                                        ${t.note} <span class="tone-deg">(${t.degree})</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${chordOptions.containerChords.length > 0 ? `
                        <div class="chord-section-inline">
                            <div class="section-title-inline">üîç Container Chords</div>
                            <div class="chord-grid-small">
                                ${chordOptions.containerChords.slice(0, 6).map(chord => `
                                    <div class="chord-option-small" data-chord="${chord.fullName}" data-action="replace" data-index="${index}" data-scale-match="${chord.scaleMatchPercent}">
                                        <div class="chord-name-small">${chord.fullName}</div>
                                        <div class="chord-notes-small">${chord.chordNotes.join(' ‚Ä¢ ')}</div>
                                        <div class="chord-function-small">${chord.scaleMatchPercent}%</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${chordOptions.substitutions.length > 0 ? `
                        <div class="chord-section-inline">
                            <div class="section-title-inline">üîÑ Substitutions</div>
                            <div class="chord-grid-small">
                                ${chordOptions.substitutions.slice(0, 3).map(sub => `
                                    <div class="chord-option-small" data-chord="${sub.fullName}" data-action="replace" data-index="${index}" data-scale-match="100">
                                        <div class="chord-name-small">${sub.fullName}</div>
                                        <div class="chord-notes-small">${sub.chordNotes.join(' ‚Ä¢ ')}</div>
                                        <div class="chord-function-small">${sub.type}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${chordOptions.suggestions.length > 0 ? `
                        <div class="chord-section-inline">
                            <div class="section-title-inline">üí° Suggestions</div>
                            <div class="chord-grid-small">
                                ${chordOptions.suggestions.slice(0, 3).map(suggestion => `
                                    <div class="chord-option-small suggestion-small" data-chord="${suggestion.fullName}" data-action="${suggestion.action}" data-index="${index}" data-target="${suggestion.targetIndex}">
                                        <div class="chord-name-small">${suggestion.fullName}</div>
                                        <div class="chord-notes-small">${suggestion.chordNotes.join(' ‚Ä¢ ')}</div>
                                        <div class="chord-function-small">${suggestion.reason}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Add click handler to number
            numberElement.addEventListener('click', () => {
                if (expandedNumberIndex === index) {
                    // Collapse if already expanded
                    collapseAllNumberExpansions();
                } else {
                    // Expand this one
                    expandNumberExpansion(index);
                }
            });

            // Add click handlers for chord options
            content.querySelectorAll('.chord-option-small').forEach(option => {
                option.addEventListener('click', function(event) {
                    // Prevent event bubbling if clicking on a suggestion
                    if (event.target.classList.contains('suggestion-small') || event.target.closest('.suggestion-small')) {
                        return;
                    }

                    // Execute the chord action
                    const chordName = this.dataset.chord;
                    const action = this.dataset.action;
                    const targetIndex = this.dataset.index;
                    const suggestionTarget = this.dataset.target;

                    // Show chord voicing on piano
                    setActiveChord(chordName);
                    handleChordSuggestion(chordName, action, targetIndex, suggestionTarget);
                });
            });

            // Add click handlers for tone buttons
            content.querySelectorAll('.tone-btn-small').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const n = btn.dataset.note;
                    if (n) refreshContainersFor(n);
                });
            });

            expansion.appendChild(numberElement);
            expansion.appendChild(content);

            return expansion;
        }

        function generateChordOptionsForNumber(number, note, index) {
            // Ensure we have valid key and scale values
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';

            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
            const allChords = MusicTheory.findAllContainerChords([note], scaleNotes);

            // Container chords (chords containing this note)
            // Option C: Show all chords (no cap), sorting is already handled in findAllContainerChords
            const containerChords = allChords;

            // Substitutions (alternative chords for this scale degree)
            const substitutions = generateSubstitutions(number, note, index, currentKey, currentScale);

            // Smart suggestions (what should come before/after/next)
            const suggestions = generateSmartSuggestions(number, note, index, currentKey, currentScale);

            return { containerChords, substitutions, suggestions };
        }

        function generateSubstitutions(number, note, index, currentKey = AppState.currentKey, currentScale = AppState.currentScale) {
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
            const substitutions = [];

            // Get diatonic chord for this number
            const diatonicChord = MusicTheory.getDiatonicChord(number, currentKey, currentScale);
            if (diatonicChord) {
                substitutions.push({
                    fullName: diatonicChord.fullName,
                    chordNotes: MusicTheory.getChordNotes(diatonicChord.root, diatonicChord.chordType),
                    type: 'Diatonic'
                });
            }

            // Add common substitutions
            const commonSubs = [
                { type: '7', suffix: '7' },
                { type: 'm7', suffix: 'm7' },
                { type: 'maj7', suffix: 'maj7' },
                { type: 'sus4', suffix: 'sus4' }
            ];

            commonSubs.forEach(sub => {
                if (diatonicChord && !diatonicChord.fullName.endsWith(sub.suffix)) {
                    substitutions.push({
                        fullName: note + sub.suffix,
                        chordNotes: MusicTheory.getChordNotes(note, sub.type),
                        type: `Alt ${sub.suffix}`
                    });
                }
            });

            return substitutions.slice(0, 4);
        }

        function generateSmartSuggestions(number, note, index, currentKey = AppState.currentKey, currentScale = AppState.currentScale) {
            const suggestions = [];
            const currentNumbers = AppState.currentNumbers || [];
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];

            // Previous number (what led to this)
            if (index > 0) {
                const prevNum = currentNumbers[index - 1];
                const prevNote = typeof prevNum === 'number' ? scaleNotes[(prevNum - 1) % scaleNotes.length] : prevNum;

                // Suggest ii-V if this is V and previous is ii
                if (number === 7 && prevNum === 2) {
                    suggestions.push({
                        fullName: `${prevNote}m7`,
                        chordNotes: MusicTheory.getChordNotes(prevNote, 'm7'),
                        reason: 'ii-V Resolution',
                        action: 'modify',
                        actionDescription: 'Replace previous ii with m7',
                        targetIndex: index - 1
                    });
                }
            }

            // Next number (what this should resolve to)
            if (index < currentNumbers.length - 1) {
                const nextNum = currentNumbers[index + 1];
                const nextNote = typeof nextNum === 'number' ? scaleNotes[(nextNum - 1) % scaleNotes.length] : nextNum;

                // If this is V (7), suggest resolution to I (1)
                if (number === 7) {
                    const tonicNote = scaleNotes[0];
                    suggestions.push({
                        fullName: `${tonicNote}maj7`,
                        chordNotes: MusicTheory.getChordNotes(tonicNote, 'maj7'),
                        reason: 'Dominant Resolution',
                        action: 'insert',
                        actionDescription: `Add ${tonicNote}maj7 after this`,
                        targetIndex: index + 1
                    });
                }
            }

            // Add cadence suggestions
            if (index === currentNumbers.length - 1) {
                const tonicNote = scaleNotes[0];
                suggestions.push({
                    fullName: `${tonicNote}maj7`,
                    chordNotes: MusicTheory.getChordNotes(tonicNote, 'maj7'),
                    reason: 'Perfect Authentic Cadence',
                    action: 'append',
                    actionDescription: `Add ${tonicNote}maj7 for resolution`,
                    targetIndex: index + 1
                });
            }

            return suggestions;
        }

        function handleChordSuggestion(chordName, action, sourceIndex, targetIndex) {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';

            switch (action) {
                case 'replace':
                    // Replace the number at sourceIndex with a new number
                    const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                    const chordRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                    if (chordRoot) {
                        const rootIndex = scaleNotes.indexOf(chordRoot);
                        if (rootIndex !== -1) {
                            const newNumber = rootIndex + 1;
                            AppState.currentNumbers[sourceIndex] = newNumber;
                            updateAllResults();
                        }
                    }
                    break;

                case 'insert':
                    // Insert a new number at targetIndex
                    const insertRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                    if (insertRoot) {
                        const insertScaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                        const insertRootIndex = insertScaleNotes.indexOf(insertRoot);
                        if (insertRootIndex !== -1) {
                            const insertNumber = insertRootIndex + 1;
                            AppState.currentNumbers.splice(targetIndex, 0, insertNumber);
                            updateAllResults();
                        }
                    }
                    break;

                case 'append':
                    // Add to the end
                    const appendRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                    if (appendRoot) {
                        const appendScaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                        const appendRootIndex = appendScaleNotes.indexOf(appendRoot);
                        if (appendRootIndex !== -1) {
                            const appendNumber = appendRootIndex + 1;
                            AppState.currentNumbers.push(appendNumber);
                            updateAllResults();
                        }
                    }
                    break;

                case 'modify':
                    // Modify an existing number
                    if (targetIndex !== undefined) {
                        const modifyRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                        if (modifyRoot) {
                            const modifyScaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                            const modifyRootIndex = modifyScaleNotes.indexOf(modifyRoot);
                            if (modifyRootIndex !== -1) {
                                const modifyNumber = modifyRootIndex + 1;
                                AppState.currentNumbers[targetIndex] = modifyNumber;
                                updateAllResults();
                            }
                        }
                    }
                    break;
            }
        }


        function highlightScaleDegree(degree, note) {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            // Highlight piano notes for this scale degree
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
            const notes = [scaleNotes[(degree - 1) % scaleNotes.length]];
            renderPianoAccurate(notes, { [note]: 'key-ext' });

            // Update chord circle selection
            document.querySelectorAll('.chord-wheel-degree.selected').forEach(el => {
                el.classList.remove('selected');
            });

            const degreeEl = document.querySelector(`[data-degree="${degree}"]`);
            if (degreeEl) {
                degreeEl.classList.add('selected');
            }
        }

        function highlightChordInList(chord) {
            // Remove previous highlights
            document.querySelectorAll('.chord-card.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Find and highlight matching chord card
            const chordCard = document.querySelector(`[data-chord="${chord.fullName}"]`);
            if (chordCard) {
                chordCard.classList.add('selected');
                chordCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function handleChordSuggestion(chordName, action, sourceIndex, targetIndex) {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';

            switch (action) {
                case 'replace':
                    // Replace the number at sourceIndex with a new number
                    const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                    const chordRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                    if (chordRoot) {
                        const rootIndex = scaleNotes.indexOf(chordRoot);
                        if (rootIndex !== -1) {
                            const newNumber = rootIndex + 1;
                            AppState.currentNumbers[sourceIndex] = newNumber;
                            updateAllResults();
                        }
                    }
                    break;

                case 'insert':
                    // Insert a new number at targetIndex
                    const insertRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                    if (insertRoot) {
                        const insertScaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                        const insertRootIndex = insertScaleNotes.indexOf(insertRoot);
                        if (insertRootIndex !== -1) {
                            const insertNumber = insertRootIndex + 1;
                            AppState.currentNumbers.splice(targetIndex, 0, insertNumber);
                            updateAllResults();
                        }
                    }
                    break;

                case 'append':
                    // Add to the end
                    const appendRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                    if (appendRoot) {
                        const appendScaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                        const appendRootIndex = appendScaleNotes.indexOf(appendRoot);
                        if (appendRootIndex !== -1) {
                            const appendNumber = appendRootIndex + 1;
                            AppState.currentNumbers.push(appendNumber);
                            updateAllResults();
                        }
                    }
                    break;

                case 'modify':
                    // Modify an existing number
                    if (targetIndex !== undefined) {
                        const modifyRoot = chordName.match(/^([A-G](?:#|b)?)/)?.[1];
                        if (modifyRoot) {
                            const modifyScaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                            const modifyRootIndex = modifyScaleNotes.indexOf(modifyRoot);
                            if (modifyRootIndex !== -1) {
                                const modifyNumber = modifyRootIndex + 1;
                                AppState.currentNumbers[targetIndex] = modifyNumber;
                                updateAllResults();
                            }
                        }
                    }
                    break;
            }
        }

        function updateChordCircleForSelection(selectedNotes) {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
            const wheel = document.getElementById('chord-wheel');
            if (!wheel) return;

            // Clear existing degrees
            wheel.innerHTML = '<div class="chord-wheel-center" id="wheel-center">I</div>';

            const centerX = 140;
            const centerY = 140;
            const radius = 100;
            const L = scaleNotes.length || 7;

            // Create degrees for each scale position
            for (let d = 0; d < L; d++) {
                const angle = (d / L) * 2 * Math.PI - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const note = scaleNotes[d];
                const isSelectedNote = Array.isArray(selectedNotes) && selectedNotes.includes(note);
                const distanceClass = isSelectedNote ? 'close' : 'distant';

                const degreeEl = document.createElement('div');
                degreeEl.className = `chord-wheel-degree ${distanceClass}`;
                degreeEl.style.left = `${x - 16}px`;
                degreeEl.style.top = `${y - 16}px`;
                degreeEl.textContent = `${d + 1}`; // Show scale degree number
                degreeEl.dataset.note = note;
                degreeEl.dataset.degree = d + 1;
                degreeEl.title = `${note} (Degree ${d + 1})`;
                degreeEl.addEventListener('click', () => {
                    highlightScaleDegree(d + 1, note);
                });

                wheel.appendChild(degreeEl);
            }

            // Update center label
            const centerEl = document.getElementById('wheel-center');
            if (centerEl) {
                centerEl.textContent = currentKey;
                centerEl.title = `${currentKey} ${currentScale}`;
            }
        }

        function highlightScaleDegree(degree, note) {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            // Highlight piano notes for this scale degree
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
            const notes = [scaleNotes[(degree - 1) % scaleNotes.length]];
            renderPianoAccurate(notes, { [note]: 'key-ext' });

            // Update chord circle selection
            document.querySelectorAll('.chord-wheel-degree.selected').forEach(el => {
                el.classList.remove('selected');
            });

            const degreeEl = document.querySelector(`[data-degree="${degree}"]`);
            if (degreeEl) {
                degreeEl.classList.add('selected');
            }
        }

        function highlightChordInList(chord) {
            // Remove previous highlights
            document.querySelectorAll('.chord-card.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Find and highlight matching chord card
            const chordCard = document.querySelector(`[data-chord="${chord.fullName}"]`);
            if (chordCard) {
                chordCard.classList.add('selected');
                chordCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function updateKeyScale() {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            const scaleName = currentScale.replace(/_/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            document.getElementById('key-scale-context').textContent = `${currentKey} ${scaleName}`;
        }

        function updateNotes() {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale);
            const notes = AppState.currentNumbers.map(num => {
                if (typeof num === 'number') {
                    return scaleNotes[(num - 1) % scaleNotes.length];
                }
                return num;
            });
            document.getElementById('notes-result').textContent = notes.join(', ');
        }

        function updateDiatonicChords() {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            const chords = AppState.currentNumbers.map(num => {
                if (typeof num === 'number' && num >= 1) {
                    const chord = MusicTheory.getDiatonicChord(num, currentKey, currentScale);
                    return chord.fullName;
                }
                return 'N/A';
            });
            document.getElementById('chords-result').textContent = chords.join(', ');
        }

        function updatePiano() {
            try {
                const currentKey = AppState.currentKey || 'C';
                const currentScale = AppState.currentScale || 'major';
                const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];
                const active = (AppState.currentNumbers || [])
                    .map(n => typeof n==='number' ? scaleNotes[(n-1 + (scaleNotes.length||1)) % (scaleNotes.length||1)] : n)
                    .filter(x => typeof x === 'string' && NAME_TO_SEMI[x] !== undefined);
                renderPianoAccurate(active, {});
            } catch (e) {
                // Fallback: still render the keyboard even if something went wrong computing notes
                renderPianoAccurate([], {});
            }
        }

        function highlightPianoNotes(notes, roleClass) {
            const rolesMap = {};
            notes.forEach(n => rolesMap[n] = roleClass);
            renderPianoAccurate(notes, rolesMap);
        }

        function updateScaleDegreesOnPiano() {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || [];

            // Clear existing scale highlighting
            document.querySelectorAll('.pw-white.key-scale, .pw-black.key-scale').forEach(key => {
                if (key) key.classList.remove('key-scale');
            });

            // Highlight scale notes on piano
            scaleNotes.forEach((note, index) => {
                const degree = index + 1;
                const keyElement = document.querySelector(`[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.add('key-scale');
                }
            });
        }

        function updateContainerChords() {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            const scaleNotes = MusicTheory.getScaleNotes(currentKey, currentScale) || ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const notes = AppState.currentNumbers.map(num => {
                if (typeof num === 'number') {
                    return scaleNotes[(num - 1) % scaleNotes.length];
                }
                return num;
            });

            const allChords = MusicTheory.findAllContainerChords(notes, scaleNotes) || [];

            let filteredChords = allChords;
            if (AppState.currentFilter === 'scale') {
                filteredChords = allChords.filter(c => c.scaleMatchPercent === 100);
            } else if (AppState.currentFilter === 'triads') {
                filteredChords = allChords.filter(c => c.complexity === 'triad');
            } else if (AppState.currentFilter === 'sevenths') {
                filteredChords = allChords.filter(c => c.complexity === 'seventh');
            } else if (AppState.currentFilter === 'extended') {
                filteredChords = allChords.filter(c => c.complexity === 'extended');
            }

            const container = document.getElementById('container-chords-list');
            if (container) {
                container.innerHTML = '';
                if (filteredChords.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#777;padding:20px;">No container chords found with current filters.</p>';
                    return;
                }

                // Group chords by scale match percentage first, then by function
                const groupedByMatch = {};
                filteredChords.forEach(chord => {
                    const matchKey = chord.scaleMatchPercent;
                    if (!groupedByMatch[matchKey]) {
                        groupedByMatch[matchKey] = {};
                    }
                    const funcKey = chord.functions && chord.functions.length > 0 ? chord.functions[0] : 'Other';
                    if (!groupedByMatch[matchKey][funcKey]) {
                        groupedByMatch[matchKey][funcKey] = [];
                    }
                    groupedByMatch[matchKey][funcKey].push(chord);
                });

                // Sort by match percentage descending
                const sortedMatches = Object.keys(groupedByMatch).sort((a, b) => b - a);

                sortedMatches.forEach(matchPercent => {
                    const matchGroup = groupedByMatch[matchPercent];
                    const matchExpander = document.createElement('div');
                    matchExpander.className = 'match-group-expander';

                    const matchHeader = document.createElement('div');
                    matchHeader.className = 'match-group-header';
                    const grade = matchPercent === '100' ? '‚òÖ‚òÖ‚òÖ Perfect' : matchPercent >= 75 ? '‚òÖ‚òÖ Excellent' : matchPercent >= 50 ? '‚òÖ Good' : 'Fair';
                    const gradeClass = matchPercent === '100' ? 'grade-perfect' : matchPercent >= 75 ? 'grade-excellent' : matchPercent >= 50 ? 'grade-good' : 'grade-fair';
                    matchHeader.innerHTML = `<span class="match-grade ${gradeClass}">${grade} (${matchPercent}%)</span><span class="expander-icon">‚ñº</span>`;
                    matchHeader.addEventListener('click', () => {
                        matchExpander.classList.toggle('expanded');
                    });
                    matchExpander.appendChild(matchHeader);
                    matchExpander.classList.add('expanded');

                    // Sort functions by likelihood
                    const funcOrder = ['Tonic', 'Dominant', 'Predominant', 'Secondary Dominant', 'Tritone Sub', 'Modal Interchange', 'Chromatic/Pivot', 'Other'];
                    const sortedFuncs = funcOrder.filter(f => matchGroup[f]).concat(Object.keys(matchGroup).filter(f => !funcOrder.includes(f)));

                    const matchContent = document.createElement('div');
                    matchContent.className = 'match-group-content';

                    sortedFuncs.forEach(func => {
                        const funcChords = matchGroup[func];
                        const funcSection = document.createElement('div');
                        funcSection.className = 'function-subsection';

                        const funcTitle = document.createElement('div');
                        funcTitle.className = 'function-subsection-title';
                        funcTitle.innerHTML = `${func} (${funcChords.length})`;
                        funcSection.appendChild(funcTitle);

                        const chordGrid = document.createElement('div');
                        chordGrid.className = 'chord-grid-compact';

                        funcChords.forEach(chord => {
                            const chordItem = document.createElement('div');
                            chordItem.className = 'chord-item-compact';
                            chordItem.innerHTML = `
                                <div class="chord-item-name">${chord.fullName}</div>
                                <div class="chord-item-notes">${chord.chordNotes.join(' ‚Ä¢ ')}</div>
                                <div class="chord-item-meta">${chord.complexity}</div>
                            `;

                            chordItem.addEventListener('click', () => {
                                setActiveChord(chord.fullName);
                                document.querySelectorAll('.chord-item-compact.selected').forEach(e => {
                                    if (e) e.classList.remove('selected');
                                });
                                chordItem.classList.add('selected');
                            });

                            chordGrid.appendChild(chordItem);
                        });

                        funcSection.appendChild(chordGrid);
                        matchContent.appendChild(funcSection);
                    });

                    matchExpander.appendChild(matchContent);
                    container.appendChild(matchExpander);
                });
            }
        }

        function skipNumbersStrip() {
            const numbersStrip = document.getElementById('numbers-display');
            if (numbersStrip) {
                numbersStrip.innerHTML = '<p style="text-align:center;color:#777;padding:20px;">Select numbers above to see chords.</p>';
            }
        }

        // ==================== ADVANCED EXPLORATION FUNCTIONS ====================
        
        function generateProgressions() {
            const currentKey = AppState.currentKey || 'C';
            const currentScale = AppState.currentScale || 'major';
            const progressions = {
                classic: [
                    {
                        name: 'Classic ii-V-I',
                        chords: [`${MusicTheory.getNoteFromInterval(currentKey, 2)}m7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 7)}7`,
                                 `${currentKey}maj7`],
                        description: 'The most fundamental jazz progression'
                    },
                    {
                        name: 'I-vi-ii-V (Circle)',
                        chords: [`${currentKey}maj7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 9)}m7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 2)}m7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 7)}7`],
                        description: 'Classic doo-wop progression'
                    }
                ],
                jazz: [
                    {
                        name: 'Tritone Substitution',
                        chords: [`${MusicTheory.getNoteFromInterval(currentKey, 2)}m7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 1)}7`,
                                 `${currentKey}maj7`],
                        description: 'V7 replaced with bII7 (tritone sub)'
                    }
                ],
                modal: [
                    {
                        name: 'Dorian Vamp',
                        chords: [`${MusicTheory.getNoteFromInterval(currentKey, 2)}m7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 5)}7`],
                        description: 'Classic modal jazz vamp (So What)'
                    }
                ],
                chromatic: [
                    {
                        name: 'Chromatic Descent',
                        chords: [`${currentKey}maj7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 11)}7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 10)}7`,
                                 `${MusicTheory.getNoteFromInterval(currentKey, 9)}m7`],
                        description: 'Chromatically descending line'
                    }
                ]
            };
            
            const resultsArea = document.createElement('div');
            resultsArea.className = 'exploration-results';
            resultsArea.innerHTML = `
                <div class="result-label"> Generated Chord Progressions</div>
                <div class="progression-controls">
                    <button class="filter-toggle active" data-style="classic">Classic ii-V-I</button>
                    <button class="filter-toggle" data-style="jazz">Jazz Substitutions</button>
                    <button class="filter-toggle" data-style="modal">Modal</button>
                    <button class="filter-toggle" data-style="chromatic">Chromatic</button>
                </div>
                <div id="progressions-output"></div>
            `;
            
            const step4Content = document.getElementById('step-4-content');
            let existingResults = step4Content.parentElement.querySelector('.exploration-results');
            if (existingResults) {
                existingResults.remove();
            }
            step4Content.parentElement.appendChild(resultsArea);
            
            displayProgressions(progressions.classic);
            
            document.querySelectorAll('.progression-controls .filter-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.progression-controls .filter-toggle').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const style = this.dataset.style;
                    displayProgressions(progressions[style]);
                });
            });
        }

        function displayProgressions(progressions) {
            const output = document.getElementById('progressions-output');
            output.innerHTML = '';
            
            progressions.forEach(prog => {
                const progCard = document.createElement('div');
                progCard.className = 'progression-card';
                
                const chordParts = prog.chords;
                const chordsHTML = chordParts.map(ch => `<span class="prog-ch" data-ch="${ch}" style="cursor:pointer">${ch}</span>`).join(' ‚Üí ');
                
                progCard.innerHTML = `
                    <div class="progression-name">${prog.name}</div>
                    <div class="progression-chords">${chordsHTML}</div>
                    <div class="progression-description">${prog.description}</div>
                `;
                
                progCard.querySelectorAll('.prog-ch').forEach((span, idx)=>{
                    span.onclick = ()=>{
                        VL_STATE.progression = chordParts;
                        VL_STATE.index = idx;
                        setActiveChord(chordParts[idx]);
                    };
                });
                
                output.appendChild(progCard);
            });
        }

        // Build a progression from current numbers (diatonic to current key/scale)
        function buildProgressionFromNumbers(){
            const chords = [];
            AppState.currentNumbers.forEach(n=>{
                if (typeof n === 'number' && n>=1){
                    const d = MusicTheory.getDiatonicChord(n, AppState.currentKey, AppState.currentScale);
                    chords.push(d.fullName);
                }
            });
            return chords;
        }

        function buildProgressionMetaFromNumbers(){
            const meta = [];
            AppState.currentNumbers.forEach(n=>{
                if (typeof n === 'number' && n>=1){
                    meta.push({ degree: n, source: 'numbers' });
                }
            });
            return meta;
        }

        function nextOf(index, arr){ return arr[(index+1) % arr.length]; }

        // ===== Suggestion helpers (cadences, modulations) =====
        function degreeChordName(key, deg){
            // Simple major-mode defaults for naming common functional moves
            if (deg===1) return `${key}maj7`;
            if (deg===2) return `${MusicTheory.getNoteFromInterval(key, 2)}m7`;
            if (deg===5) return `${MusicTheory.getNoteFromInterval(key, 7)}7`;
            if (deg===6) return `${MusicTheory.getNoteFromInterval(key, 9)}m7`;
            return `${MusicTheory.getNoteFromInterval(key, deg)}7`;
        }
        function buildCadenceIdeas(key){
            const ideas = [];
            // V ‚Üí I
            ideas.push({ label:'V ‚Üí I (Cadence)', seq:[ degreeChordName(key,5), degreeChordName(key,1) ]});
            // ii ‚Äì V ‚Äì I
            ideas.push({ label:'ii ‚Äì V ‚Äì I (Resolution)', seq:[ degreeChordName(key,2), degreeChordName(key,5), degreeChordName(key,1) ]});
            // Deceptive: V ‚Üí vi
            ideas.push({ label:'Deceptive V ‚Üí vi', seq:[ degreeChordName(key,5), degreeChordName(key,6) ]});
            return ideas;
        }
        function transposeKeyBySemis(key, semis){
            const k = (nameToSemi(key) + ((semis%12)+12)%12) % 12;
            return SEMI_TO_NAME[k];
        }
        function buildChromaticMediantRoutes(key){
            // ¬± a major third in semitones: +4, -4; present as ii‚ÄìV‚ÄìI in the new key, with a return V/V ‚Üí V ‚Üí I to original
            const shifts = [4, -4];
            const ideas = [];
            shifts.forEach(s=>{
                const tk = transposeKeyBySemis(key, s);
                const toNew = [ `${MusicTheory.getNoteFromInterval(tk,2)}m7`, `${MusicTheory.getNoteFromInterval(tk,7)}7`, `${tk}maj7` ];
                const back = [ `${MusicTheory.getNoteFromInterval(key,3)}7`, `${MusicTheory.getNoteFromInterval(key,7)}7`, `${key}maj7` ]; // V/V ‚Üí V ‚Üí I (approx)
                ideas.push({ label:`Chromatic mediant to ${tk}: ii‚ÄìV‚ÄìI`, seq: toNew });
                ideas.push({ label:`Return to ${key}: V/V ‚Üí V ‚Üí I`, seq: back });
            });
            return ideas;
        }
        function trySequence(seq, delay=650){
            let i=0;
            const step=()=>{ if(i>=seq.length) return; setActiveChord(seq[i++]); setTimeout(step, delay); };
            step();
        }
        function insertAfterStep(idx, seq){
            const before = VL_STATE.progression.slice(0, idx+1);
            const after  = VL_STATE.progression.slice(idx+1);
            VL_STATE.progression = before.concat(seq).concat(after);
            // Insert corresponding meta placeholders
            const mBefore = (VL_STATE.progMeta||[]).slice(0, idx+1);
            const mAfter  = (VL_STATE.progMeta||[]).slice(idx+1);
            const mSeq    = seq.map(()=> ({ degree: null, source: 'idea' }));
            VL_STATE.progMeta = mBefore.concat(mSeq).concat(mAfter);
            generateNumbersProgression();
        }

        // ===== Additional idea builders (Backdoor, Borrowed iv/ivm6, LT diminished) =====
        function buildBackdoorIdeas(key){
            const bVII = MusicTheory.getNoteFromInterval(key, 10);
            const iv   = MusicTheory.getNoteFromInterval(key, 5);
            return [
                { label:'Backdoor bVII ‚Üí I', seq:[ `${bVII}7`, `${key}maj7` ] },
                { label:'Plagal IV ‚Üí I', seq:[ `${iv}maj7`, `${key}maj7` ] },
                { label:'Minor plagal iv ‚Üí I', seq:[ `${iv}m7`, `${key}maj7` ] }
            ];
        }
        function buildBorrowedIv6Ideas(key){
            const iv = MusicTheory.getNoteFromInterval(key, 5);
            return [ { label:'ivm6 ‚Üí I', seq:[ `${iv}m6`, `${key}maj7` ] } ];
        }
        function buildSecondaryLTDimIdeas(key){
            // Simple vii¬∞/V and vii¬∞/ii approaches
            const V   = MusicTheory.getNoteFromInterval(key, 7);
            const ii  = MusicTheory.getNoteFromInterval(key, 2);
            const viiOfV = MusicTheory.getNoteFromInterval(V, 11); // half step below V
            const viiOfii = MusicTheory.getNoteFromInterval(ii, 11); // half step below ii
            return [
                { label:'vii¬∞/V ‚Üí V ‚Üí I', seq:[ `${viiOfV}dim7`, `${V}7`, `${key}maj7` ] },
                { label:'vii¬∞/ii ‚Üí ii ‚Üí V ‚Üí I', seq:[ `${viiOfii}dim7`, `${ii}m7`, `${V}7`, `${key}maj7` ] }
            ];
        }

        function functionalSubsFor(chordName, key){
            const m = chordName.match(/^([A-G](?:#|b)?)(.*)$/);
            if(!m) return [];
            const r = m[1], type = m[2]||'';
            const out = [];
            // Secondary dominant to next chord root if available
            if (VL_STATE.progression && VL_STATE.progression.length){
                const next = nextOf(VL_STATE.index>=0?VL_STATE.index:0, VL_STATE.progression);
                const m2 = next.match(/^([A-G](?:#|b)?)/);
                if (m2){ out.push({name:`${MusicTheory.getNoteFromInterval(m2[1], 7)}7`, reason:`Secondary dominant to ${next}`}); }
            }
            // Tritone substitution if dominant quality
            if (/7(?![^/])/.test(type) || type==='' ){ // simple heuristic
                const rootVal = MusicTheory.noteValues[r];
                const subRoot = MusicTheory.chromaticNotes[(rootVal+6)%12];
                out.push({name:`${subRoot}7`, reason:'Tritone substitution'});
            }
            // Modal interchange (parallel minor borrow): bVII, bVI, bIII
            const bVII = MusicTheory.getNoteFromInterval(key, 10);
            const bVI  = MusicTheory.getNoteFromInterval(key, 8);
            const bIII = MusicTheory.getNoteFromInterval(key, 3);
            out.push({name:`${bVII}maj7`, reason:'Modal interchange (bVII from parallel minor)'});
            out.push({name:`${bVI}maj7`, reason:'Modal interchange (bVI from parallel minor)'});
            out.push({name:`${bIII}maj7`, reason:'Modal interchange (bIII from parallel minor)'});
            return out;
        }

        function containerSubsFor(notes){
            const scaleNotes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale);
            const res = MusicTheory.findAllContainerChords(notes, scaleNotes);
            return res.map(c=>({name:c.fullName, detail:`${c.scaleMatchPercent}% in scale`}));
        }

        function getRelativeKey(key){
            // Simple relative major/minor map by semitone: relative minor is -3 semis from major
            return MusicTheory.getNoteFromInterval(key, 9); // major -> relative minor; for minor caller can swap as desired
        }
        function circleFifths(key, steps){
            const dir = steps>=0? 7 : 5; // +7 semis for sharp side, -5 for flat side equivalently
            const n = Math.abs(steps);
            let out = key;
            for(let i=0;i<n;i++) out = MusicTheory.getNoteFromInterval(out, steps>0? 7:5);
            return out;
        }
        function relatedScaleSubsFor(notes){
            const includeRelated = document.getElementById('toggle-related-keys')?.checked !== false;
            if (!includeRelated) return [];
            const modeCandidates = ['major','dorian','mixolydian','aeolian','lydian','phrygian','harmonic','melodic'];
            const keys = new Set();
            keys.add(AppState.currentKey);
            keys.add(getRelativeKey(AppState.currentKey));
            keys.add(circleFifths(AppState.currentKey, +1));
            keys.add(circleFifths(AppState.currentKey, -1));
            const out = [];
            keys.forEach(k=>{
                modeCandidates.forEach(sc=>{
                    if (k===AppState.currentKey && sc===AppState.currentScale) return;
                    const scaleNotes = MusicTheory.getScaleNotes(k, sc);
                    const res = MusicTheory.findAllContainerChords(notes, scaleNotes);
                    res.forEach(c=> out.push({name:c.fullName, detail:`${k} ${sc} ‚Ä¢ ${c.scaleMatchPercent}%`}));
                });
            });
            return out.slice(0,12);
        }

        function generateNumbersProgression(){
            const baseProg = buildProgressionFromNumbers();
            const baseMeta = buildProgressionMetaFromNumbers();
            if (!VL_STATE.progression || VL_STATE.progression.length===0){
                VL_STATE.progression = baseProg.slice();
                VL_STATE.progMeta = baseMeta.slice();
            }
            // Ensure meta exists and matches length
            if (!Array.isArray(VL_STATE.progMeta)) VL_STATE.progMeta = [];
            if (VL_STATE.progMeta.length !== VL_STATE.progression.length){
                const m = [];
                for(let i=0;i<VL_STATE.progression.length;i++){
                    m[i] = VL_STATE.progMeta[i] || baseMeta[i] || { degree:null, source:'unknown' };
                }
                VL_STATE.progMeta = m;
            }
            const source = VL_STATE.progression.slice();
            VL_STATE.index = 0;

            const resultsArea = document.createElement('div');
            resultsArea.className = 'exploration-results';
            resultsArea.innerHTML = `
                <div class="result-label">üß≠ Progression from Numbers</div>
                <div class="voicing-controls" style="margin-bottom:10px;">
                    <label style="margin-right:12px;">
                        <input type="checkbox" id="toggle-related-keys" checked /> Include related keys/modes
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;min-width:260px;">
                        Guidance
                        <input type="range" id="guidance-slider" min="0" max="100" value="50" />
                        <span id="guidance-label">Mid</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;min-width:240px;">
                        Direction
                        <select id="direction-select">
                            <option value="none">Neutral</option>
                            <option value="to_tonic">To tonic</option>
                            <option value="away_tonic">Away from tonic</option>
                            <option value="circle_cw">Circle 5ths ‚Üª</option>
                            <option value="circle_ccw">Circle 5ths ‚Ü∫</option>
                        </select>
                        <button class="filter-toggle" id="apply-direction">Apply</button>
                    </label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="filter-toggle" id="btn-add-cadence">Ensure cadence (V‚ÜíI)</button>
                        <button class="filter-toggle" id="btn-ii-v-i">Append ii‚ÄìV‚ÄìI</button>
                        <button class="filter-toggle" id="btn-reset-prog">Reset to numbers</button>
                        <button class="filter-toggle" id="preset-tonic">Preset: Tonic‚Äëcentered</button>
                        <button class="filter-toggle" id="preset-deceptive">Preset: Deceptive</button>
                        <button class="filter-toggle" id="preset-modal">Preset: Modal flavor</button>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin:8px 0;">
                    <canvas id="direction-wheel" width="180" height="180" style="border-radius:50%; background:#f8fafc; box-shadow: inset 0 0 8px rgba(0,0,0,0.06);"></canvas>
                    <div class="numbers-legend">
                        <div><span class="num-chip num-masc">1/5</span> stable; <span class="num-chip num-fem">2/4/6</span> predominant; <span class="num-chip num-tend">3/7</span> tendency</div>
                        <div>Click a sector on the wheel to set direction and apply.</div>
                    </div>
                </div>
                <div id="nums-prog-output"></div>
            `;
            const step4Content = document.getElementById('step-4-content');
            let existingResults = step4Content.parentElement.querySelector('.exploration-results');
            if (existingResults) existingResults.remove();
            step4Content.parentElement.appendChild(resultsArea);

            const out = document.getElementById('nums-prog-output');
            out.innerHTML = '';
            source.forEach((ch, idx)=>{
                const card = document.createElement('div');
                card.className = 'progression-card';
                card.innerHTML = `
                    <div class="progression-name">Step ${idx+1}: <span class="prog-ch" style="cursor:pointer">${ch}</span></div>
                    <div class="progression-description">From degree ${VL_STATE.progMeta[idx]?.degree ?? '‚Äî'} ‚Ä¢ Source: ${VL_STATE.progMeta[idx]?.source || '‚Äî'}</div>
                    <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="filter-toggle subs-toggle">Show Substitutions</button>
                        <button class="filter-toggle ideas-toggle">Ideas</button>
                        <button class="filter-toggle voice-toggle">Voice</button>
                        <button class="filter-toggle apply-toggle">Make Current</button>
                        <button class="filter-toggle move-up">‚Üë Move Up</button>
                        <button class="filter-toggle move-down">‚Üì Move Down</button>
                    </div>
                    <div class="subs-area" style="display:none; padding-top:8px;">
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:6px;">
                            <label style="display:flex;align-items:center;gap:6px;">
                                <input type="checkbox" class="subs-cont-inScale" checked /> In-scale only
                            </label>
                            <label>Complexity
                                <select class="subs-cont-complexity" style="margin-left:6px;">
                                    <option value="any">All</option>
                                    <option value="triad">Triads</option>
                                    <option value="seventh">Sevenths</option>
                                    <option value="extended">Extended</option>
                                </select>
                            </label>
                            <label>Show Top
                                <select class="subs-cont-limit" style="margin-left:6px;">
                                    <option>12</option>
                                    <option selected>24</option>
                                    <option>48</option>
                                </select>
                            </label>
                        </div>
                        <div><strong>Container (matches chord tones)</strong><div class="subs-container"></div></div>
                        <div style="margin-top:8px;"><strong>Functional</strong><div class="subs-functional"></div></div>
                        <div style="margin-top:8px;"><strong>Related Scales/Keys</strong><div class="subs-related"></div></div>
                    </div>
                    <div class="ideas-area" style="display:none; padding-top:8px;">
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                            <strong>Ideas</strong>
                            <label style="display:flex;align-items:center;gap:6px;">
                                Spice
                                <input type="range" class="ideas-spice" min="0" max="100" value="40" />
                                <span class="ideas-spice-label">Mild</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;">
                                <input type="checkbox" class="ideas-include-current" checked /> Include this chord in idea
                            </label>
                        </div>
                        <div><strong>Cadences</strong><div class="ideas-cad"></div></div>
                        <div style="margin-top:8px;"><strong>Backdoor/Borrowed</strong><div class="ideas-back"></div></div>
                        <div style="margin-top:8px;"><strong>Leading‚Äëtone Diminished</strong><div class="ideas-lt"></div></div>
                        <div style="margin-top:8px;"><strong>Key Journeys (Chromatic mediants)</strong><div class="ideas-mod"></div></div>
                    </div>
                `;
                const chordNotes = MusicTheory.getChordNotes(ch.replace(/[^A-G#b].*$/,''), ch.replace(/^([A-G](?:#|b)?)/,''));
                const subsBtn = card.querySelector('.subs-toggle');
                const ideasBtn = card.querySelector('.ideas-toggle');
                const voiceBtn = card.querySelector('.voice-toggle');
                const applyBtn = card.querySelector('.apply-toggle');
                const subsArea = card.querySelector('.subs-area');
                const ideasArea = card.querySelector('.ideas-area');

                const renderSubs = ()=>{
                    const contDiv = card.querySelector('.subs-container');
                    const funcDiv = card.querySelector('.subs-functional');
                    const relDiv  = card.querySelector('.subs-related');

                    // Parse current step chord and scale
                    const m = ch.match(/^([A-G](?:#|b)?)(.*)$/);
                    const root = m ? m[1] : AppState.currentKey;
                    const type = m ? (m[2]||'maj') : 'maj';
                    const chordNotes = MusicTheory.getChordNotes(root, type) || [];
                    const scaleNotes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale);

                    // Filters
                    const inScaleOnly = card.querySelector('.subs-cont-inScale')?.checked;
                    const wantComplex = card.querySelector('.subs-cont-complexity')?.value || 'any';
                    const limit = parseInt(card.querySelector('.subs-cont-limit')?.value||'24',10);

                    // Containers
                    let containers = MusicTheory.findAllContainerChords(chordNotes, scaleNotes);
                    if (inScaleOnly){ containers = containers.filter(c => c.scaleMatchPercent===100); }
                    if (wantComplex!=='any') containers = containers.filter(c => c.complexity===wantComplex);
                    containers = containers.filter(c=> c.fullName !== ch);
                    // Show all containers (ignore limit for full exploration)
                    const shown = containers;
                    const toBtn = (c)=> `<button class="filter-toggle sub-btn" data-ch="${c.fullName}" title="${c.chordNotes.join(' ‚Ä¢ ')} (${c.scaleMatchPercent}% in scale)">${c.fullName}</button>`;
                    contDiv.innerHTML = shown.length? shown.map(toBtn).join('') : '<div style="color:#6b7280">No matches with current filters</div>';

                    // Functional (objects with .name)
                    const funcList = functionalSubsFor(ch, AppState.currentKey) || [];
                    funcDiv.innerHTML = funcList.map(s=>`<button class="filter-toggle sub-btn" data-ch="${s.name}" title="${s.reason||''}">${s.name}</button>`).join('');

                    // Related (objects with .name; detail in title)
                    const relList = relatedScaleSubsFor(chordNotes) || [];
                    relDiv.innerHTML  = relList.map(s=>`<button class="filter-toggle sub-btn" data-ch="${s.name}" title="${s.detail||''}">${s.name}</button>`).join('');

                    // Bind swaps
                    card.querySelectorAll('.sub-btn').forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            VL_STATE.progression[idx] = btn.dataset.ch;
                            if (VL_STATE.progMeta && VL_STATE.progMeta[idx]) VL_STATE.progMeta[idx].source = 'sub';
                            setActiveChord(btn.dataset.ch);
                            const label = card.querySelector('.prog-ch');
                            if (label) label.textContent = btn.dataset.ch;
                        });
                    });
                };

                subsArea.addEventListener('change', (e)=>{
                    if (e.target && (e.target.classList.contains('subs-cont-inScale') || e.target.classList.contains('subs-cont-complexity') || e.target.classList.contains('subs-cont-limit'))){
                        renderSubs();
                    }
                });

                subsBtn.onclick = ()=>{
                    if (subsArea.dataset.loaded!=='1'){
                        renderSubs();
                        subsArea.dataset.loaded='1';
                        const relToggle = document.getElementById('toggle-related-keys');
                        const slider = document.getElementById('guidance-slider');
                        const glabel = document.getElementById('guidance-label');
                        const labelFor = (v)=> v<33? 'Analytical' : v>66? 'Explorative' : 'Mid';
                        if (relToggle){ relToggle.addEventListener('change', renderSubs); }
                        if (slider){ slider.addEventListener('input', ()=>{ glabel.textContent = labelFor(parseInt(slider.value,10)); renderSubs(); }); }
                    } else {
                        renderSubs();
                    }
                    subsArea.style.display = (subsArea.style.display==='none')? 'block' : 'none';
                };

                // Ideas rendering
                const renderIdeas = ()=>{
                    const cadDiv = card.querySelector('.ideas-cad');
                    const modDiv = card.querySelector('.ideas-mod');
                    const includeCurrent = !!card.querySelector('.ideas-include-current')?.checked;
                    const cadences = buildCadenceIdeas(AppState.currentKey);
                    const mods = buildChromaticMediantRoutes(AppState.currentKey);
                    const filterByCurrent = (list)=>{
                        if (!includeCurrent) return list;
                        const inc = (seq)=> seq.some(x=> x===ch || x.replace(/[^A-G#b].*$/,'')===ch.replace(/[^A-G#b].*$/,''));
                        return list.filter(idea=> inc(idea.seq));
                    };
                    const toRow = (idea)=>{
                        const id = Math.random().toString(36).slice(2,7);
                        const seqText = idea.seq.join(' ‚Üí ');
                        return `<div style="margin:6px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <span>${idea.label}: ${seqText}</span>
                            <button class="filter-toggle" data-try="${id}">Try</button>
                            <button class="filter-toggle" data-ins="${id}">Insert after</button>
                        </div>`;
                    };
                    cadDiv.innerHTML = filterByCurrent(cadences).map(toRow).join('');
                    modDiv.innerHTML = filterByCurrent(mods).map(toRow).join('');
                    const bind = (root, list)=>{
                        const rows = root.children;
                        list.forEach((idea, i)=>{
                            const row = rows[i];
                            const tryBtn = row.querySelector('[data-try]');
                            const insBtn = row.querySelector('[data-ins]');
                            tryBtn.addEventListener('click', ()=> trySequence(idea.seq));
                            insBtn.addEventListener('click', ()=> insertAfterStep(idx, idea.seq));
                        });
                    };
                    bind(cadDiv, filterByCurrent(cadences));
                    bind(modDiv, filterByCurrent(mods));
                };

                ideasBtn.onclick = ()=>{
                    if (ideasArea.dataset.loaded!=='1'){
                        renderIdeas();
                        ideasArea.dataset.loaded='1';
                        const spice = card.querySelector('.ideas-spice');
                        const include = card.querySelector('.ideas-include-current');
                        if (spice){ spice.addEventListener('input', renderIdeas); }
                        if (include){ include.addEventListener('change', renderIdeas); }
                    } else {
                        renderIdeas();
                    }
                    ideasArea.style.display = (ideasArea.style.display==='none')? 'block' : 'none';
                };

                voiceBtn.onclick = ()=>{ setActiveChord(ch); };
                applyBtn.onclick = ()=>{ VL_STATE.index = idx; setActiveChord(VL_STATE.progression[idx]); };
                const moveUp = card.querySelector('.move-up');
                const moveDown = card.querySelector('.move-down');
                function swapAt(i, j){
                    if (i<0||j<0||i>=VL_STATE.progression.length||j>=VL_STATE.progression.length) return;
                    [VL_STATE.progression[i], VL_STATE.progression[j]] = [VL_STATE.progression[j], VL_STATE.progression[i]];
                    if (VL_STATE.progMeta){ [VL_STATE.progMeta[i], VL_STATE.progMeta[j]] = [VL_STATE.progMeta[j], VL_STATE.progMeta[i]]; }
                    generateNumbersProgression();
                }
                if (moveUp) moveUp.addEventListener('click', ()=> swapAt(idx, idx-1));
                if (moveDown) moveDown.addEventListener('click', ()=> swapAt(idx, idx+1));
                out.appendChild(card);
            });
        }

        function generateReharmonizations() {
            const reharmonizations = [
                {
                    type: 'Tritone Substitution',
                    original: [`${MusicTheory.getNoteFromInterval(AppState.currentKey, 7)}7`],
                    reharmonized: [`${MusicTheory.getNoteFromInterval(AppState.currentKey, 1)}7`],
                    explanation: 'Replace V7 with bII7 (tritone away)'
                },
                {
                    type: 'Secondary Dominant',
                    original: [`${MusicTheory.getNoteFromInterval(AppState.currentKey, 2)}m7`],
                    reharmonized: [`${MusicTheory.getNoteFromInterval(AppState.currentKey, 9)}7`, `${MusicTheory.getNoteFromInterval(AppState.currentKey, 2)}m7`],
                    explanation: 'Add V7/ii before ii chord'
                },
                {
                    type: 'Modal Interchange',
                    original: [`${AppState.currentKey}maj7`],
                    reharmonized: [`${AppState.currentKey}m7`],
                    explanation: 'Borrow from parallel minor'
                }
            ];
            
            const resultsArea = document.createElement('div');
            resultsArea.className = 'exploration-results';
            resultsArea.innerHTML = `
                <div class="result-label">üé≠ Reharmonization Options</div>
                <div id="reharmonizations-output"></div>
            `;
            
            const step4Content = document.getElementById('step-4-content');
            let existingResults = step4Content.parentElement.querySelector('.exploration-results');
            if (existingResults) {
                existingResults.remove();
            }
            step4Content.parentElement.appendChild(resultsArea);
            
            const output = document.getElementById('reharmonizations-output');
            
            reharmonizations.forEach(reharm => {
                const card = document.createElement('div');
                card.className = 'reharmonization-card';
                card.innerHTML = `
                    <div class="reharm-type">${reharm.type}</div>
                    <div class="reharm-original">Original: ${reharm.original.join(' ')}</div>
                    <div class="reharm-new">Reharmonized: ${reharm.reharmonized.join(' ')}</div>
                    <div class="reharm-explanation">${reharm.explanation}</div>
                `;
                output.appendChild(card);
            });
        }

        function generateVoicings() {
            const firstChord = MusicTheory.getDiatonicChord(AppState.currentNumbers[0], AppState.currentKey, AppState.currentScale);
            const chordName = firstChord.fullName; // e.g., Cmaj7

            // Helpers
            const pcsFromChord = (name) => chordNameToPitchSet(name); // pitch classes array (0-11)
            const invsFromPcs = (pcs) => {
                const arr = [pcs];
                if (pcs.length>1) arr.push([...pcs.slice(1), pcs[0]]);
                if (pcs.length>2) arr.push([...pcs.slice(2), pcs[0], pcs[1]]);
                if (pcs.length>3) arr.push([...pcs.slice(3), pcs[0], pcs[1], pcs[2]]);
                return arr;
            };
            const toMidiStack = (pcs, base=48) => pickRegister(pcs, base);
            const drop = (stack, idx) => {
                if (idx<0 || idx>=stack.length) return stack;
                const out = stack.slice();
                out[idx] = out[idx]-12; // drop selected voice one octave
                // Re-sort to ascending for readability
                return out.slice().sort((a,b)=>a-b);
            };
            const raiseTop = (stack, oct=12) => {
                const out = stack.slice();
                out[out.length-1] += oct;
                return out;
            };
            const uniqMidi = (arr) => {
                const seen = new Set();
                return arr.filter(v=>{ const k = `${v}`; if(seen.has(k)) return false; seen.add(k); return true;});
            };

            const pcs = pcsFromChord(chordName);
            const rootPcs = pcs.slice(); // root-based chord order: 1,3,5,7
            const invs = invsFromPcs(pcs).map((p,i)=>({ pcs:p, name: `${['Root','1st','2nd','3rd'][i]||'Inv'} inversion`, midi: toMidiStack(p, 52) }));

            // Build an order including tensions when available for degree mapping
            const buildRootOrderWithTensions = ()=>{
                const m = chordName.match(/^([A-G](?:#|b)?)(.*)$/);
                const rootName = m ? m[1] : 'C';
                const type = m ? (m[2] || 'maj') : 'maj';
                const rootSemi = nameToSemi(rootName);
                const ints = MusicTheory.chordFormulas[type] || [];
                const has9 = ints.includes(14);
                const has11 = ints.includes(17) || type.includes('#11');
                const has13 = ints.includes(21);
                // Default diatonic (major-ish) for tensions if not in chord type
                const pc2  = (rootSemi + (has9 ? 14 : 2)) % 12;
                const pc4  = (rootSemi + (has11 ? 18 : 5)) % 12; // #11 if type suggests
                const pc6  = (rootSemi + (has13 ? 21 : 9)) % 12;
                // Root order with potential tensions at the end for labeling
                const order = rootPcs.slice(); // [1,3,5,7]
                // Append 2/4/6 pcs to support mapping 9/11/13 and their octave adds
                order.push(pc2, pc4, pc6);
                return order;
            };

            const orderWithTensions = buildRootOrderWithTensions();
            const baseDegrees = [1,3,5,7,2,4,6]; // map indices of orderWithTensions

            const degreesLabelSimple = (midi, rootOrder)=>{
                // Return degrees like 1 3 5, 3 5 1 for inversions (pitch order)
                const idxByPc = rootOrder.reduce((acc,pc,i)=>{ acc[pc]=i; return acc; }, {});
                const asc = midi.slice().sort((a,b)=>a-b);
                return asc.map(m=> [1,3,5,7][idxByPc[(m%12)] ] || '').join(' ');
            };

            const degreesLabelExtended = (midi, rootOrder, baseRef=52)=>{
                // Return degrees with octave offsets, e.g., 1 5 9(2) 10(3) 11(4) 14(7)
                // rootOrder corresponds to [1,3,5,7,2,4,6] via baseDegrees indices
                const idxByPc = rootOrder.reduce((acc,pc,i)=>{ acc[pc]=i; return acc; }, {});
                // Build a base midi reference for each degree pc near baseRef
                const baseStack = pickRegister(rootOrder, baseRef);
                const asc = midi.slice().sort((a,b)=>a-b);
                return asc.map(m=>{
                    const pc = m%12;
                    const idx = idxByPc[pc];
                    if (idx === undefined) return '';
                    const baseDeg = baseDegrees[idx]; // 1/3/5/7/2/4/6
                    const ref = baseStack[idx];
                    const oct = Math.round((m - ref)/12);
                    const num = baseDeg + (oct>0 ? 7*oct : 0);
                    return (oct>0) ? `${num}(${baseDeg})` : `${baseDeg}`;
                }).join(' ');
            };

            // Build voicing variants with degree labels (supports extended toggle)
            const useExtended = !!document.getElementById('toggle-voicing-extended')?.checked;
            const labeler = (mid)=> useExtended ? degreesLabelExtended(mid, orderWithTensions, 52) : degreesLabelSimple(mid, rootPcs);

            const close = invs.map(v=>({ name:`Close ‚Ä¢ ${v.name}`, midi: v.midi, description:'Stacked mostly within an octave', degrees: labeler(v.midi) }));
            const drop2 = invs.map(v=>{ const m = drop(v.midi, v.midi.length>=3? (v.midi.length-2):0); return { name:`Drop-2 ‚Ä¢ ${v.name}`, midi:m, description:'2nd-from-top dropped an octave', degrees: labeler(m) }; });
            const drop3 = invs.map(v=>{ const m = drop(v.midi, v.midi.length>=4? (v.midi.length-3):0); return { name:`Drop-3 ‚Ä¢ ${v.name}`, midi:m, description:'3rd-from-top dropped an octave', degrees: labeler(m) }; });
            const drop24 = invs.map(v=>{ let x = drop(v.midi, v.midi.length>=3? (v.midi.length-2):0); x = drop(x, x.length>=4? (x.length-4):0); return { name:`Drop-2&4 ‚Ä¢ ${v.name}`, midi:x, description:'2nd & 4th from top dropped', degrees: labeler(x) }; });
            const spread = invs.map(v=>{ const m = raiseTop(raiseTop(v.midi,12),12); return { name:`Spread ‚Ä¢ ${v.name}`, midi:m, description:'Wide spacing with raised top', degrees: labeler(m) }; });

            // Shells and guide-tone based
            const isSeventh = pcs.length>=4;
            const thirdPc = pcs.length>1? pcs[1]: null;
            const seventhPc = pcs.length>=4? pcs[3]: null;
            const bassPc = pcs[0];
            const shell37 = thirdPc!=null && seventhPc!=null ? uniqMidi([nameToSemi(midiToName(36 + (bassPc))), ...toMidiStack([thirdPc, seventhPc], 48)]) : null;
            const shellRoot37 = thirdPc!=null && seventhPc!=null ? uniqMidi([36 + (bassPc), ...toMidiStack([thirdPc, seventhPc], 48)]) : null;
            const shells = [];
            if (shell37) shells.push({ name:'Shell 3‚Äì7', midi: shell37, description:'Guide-tones only (3 and 7), with lightweight bass' });
            if (shellRoot37) shells.push({ name:'Shell R‚Äì3‚Äì7', midi: shellRoot37, description:'Bass on root + guide-tones' });

            // Add tensions if present in chord formula (9,11,13)
            const ints = MusicTheory.chordFormulas[firstChord.chordType] || [];
            const tensionPcs = ints.filter(iv=>iv>=14).map(iv=> (pcs[0] + iv) % 12);
            const gtPlusTensions = (function(){
                if (!thirdPc || !seventhPc || tensionPcs.length===0) return [];
                const base = toMidiStack([thirdPc, seventhPc], 50);
                const tens = toMidiStack(tensionPcs.slice(0,2), 62);
                return [{ name:'Guide-tones + tensions', midi: uniqMidi([...base, ...tens]), description:'3‚Äì7 with available upper tensions' }];
            })();

            const voicings = {
                close,
                drop2,
                drop3,
                drop24,
                spread,
                shells: shells.concat(gtPlusTensions)
            };

            const resultsArea = document.createElement('div');
            resultsArea.className = 'exploration-results';
            resultsArea.innerHTML = `
                <div class="result-label">üéπ Chord Voicing Options</div>
                <div class="voicing-controls">
                    <label style="margin-right:12px;">
                        <input type="checkbox" id="toggle-use-selected" ${VL_STATE.currentChordName ? 'checked' : ''} /> Use selected chord
                    </label>
                    <label style="margin-right:12px;">
                        <input type="checkbox" id="toggle-voicing-extended" checked /> Extended degree labels
                    </label>
                    <button class="filter-toggle active" data-voicing="close">Close</button>
                    <button class="filter-toggle" data-voicing="drop2">Drop-2</button>
                    <button class="filter-toggle" data-voicing="drop3">Drop-3</button>
                    <button class="filter-toggle" data-voicing="drop24">Drop-2&4</button>
                    <button class="filter-toggle" data-voicing="spread">Spread</button>
                    <button class="filter-toggle" data-voicing="shells">Shells/Guide-tones</button>
                </div>
                <div id="voicings-output"></div>
            `;

            const step4Content = document.getElementById('step-4-content');
            let existingResults = step4Content.parentElement.querySelector('.exploration-results');
            if (existingResults) existingResults.remove();
            step4Content.parentElement.appendChild(resultsArea);

            displayVoicings(voicings.close);

            const refresh = () => {
                const activeBtn = document.querySelector('.voicing-controls .filter-toggle.active');
                const type = activeBtn ? activeBtn.dataset.voicing : 'close';
                displayVoicings(voicings[type]);
            };

            document.getElementById('toggle-voicing-extended').addEventListener('change', refresh);

            document.querySelectorAll('.voicing-controls .filter-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.voicing-controls .filter-toggle').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    refresh();
                });
            });
        }

        function displayVoicings(voicings) {
            const output = document.getElementById('voicings-output');
            output.innerHTML = '';

            voicings.forEach(voicing => {
                const card = document.createElement('div');
                card.className = 'voicing-card';
                const pretty = (voicing.midi && voicing.midi.length)
                    ? voicing.midi.map(m => `${midiToName(m)}${Math.floor(m/12)-1}`).join(' - ')
                    : (voicing.notes || []).join(' - ');
                card.innerHTML = `
                    <div class="voicing-name">${voicing.name}</div>
                    <div class="voicing-notes">${pretty}</div>
                    <div class="voicing-description">${voicing.description || ''}</div>
                    <div class="voicing-degrees" style="opacity:0.8">${voicing.degrees ? 'Degrees: ' + voicing.degrees : ''}</div>
                    <div>
                        <button class="apply-voicing">Apply</button>
                    </div>
                `;
                const btn = card.querySelector('.apply-voicing');
                btn.addEventListener('click', () => {
                    if (voicing.midi && voicing.midi.length) {
                        VL_STATE.voicing = voicing.midi.slice();
                        const names = VL_STATE.voicing.map(midiToName);
                        renderPianoAccurate(names, {});
                        document.getElementById('voicing-label').textContent = `Voicing: Custom ‚Ä¢ ${names.join('-')}`;
                    }
                });
                output.appendChild(card);
            });
        }

        function runDeepAnalysis() {
            const tensionLevel = Math.min(100, AppState.currentNumbers.length * 15 + Math.floor(Math.random() * 30));
            const voiceLeadingScore = 70 + Math.floor(Math.random() * 30);
            
            const recommendations = [
                { chord: `${AppState.currentKey}maj7`, reason: 'Tonic resolution' },
                { chord: `${MusicTheory.getNoteFromInterval(AppState.currentKey, 7)}7`, reason: 'Dominant preparation' },
                { chord: `${MusicTheory.getNoteFromInterval(AppState.currentKey, 2)}m7`, reason: 'Subdominant approach' }
            ];
            
            const styleTags = ['Jazz', 'Modal', 'Contemporary', 'Bebop'];
            
            const resultsArea = document.createElement('div');
            resultsArea.className = 'exploration-results';
            resultsArea.innerHTML = `
                <div class="result-label">ü§ñ ML-Inspired Deep Analysis</div>
                <div id="deep-analysis-output">
                    <div class="analysis-section">
                        <h3>Harmonic Tension Analysis</h3>
                        <div class="tension-meter">
                            <div class="tension-level" style="width: ${tensionLevel}%"></div>
                        </div>
                        <p>${tensionLevel > 66 ? 'High tension - dissonant and unstable. Demands resolution.' : tensionLevel > 33 ? 'Medium tension - balanced between stability and movement.' : 'Low tension - consonant and stable. Good for resolution points.'}</p>
                    </div>
                    
                    <div class="analysis-section">
                        <h3>Voice Leading Quality</h3>
                        <div class="quality-score">${voiceLeadingScore}/100</div>
                        <p>${voiceLeadingScore > 85 ? 'Excellent voice leading with smooth stepwise motion' : 'Good voice leading with some larger intervals'}</p>
                    </div>
                    
                    <div class="analysis-section">
                        <h3>Recommended Next Chords</h3>
                        <div class="recommendations">
                            ${recommendations.map(rec => `
                                <div class="recommendation-item">
                                    <strong>${rec.chord}</strong> - ${rec.reason}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h3>Style Suggestions</h3>
                        <div class="style-tags">
                            ${styleTags.map(tag => `<span class="style-tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            const step4Content = document.getElementById('step-4-content');
            let existingResults = step4Content.parentElement.querySelector('.exploration-results');
            if (existingResults) {
                existingResults.remove();
            }
            step4Content.parentElement.appendChild(resultsArea);
        }

        function initScaleTools(){
            if (document.getElementById('scale-tools-section')) return;
            const keyCtx = document.getElementById('key-scale-context');
            if(!keyCtx) return;
            const keySection = keyCtx.closest('.result-section');
            if(!keySection) return;
            const sec = document.createElement('div');
            sec.className = 'result-section';
            sec.id = 'scale-tools-section';
            sec.innerHTML = `
                <div class="result-label">üåç Scale Tools</div>
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:6px 0 10px;">
                    <label><input type="checkbox" id="toggle-scale-notes" checked> Show scale notes</label>
                    <label><input type="checkbox" id="toggle-degree-chords" checked> Show degree chords</label>
                    <label>Chord size
                        <select id="degree-chord-size" style="margin-left:6px;">
                            <option value="3">Triads</option>
                            <option value="4" selected>Sevenths</option>
                        </select>
                    </label>
                    <label style="margin-left:10px;"><input type="checkbox" id="toggle-scale-overlay" checked> Overlay scale on piano</label>
                </div>
                <div id="scale-description-output" class="result-value" style="opacity:0.9"></div>
                <div id="scale-notes-output" class="result-value"></div>
                <div id="degree-chords-output" class="result-value" style="display:block;white-space:normal"></div>
            `;
            keySection.parentNode.insertBefore(sec, keySection.nextSibling);

            const hook = () => updateScaleTools();
            document.getElementById('toggle-scale-notes').addEventListener('change', hook);
            document.getElementById('toggle-degree-chords').addEventListener('change', hook);
            document.getElementById('degree-chord-size').addEventListener('change', hook);
            document.getElementById('toggle-scale-overlay').addEventListener('change', hook);
        }

        function updateScaleTools(){
            const sec = document.getElementById('scale-tools-section');
            if(!sec) return;
            // Prefer live dropdown selections for preview; fall back to AppState
            const selKeyEl = document.getElementById('key-select');
            const selScaleEl = document.getElementById('scale-select');
            const key = selKeyEl?.value || (window.AppState && AppState.currentKey) || 'C';
            const scale = selScaleEl?.value || (window.AppState && AppState.currentScale) || 'major';
            const showNotes = document.getElementById('toggle-scale-notes')?.checked;
            const showDeg = document.getElementById('toggle-degree-chords')?.checked;
            const overlay = document.getElementById('toggle-scale-overlay')?.checked;
            const sizeSel = document.getElementById('degree-chord-size');
            let chordSize = sizeSel ? parseInt(sizeSel.value) : 4;

            // description
            const descOut = document.getElementById('scale-description-output');
            const prettyScale = scale.replace(/_/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
            const descMap = {
                major: 'Major (Ionian)',
                dorian: 'Natural minor with raised 6 (Dorian)',
                phrygian: 'Natural minor with flat 2 (Phrygian)',
                lydian: 'Major with sharp 4 (Lydian)',
                mixolydian: 'Major with flat 7 (Mixolydian)',
                aeolian: 'Natural minor (Aeolian)',
                locrian: 'Natural minor with flat 2 and flat 5 (Locrian)',
                melodic: 'Melodic minor (ascending): minor with raised 6 and 7',
                harmonic: 'Harmonic minor: minor with raised 7',
                harmonic_major: 'Harmonic major: major with flat 6',
                double_harmonic_major: 'Double harmonic major: major with flat 2 and flat 6',
                phrygian_dominant: 'Phrygian dominant: mixolydian with flat 2 (harmonic minor mode 5)',
                altered: 'Super-Locrian (altered): melodic minor mode 7',
                whole_tone: 'Whole tone: all whole steps (symmetric 6-note)',
                octatonic_dim: 'Octatonic (diminished): alternating whole and half steps',
                barry_major6dim: 'Barry Harris major 6‚Äìdiminished',
                barry_dom7dim: 'Barry Harris dominant 7‚Äìdiminished',
                barry_minor6dim: 'Barry Harris minor 6‚Äìdiminished',
                major_pentatonic: 'Major pentatonic: major without 4 and 7',
                minor_pentatonic: 'Minor pentatonic: 1 b3 4 5 b7',
                egyptian_pentatonic: 'Egyptian pentatonic (suspended): 1 2 4 5 b7',
                west_african_pentatonic: 'Yo pentatonic (West African)',
                andean_pentatonic: 'Andean pentatonic (major pentatonic)',
                blues_hexatonic: 'Blues hexatonic: minor pentatonic + b5',
                hijaz: 'Hijaz: phrygian dominant flavor (b2, 3, 4, 5, b6, 7)',
                japanese_hirajoshi: 'Japanese Hiraj≈çshi pentatonic',
                japanese_kumoi: 'Japanese Kumoi pentatonic',
                japanese_in_sen: 'Japanese In-sen pentatonic',
                japanese_yo: 'Japanese Yo pentatonic (major pentatonic flavor)',
                raga_bhairav_approx: 'Bhairav (approx. 12-TET): major with flat 2 and flat 6'
            };
            const scaleDesc = descMap[scale] || prettyScale;
            if (descOut) descOut.textContent = `${key} ${prettyScale}: ${scaleDesc}`;

            // notes
            let notes = [];
            try { notes = MusicTheory.getScaleNotes(key, scale) || []; } catch(e){ notes = []; }
            const notesOut = document.getElementById('scale-notes-output');
            if (showNotes && notesOut) {
                notesOut.textContent = notes.join(' ‚Ä¢ ');
                notesOut.style.display = '';
            } else if (notesOut) {
                notesOut.textContent = '';
                notesOut.style.display = 'none';
            }

            // degree chords
            const degOut = document.getElementById('degree-chords-output');
            if (showDeg && degOut) {
                const n = notes.length;
                const rows = [];
                // Clamp chord size to scale length for accuracy on non-heptatonic scales
                chordSize = Math.max(1, Math.min(chordSize, n || 1));
                for(let d=1; d<=n; d++){
                    const built = MusicTheory.buildScaleChord(key, scale, d, chordSize);
                    const name = `${d}`;
                    const degs = (built.degrees && built.degrees.length) ? built.degrees.join(' ') : '';
                    rows.push(`${name}: ${built.notes.join(' ‚Ä¢ ')}  (${degs})`);
                }
                degOut.innerHTML = rows.map(r=>`<div>${r}</div>`).join('');
                degOut.style.display = '';
            } else if (degOut) {
                degOut.innerHTML = '';
                degOut.style.display = 'none';
            }

            // Optional overlay on piano (without overwriting current voicing selection)
            if (overlay){
                const activeNames = VL_STATE.voicing && VL_STATE.voicing.length ? VL_STATE.voicing.map(midiToName) : [];
                const union = Array.from(new Set([...activeNames, ...notes].filter(n=> NAME_TO_SEMI[n] !== undefined)));
                const rolesMap = Object.fromEntries(notes.filter(n=> NAME_TO_SEMI[n] !== undefined).map(n=> [n, 'key-ext']));
                renderPianoAccurate(union, rolesMap);
            }
        }

        // ==================== EVENT HANDLERS ====================
        function scaleLength(){
            try { return MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale).length || 7; } catch(e){ return 7; }
        }
        function updateNumberTypeLabels(){
            const opt = document.querySelector('#number-type option[value="diatonic"]');
            if (opt){ opt.textContent = `Diatonic (1-${scaleLength()})`; }
        }
        function flashStep(stepId){
            const el = document.getElementById(stepId);
            if (!el) return;
            const prev = el.style.boxShadow;
            el.style.boxShadow = '0 0 0 3px rgba(247,37,133,0.5)';
            setTimeout(()=> el.style.boxShadow = prev || '', 800);
            el.scrollIntoView({behavior:'smooth', block:'center'});
        }
        const _btnGenNumbers = document.getElementById('btn-gen-numbers');
        if (_btnGenNumbers) _btnGenNumbers.addEventListener('click', (e) => {
            e?.preventDefault?.(); e?.stopPropagation?.();
            try {
                const type = document.getElementById('number-type').value;
                let len = parseInt(document.getElementById('number-seq-len').value);
                if (!Number.isFinite(len) || len < 1) len = 4;

            // Auto-apply key/scale if needed for diatonic generation
            if (type === 'diatonic' && !AppState.keyScaleSet){
                AppState.currentKey = document.getElementById('key-select').value;
                AppState.currentScale = document.getElementById('scale-select').value;
                AppState.keyScaleSet = true;
                updateScaleTools();
                updateNumberTypeLabels();
            }
            
            const prev = (AppState.currentNumbers||[]).slice();
            const next = [];
            AppState.numberType = type;
            for (let i = 0; i < len; i++) {
                if (type === 'diatonic') {
                    const N = scaleLength();
                    next.push(Math.floor(Math.random() * N) + 1);
                } else if (type === 'barry8') {
                    next.push(Math.floor(Math.random() * 8) + 1);
                } else if (type === 'extended') {
                    next.push(Math.floor(Math.random() * 14) + 1);
                } else {
                    const chromaticOptions = [1,2,3,4,5,6,7,'b2','b3','b5','b6','b7','#4','#5'];
                    next.push(chromaticOptions[Math.floor(Math.random() * chromaticOptions.length)]);
                }
            }
                if (prev.length) UNDO_STACK.push(prev);
                AppState.currentNumbers = next;
                // Reset per-number metadata to avoid stale locks/cadence on new sequence
                AppState.numbersMeta = [];
                pushHistory({ numbers: next.slice(), type, key: AppState.currentKey, scale: AppState.currentScale, ts: Date.now() });

                enableStep(2);
                // Immediately reflect numbers in UI
                updateCurrentNumbers();
                const nd = document.getElementById('numbers-display');
                const cn = document.getElementById('current-numbers');
                if (nd && (!nd.textContent || nd.textContent.trim()==='‚Äî')) nd.textContent = next.join(', ');
                if (cn) cn.textContent = next.join(', ');
                // Then attempt full recompute
                try { updateAllResults(); } catch(inner){ console?.error?.('updateAllResults failed:', inner); }
                updateNumberTypeLabels();
                const panel = document.getElementById('numbers-history');
                if (panel && panel.style.display==='block') renderNumbersHistory();
            } catch(err){
                console?.error?.('Generate numbers error:', err);
                alert('Error generating numbers. Please check console for details.');
            }
        });

        const _btnClearNumbers = document.getElementById('btn-clear-numbers');
        if (_btnClearNumbers) _btnClearNumbers.addEventListener('click', (e) => {
            e?.preventDefault?.(); e?.stopPropagation?.();
            const prev = (AppState.currentNumbers||[]).slice();
            if (prev.length) UNDO_STACK.push(prev);
            AppState.currentNumbers = [];
            document.getElementById('numbers-display').textContent = '‚Äî';
            document.getElementById('current-numbers').textContent = '‚Äî';
            updateAllResults();
        });

        const _btnUndoNumbers = document.getElementById('btn-undo-numbers');
        if (_btnUndoNumbers) _btnUndoNumbers.addEventListener('click', () => {
            const prev = UNDO_STACK.pop();
            if (!prev) return;
            AppState.currentNumbers = prev.slice();
            updateAllResults();
            updateNumberTypeLabels();
        });

        const _btnHistoryNumbers = document.getElementById('btn-history-numbers');
        if (_btnHistoryNumbers) _btnHistoryNumbers.addEventListener('click', () => {
            const panel = document.getElementById('numbers-history');
            if (!panel) return;
            if (panel.style.display === 'none' || panel.style.display === ''){
                renderNumbersHistory();
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        });

        // ==================== NUMBER TRANSFORM HELPERS ====================
        function applyTransform(nextNumbers, label){
            if (!Array.isArray(AppState.currentNumbers) || !AppState.currentNumbers.length) return;
            const prev = AppState.currentNumbers.slice();
            UNDO_STACK.push(prev);
            AppState.currentNumbers = nextNumbers.slice();
            pushHistory({ numbers: AppState.currentNumbers.slice(), type: AppState.numberType, key: AppState.currentKey, scale: AppState.currentScale, transform: label, ts: Date.now() });
            updateAllResults();
            const panel = document.getElementById('numbers-history');
            if (panel && panel.style.display==='block') renderNumbersHistory();
        }

        function invertNumbers(nums){
            // Default axis from type
            let N = null;
            if (AppState.numberType === 'diatonic') N = scaleLength();
            else if (AppState.numberType === 'barry8') N = 8;
            else if (AppState.numberType === 'extended') N = 14;
            return nums.map(v=>{
                if (typeof v !== 'number' || !N) return v; // keep chromatic tokens or non-numeric
                const norm = ((v-1)%N)+1; // 1..N
                return (N+1) - norm;      // inversion around center
            });
        }

        function invertNumbersAxis(nums, axisN){
            const N = axisN || (AppState.numberType==='barry8'?8: AppState.numberType==='extended'?14 : scaleLength());
            return nums.map(v=>{
                if (typeof v !== 'number' || !N) return v;
                const norm = ((v-1)%N)+1;
                return (N+1) - norm;
            });
        }

        function rotateLeft(arr){ if(!arr.length) return arr; const a=arr.slice(); a.push(a.shift()); return a; }
        function rotateRight(arr){ if(!arr.length) return arr; const a=arr.slice(); a.unshift(a.pop()); return a; }

        // Buttons: Retrograde, Invert, Rotate
        const btnRetro = document.getElementById('btn-retrograde');
        const btnInvert = document.getElementById('btn-invert');
        const btnRotL  = document.getElementById('btn-rot-left');
        const btnRotR  = document.getElementById('btn-rot-right');
        const btnRotN  = document.getElementById('btn-rotate-n');
        const rotateNEl = document.getElementById('rotate-n');
        const invertAxisEl = document.getElementById('invert-axis');
        const btnRandom = document.getElementById('btn-randomize');
        if (btnRetro) btnRetro.addEventListener('click', ()=>{
            if (!AppState.currentNumbers.length) return;
            applyTransform(AppState.currentNumbers.slice().reverse(), 'retrograde');
        });
        if (btnInvert) btnInvert.addEventListener('click', ()=>{
            if (!AppState.currentNumbers.length) return;
            // optional axis override
            const ax = invertAxisEl?.value;
            const axisN = ax==='7'?7 : ax==='8'?8 : ax==='14'?14 : null;
            const arr = axisN ? invertNumbersAxis(AppState.currentNumbers, axisN)
                               : invertNumbers(AppState.currentNumbers);
            applyTransform(arr, `invert${axisN?('_axis_'+axisN):''}`);
        });
        if (btnRotL) btnRotL.addEventListener('click', ()=>{
            if (!AppState.currentNumbers.length) return;
            applyTransform(rotateLeft(AppState.currentNumbers), 'rotate_left');
        });
        if (btnRotR) btnRotR.addEventListener('click', ()=>{
            if (!AppState.currentNumbers.length) return;
            applyTransform(rotateRight(AppState.currentNumbers), 'rotate_right');
        });
        if (btnRotN) btnRotN.addEventListener('click', ()=>{
            const n = Math.max(1, Math.min(32, parseInt(rotateNEl?.value||'1',10)));
            if (!AppState.currentNumbers.length) return;
            let arr = AppState.currentNumbers.slice();
            for(let i=0;i<n;i++){ arr = rotateRight(arr); }
            applyTransform(arr, `rotate_${n}`);
        });
        if (btnRandom) btnRandom.addEventListener('click', ()=>{
            const len = AppState.currentNumbers.length;
            if (!len) return;
            // Simple: shuffle while keeping duplicates count
            const arr = AppState.currentNumbers.slice();
            for (let i=len-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
            applyTransform(arr, 'randomize');
        });

        // Numbers chip event delegation: toggle lock/cadence
        const numbersDisplay = document.getElementById('numbers-display');
        if (numbersDisplay){
            numbersDisplay.addEventListener('click', (e)=>{
                const el = e.target;
                const chip = el.closest?.('.num-chip');
                if (!chip) return;
                const idx = parseInt(chip.dataset.idx,10);
                ensureNumbersMeta();
                if (el.classList.contains('lock')){
                    AppState.numbersMeta[idx].locked = !AppState.numbersMeta[idx].locked;
                    updateCurrentNumbers();
                } else if (el.classList.contains('cad')){
                    AppState.numbersMeta[idx].cadence = !AppState.numbersMeta[idx].cadence;
                    updateCurrentNumbers();
                }
            });
        }

        const _btnSetKeyScale = document.getElementById('btn-set-keyscale');
        if (_btnSetKeyScale) _btnSetKeyScale.addEventListener('click', () => {
            AppState.currentKey = document.getElementById('key-select').value;
            AppState.currentScale = document.getElementById('scale-select').value;
            AppState.keyScaleSet = true;
            // Normalize existing numbers to the new scale length
            if (AppState.numberType === 'diatonic'){
                const N = scaleLength();
                AppState.currentNumbers = AppState.currentNumbers.map(n=>{
                    if (typeof n === 'number') return ((n-1)%N)+1;
                    return n; // keep altered tokens
                });
            }
            enableStep(3);
            updateAllResults();
            updateScaleTools();
            updateNumberTypeLabels();
        });

        document.querySelectorAll('.filter-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.parentElement.classList.contains('container-filter-bar')) {
                    document.querySelectorAll('.container-filter-bar .filter-toggle').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    AppState.currentFilter = this.dataset.filter;
                    // Update container chords with current selection
                    updateNumberExpansions();
                }
            });
        });

        document.querySelectorAll('#step-4 .option-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('#step-4 .option-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                AppState.currentExploration = this.dataset.explore;

                // Show exploration section and hide other tools temporarily
                const explorationSection = document.getElementById('exploration-section');
                const interactiveTools = document.getElementById('interactive-tools-section');

                if (AppState.currentExploration) {
                    explorationSection.classList.add('show');
                    interactiveTools.style.opacity = '0.3';
                } else {
                    explorationSection.classList.remove('show');
                    interactiveTools.style.opacity = '1';
                }

                switch(AppState.currentExploration) {
                    case 'progressions':
                        generateProgressions();
                        break;
                    case 'reharmonization':
                        generateReharmonizations();
                        break;
                    case 'voicing':
                        generateVoicings();
                        break;
                    case 'numbers_progression':
                        generateNumbersProgression();
                        break;
                    case 'analysis':
                        runDeepAnalysis();
                        break;
                }
            });
        });

        function enableStep(stepNum) {
            const step = document.getElementById(`step-${stepNum}`);
            if (step) {
                step.classList.remove('disabled');
                step.classList.add('active');
                AppState.completedSteps.push(stepNum);

                for (let i = 1; i < stepNum; i++) {
                    const prevStep = document.getElementById(`step-${i}`);
                    if (prevStep) {
                        prevStep.classList.remove('active');
                        prevStep.classList.add('completed');
                    }
                }
            }
        };

        // Piano toolbar controls
        const prevVoicing = document.getElementById('prev-voicing');
        if (prevVoicing) {
            prevVoicing.onclick = ()=>{
                if(!VL_STATE.progression.length) return;
                VL_STATE.index = Math.max(0, VL_STATE.index-1);
                setActiveChord(VL_STATE.progression[VL_STATE.index]);
            };
        }

        const nextVoicing = document.getElementById('next-voicing');
        if (nextVoicing) {
            nextVoicing.onclick = ()=>{
                if(!VL_STATE.progression.length) return;
                VL_STATE.index = Math.min(VL_STATE.progression.length-1, VL_STATE.index+1);
                setActiveChord(VL_STATE.progression[VL_STATE.index]);
            };
        }

        const lockVoices = document.getElementById('lock-voices');
        if (lockVoices) {
            lockVoices.onclick = (e)=>{
                VL_STATE.locked = !VL_STATE.locked;
                e.currentTarget.textContent = `Lock: ${VL_STATE.locked? 'On':'Off'}`;
            };
        }

        const resetAll = document.getElementById('reset-all');
        if (resetAll) {
            resetAll.addEventListener('click', () => {
                AppState.currentNumbers = [7, 2, 4, 3];
                AppState.currentKey = 'C';
                AppState.currentScale = 'major';
                AppState.currentFilter = 'all';
                AppState.currentExploration = null;
                AppState.completedSteps = [1];

                updateAllResults();
                updateKeyScale();
                updatePiano();
                updateScaleDegreesOnPiano();
            });
        }

        document.getElementById('container-section').style.display = 'none';

        const existingResults = document.querySelector('.exploration-results');
        if (existingResults) {
            existingResults.remove();
        }

        // Hide exploration section and restore interactive tools
        const explorationSection = document.getElementById('exploration-section');
        const interactiveTools = document.getElementById('interactive-tools-section');
        if (explorationSection) explorationSection.classList.remove('show');
        if (interactiveTools) interactiveTools.style.opacity = '1';

        updateAllResults();

        const saveSession = document.getElementById('save-session');
        if (saveSession) {
            saveSession.addEventListener('click', () => {
                const data = JSON.stringify(AppState);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'barry-harris-session.json';
                a.addEventListener('click', () => {
                    a.click();
                    URL.revokeObjectURL(url);
                });
            });
        }

        const loadSession = document.getElementById('load-session');
        if (loadSession) {
            loadSession.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const loadedState = JSON.parse(event.target.result);
                            if (!loadedState) return;
                            Object.assign(AppState, loadedState);
                            updateAllResults();
                            updateKeyScale();
                            updatePiano();
                            updateScaleDegreesOnPiano();
                        } catch (err) {
                            alert('Error loading session: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                });
                input.click();
            });
        }

        // Initialize
        function showErrorOverlay(message){
            try{
                let ov = document.getElementById('app-error');
                if (!ov){ ov = document.createElement('div'); ov.id='app-error'; ov.style.cssText='position:fixed;inset:auto 8px 8px auto;max-width:40vw;background:#111827;color:#fecaca;border:1px solid #dc2626;border-radius:6px;padding:8px 10px;z-index:99999;font:13px system-ui,Segoe UI,Arial'; document.body.appendChild(ov); }
                ov.textContent = `Error: ${message}`;
            }catch(_){ /* ignore */ }
        }
        function safe(fn, label){ try { return fn&&fn(); } catch(e){ console?.error?.(label||'init error', e); showErrorOverlay(`${label||'init'} failed: ${e.message||e}`); } }

        // Verify all functions are available
        console.log('‚úÖ JavaScript loaded successfully');
        console.log('‚úÖ Functions available:', {
            enableStep: typeof enableStep === 'function',
            updateScaleDegreesOnPiano: typeof updateScaleDegreesOnPiano === 'function',
            skipNumbersStrip: typeof skipNumbersStrip === 'function',
            updateAllResults: typeof updateAllResults === 'function'
        });

        function attachCoreHandlers(){
            // Ensure Generate and Apply work even if earlier wiring failed
            safe(() => {
                const gen = document.getElementById('btn-gen-numbers');
                if (gen && !gen.dataset.bound){
                    gen.dataset.bound = '1';
                    gen.addEventListener('click', (e)=>{
                        e?.preventDefault?.(); e?.stopPropagation?.();
                        try{
                            const type = document.getElementById('number-type')?.value || 'diatonic';
                            let len = parseInt(document.getElementById('number-seq-len')?.value||'4', 10);
                            if (!Number.isFinite(len) || len<1) len=4;
                            const nums = [];
                            const N = (typeof scaleLength==='function'? scaleLength(): 7) || 7;
                            for(let i=0;i<len;i++) nums.push(type==='barry8'? (Math.floor(Math.random()*8)+1) : type==='extended'? (Math.floor(Math.random()*14)+1) : (Math.floor(Math.random()*N)+1));
                            window.AppState = window.AppState || {};
                            AppState.currentNumbers = nums;
                            AppState.numberType = type;
                            const nd = document.getElementById('numbers-display');
                            const cn = document.getElementById('current-numbers');
                            if (nd) nd.textContent = nums.join(', ');
                            if (cn) cn.textContent = nums.join(', ');
                            safe(() => updateAllResults(), 'updateAllResults');
                            safe(() => enableStep(2), 'enableStep');
                        } catch(err) {
                            showErrorOverlay(`Generate failed: ${err.message||err}`);
                        }
                    });
                }
            }, 'attachCoreHandlers');
            const apply = document.getElementById('btn-set-keyscale');
            if (apply && !apply.dataset.bound){
                apply.dataset.bound = '1';
                apply.addEventListener('click', ()=>{
                    try{
                        const key = document.getElementById('key-select')?.value || 'C';
                        const scale = document.getElementById('scale-select')?.value || 'major';
                        window.AppState = window.AppState || {};
                        AppState.currentKey = key;
                        AppState.currentScale = scale;
                        AppState.keyScaleSet = true;
                        safe(() => updateScaleTools(), 'updateScaleTools');
                        safe(() => updateAllResults(), 'updateAllResults');
                        safe(() => updateScaleDegreesOnPiano(), 'updateScaleDegreesOnPiano');
                    } catch(err) {
                        showErrorOverlay(`Apply key/scale failed: ${err.message||err}`);
                    }
                });
            }
            const reset = document.getElementById('btn-reset');
            if (reset && !reset.dataset.bound){
                reset.dataset.bound = '1';
                reset.addEventListener('click', ()=>{
                    try{
                        window.AppState = window.AppState || {};
                        AppState.currentNumbers = [7, 2, 4, 3];
                        AppState.currentKey = 'C';
                        AppState.currentScale = 'major';
                                AppState.currentFilter = 'all';
                        AppState.currentExploration = null;
                        AppState.completedSteps = [1];
                        safe(() => updateAllResults(), 'updateAllResults');
                        safe(() => updateKeyScale(), 'updateKeyScale');
                        safe(() => updatePiano(), 'updatePiano');
                        safe(() => updateScaleDegreesOnPiano(), 'updateScaleDegreesOnPiano');
                    } catch(err) {
                        showErrorOverlay(`Reset failed: ${err.message||err}`);
                    }
                });
            }
            // Build UI shell after initial render
            // safe(() => buildUIShell(), 'buildUIShell');  // Disabled: using left-to-right column layout instead

            // Live preview when changing key/scale without needing Apply
            try{
                const ks = document.getElementById('key-select');
                const ss = document.getElementById('scale-select');
                if (ks) ks.addEventListener('change', () => {
                    safe(() => updateScaleTools(), 'updateScaleTools');
                });
                if (ss) ss.addEventListener('change', () => {
                    safe(() => updateScaleTools(), 'updateScaleTools');
                });
            } catch(err) {
                showErrorOverlay(`Live preview setup failed: ${err.message||err}`);
            }
        }

        // Initialize the application
        safe(() => attachCoreHandlers(), 'attachCoreHandlers');
        safe(() => mountRetro3DContainer(), 'mountRetro3DContainer');
        try { document.body.classList.remove('in-3d'); } catch(_){}

        document.addEventListener('DOMContentLoaded', () => {
            safe(() => renderPianoAccurate([], {}), 'renderPianoAccurate');
            safe(() => initScaleTools(), 'initScaleTools');
            safe(() => updateScaleTools(), 'updateScaleTools');
            safe(() => updateAllResults(), 'updateAllResults');
            safe(() => updateNumberTypeLabels(), 'updateNumberTypeLabels');
            safe(() => renderNumbersHistory(), 'renderNumbersHistory');
            safe(() => attachCoreHandlers(), 'attachCoreHandlers');
            // Initial render of the new inline expansion system
            safe(() => updateNumberExpansions(), 'updateNumberExpansions');
        });

        // ============== UI SHELL (Interactive Menu) ==============
        function buildUIShell(){
            // Panels we can manage (only include those that exist)
            const candidates = [
                { id:'step-1', label:'Numbers' },
                { id:'step-2', label:'Key & Scale' },
                { id:'chord-circle-section', label:'Scale Circle' },
                { id:'number-expansions-section', label:'Chord Explorer' },
                { id:'step-3', label:'Exploration' },
                { id:'harmony-orbits', label:'Harmony Orbits' }
            ].filter(p=> document.getElementById(p.id));
            const crucial = new Set(['step-1','step-2']);
            const SHELL_KEY = 'bh_shell_layout_v1';

            // Inject styles
            const css = `
                body.with-shell { padding-left: 260px; transition: padding-left .2s ease; }
                #ui-shell { position: fixed; inset: 0 auto 0 0; width: 240px; background:#0f172a; color:#e2e8f0; border-right:1px solid #1f2937; z-index: 9999; display:flex; flex-direction:column; }
                #ui-shell .shell-header { padding:12px 10px; font-weight:700; border-bottom:1px solid #1f2937; display:flex; align-items:center; justify-content:space-between; }
                #ui-shell .shell-body { padding:8px; overflow:auto; }
                #ui-shell .panel-item { display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:6px; padding:6px 6px; border-radius:6px; }
                #ui-shell .panel-item:hover { background:#111827; }
                #ui-shell .panel-controls { margin-left:auto; display:flex; gap:4px; }
                #ui-shell button, #ui-shell input[type=checkbox] { cursor:pointer; }
                #ui-shell .muted { color:#94a3b8; font-size:12px; }
                #ui-shell .shell-footer { margin-top:auto; padding:8px; border-top:1px solid #1f2937; display:flex; gap:6px; flex-wrap:wrap; }
                #ui-shell .tag { background:#1f2937; color:#cbd5e1; border:none; border-radius:999px; padding:4px 8px; font-size:12px; }
                /* Layout zones */
                #layout-zones { display:grid; grid-template-columns: 1fr 2fr 1fr; grid-template-rows:auto auto 1fr; grid-template-areas: 'tabs tabs tabs' 'left center right' 'bottom bottom bottom'; gap:12px; padding:12px; }
                #tool-tabs { grid-area: tabs; position:sticky; top:0; z-index:5; display:flex; gap:6px; flex-wrap:wrap; padding:6px; background:#0b1020; border:1px solid #1f2937; border-radius:8px; }
                #tool-tabs .tab { background:#1f2937; color:#cbd5e1; border:none; border-radius:6px; padding:6px 10px; }
                #tool-tabs .tab.active { background:#334155; color:#e5e7eb; }
                #spotlight { flex: 1; min-width: 240px; background:#0b1425; color:#e5e7eb; border:1px solid #334155; border-radius:6px; padding:6px 10px; }
                #zone-left{ grid-area:left; }
                #zone-center{ grid-area:center; }
                #zone-right{ grid-area:right; }
                #zone-bottom{ grid-area:bottom; }
                .panel-size-small { font-size: 0.9em; }
                .panel-size-large { font-size: 1.1em; }
                .retro-mode #ui-shell { background: linear-gradient(180deg,#0f172a,#111827); box-shadow: inset 0 1px 0 #1f2937; }
                .retro-mode .flow-step, .retro-mode #container-section { border:1px solid #cbd5e1; border-radius:8px; box-shadow: 0 2px 0 #94a3b8; }
                .retro-mode #ui-shell .tag { background: linear-gradient(180deg,#1f2937,#0b1220); border:1px solid #334155; } 
                /* Tool window wrappers */
                .tool-window { position: relative; background:#0b1324; border:1px solid #1f2937; border-radius:10px; padding:8px; overflow:auto; min-width: 220px; min-height: 120px; }
                .tool-window .resize-handle { position:absolute; width:12px; height:12px; background:#334155; border:1px solid #475569; border-radius:3px; opacity:0.8; }
                .tool-window .resize-handle:hover { background:#64748b; }
                .tool-window .rh-nw { left: -6px; top: -6px; cursor:nwse-resize; }
                .tool-window .rh-ne { right: -6px; top: -6px; cursor:nesw-resize; }
                .tool-window .rh-sw { left: -6px; bottom: -6px; cursor:nesw-resize; }
                .tool-window .rh-se { right: -6px; bottom: -6px; cursor:nwse-resize; }
                /* 3D overlay + hide legacy when active */
                #retro3d { position: fixed; inset: 0; z-index: 1000; display:none; background: radial-gradient(ellipse at center, rgba(8,12,24,0.95), rgba(4,6,12,0.98)); }
                #retro3d .scanlines { pointer-events:none; position:absolute; inset:0; background: repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 2px, transparent 4px); mix-blend-mode: overlay; }
                #retro3d .grain { pointer-events:none; position:absolute; inset:0; background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2272%22 height=%2272%22 viewBox=%220 0 72 72%22><filter id=%22n%22><feTurbulence type=%22fractalNoise%22 baseFrequency=%220.8%22 numOctaves=%222%22 stitchTiles=%22stitch%22/></filter><rect width=%2272%22 height=%2272%22 filter=%22url(%23n)%22 opacity=%220.07%22/></svg>'); }
                #retro3d .hud { position:absolute; top:8px; right:8px; display:flex; gap:8px; }
                #retro3d .hud .tag { background:#1f2937; color:#e5e7eb; border:1px solid #334155; border-radius:6px; padding:6px 10px; }
                body.in-3d #ui-shell, body.in-3d #layout-zones, body.in-3d .container { display:none !important; }
                body.in-3d #retro3d { display:block; }
            `;
            const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);

            const shell = document.createElement('aside');
            shell.id = 'ui-shell';
            shell.innerHTML = `
                <div class="shell-header">
                    <span>Tools</span>
                    <button id="shell-toggle" title="Collapse" style="background:#1f2937;color:#e2e8f0;border:1px solid #334155;padding:4px 8px;border-radius:4px">‚ü®</button>
                </div>
                <div class="shell-body" id="shell-list"></div>
                <div class="shell-footer">
                    <button class="tag" id="shell-show-all">Show All</button>
                    <button class="tag" id="shell-hide-all">Hide All</button>
                    <button class="tag" id="shell-reset">Reset Layout</button>
                    <button class="tag" id="shell-retro">Retro Mode</button>
                    <button class="tag" id="shell-tabs-mode">Tab Mode</button>
                    <button class="tag" id="shell-3d-toggle">3D View</button>
                </div>
            `;
            document.body.appendChild(shell);
            document.body.classList.add('with-shell');

            // Save initial order for reset
            const initialOrder = candidates.map(p=> p.id);

            // Build layout zones wrapper and move panels into it
            let zones = document.getElementById('layout-zones');
            if (!zones){
                zones = document.createElement('div'); zones.id = 'layout-zones';
                zones.innerHTML = `
                    <div id="tool-tabs"></div>
                    <div id="zone-left"></div>
                    <div id="zone-center"></div>
                    <div id="zone-right"></div>
                    <div id="zone-bottom"></div>
                `;
                // Insert zones before the first managed panel
                const firstPanel = document.getElementById(initialOrder[0]);
                if (firstPanel && firstPanel.parentNode){
                    firstPanel.parentNode.insertBefore(zones, firstPanel);
                } else {
                    document.body.appendChild(zones);
                }
                // Move panels into center zone by default (wrapped)
                candidates.forEach(p=>{
                    const el=document.getElementById(p.id); if(!el) return;
                    const wrap = ensureWrapped(p.id);
                    zones.querySelector('#zone-center').appendChild(wrap);
                    el.dataset.size='normal'; el.classList.remove('panel-size-small','panel-size-large');
                });
            }
            // Build tabs bar
            initTabsBar(candidates, crucial);
            // Apply persisted layout if present
            try { const saved = loadShellState(); if (saved) applyShellState(saved, candidates); } catch(e) {}

            const list = document.getElementById('shell-list');
            const makeRow = (p)=>{
                const row = document.createElement('div'); row.className='panel-item'; row.dataset.pid = p.id; row.draggable = true;
                const el = document.getElementById(p.id);
                const checked = el && getComputedStyle(el).display !== 'none';
                const visAttr = crucial.has(p.id)? 'checked disabled' : (checked? 'checked':'' );
                row.innerHTML = `
                    <input type="checkbox" class="panel-vis" ${visAttr} />
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span>${p.label}</span>
                        <span class="muted">#${p.id}</span>
                    </div>
                    <div class="panel-controls">
                        <select class="tag zone" title="Place in area">
                            <option value="center" selected>Center</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="bottom">Bottom</option>
                        </select>
                        <select class="tag size" title="Size">
                            <option value="small">Small</option>
                            <option value="normal" selected>Normal</option>
                            <option value="large">Large</option>
                        </select>
                        <button class="tag up" title="Move Up">‚Üë</button>
                        <button class="tag down" title="Move Down">‚Üì</button>
                    </div>
                `;
                // Visibility toggle
                row.querySelector('.panel-vis').addEventListener('change', (e)=>{
                    const target = getWrapper(p.id);
                    if (!target) return;
                    if (crucial.has(p.id)) { e.target.checked = true; target.style.display=''; return; }
                    target.style.display = e.target.checked? '' : 'none';
                    saveShellState(candidates);
                });
                // Move up/down (reorder in DOM)
                row.querySelector('.up').addEventListener('click', ()=>{ movePanel(p.id, -1); saveShellState(candidates); });
                row.querySelector('.down').addEventListener('click', ()=>{ movePanel(p.id, +1); saveShellState(candidates); });
                // Zone placement
                row.querySelector('.zone').addEventListener('change', (e)=>{
                    movePanelToZone(p.id, e.target.value); saveShellState(candidates);
                });
                // Size control
                row.querySelector('.size').addEventListener('change', (e)=>{
                    setPanelSize(p.id, e.target.value); saveShellState(candidates);
                });
                // Drag-and-drop ordering in Tools menu
                row.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', p.id); row.classList.add('dragging'); });
                row.addEventListener('dragend', ()=>{ row.classList.remove('dragging'); saveShellState(candidates); applyMenuOrderToZones(); });
                row.addEventListener('dragover', (ev)=>{ ev.preventDefault(); const dragging = list.querySelector('.dragging'); if (!dragging || dragging===row) return; const rect=row.getBoundingClientRect(); const before = (ev.clientY - rect.top) < rect.height/2; list.insertBefore(dragging, before? row : row.nextSibling); });
                return row;
            };
            candidates.forEach(p=> list.appendChild(makeRow(p)));

            // Collapse behavior
            document.getElementById('shell-toggle').addEventListener('click', (e)=>{
                const compact = document.body.classList.toggle('shell-collapsed');
                const btn = e.currentTarget;
                if (compact){
                    document.getElementById('ui-shell').style.width = '48px';
                    document.body.style.paddingLeft = '68px';
                    btn.textContent = '‚ü©';
                } else {
                    document.getElementById('ui-shell').style.width = '240px';
                    document.body.style.paddingLeft = '260px';
                    btn.textContent = '‚ü®';
                }
            });

            // Bulk actions
            document.getElementById('shell-show-all').addEventListener('click', ()=>{
                candidates.forEach(p=>{ const el=getWrapper(p.id); if(el){ el.style.display=''; } });
                list.querySelectorAll('.panel-vis').forEach(cb=> cb.checked = true);
                saveShellState(candidates);
            });
            document.getElementById('shell-hide-all').addEventListener('click', ()=>{
                candidates.forEach(p=>{ const el=getWrapper(p.id); if(el){ el.style.display = crucial.has(p.id)? '' : 'none'; } });
                list.querySelectorAll('.panel-vis').forEach(cb=>{ if (cb.disabled){ cb.checked = true; } else { cb.checked = false; } });
                saveShellState(candidates);
            });
            document.getElementById('shell-reset').addEventListener('click', ()=>{
                // Restore order
                for (let i=initialOrder.length-1;i>=0;i--){
                    const id = initialOrder[i];
                    const wrap = getWrapper(id);
                    const el = document.getElementById(id);
                    if (wrap && el){ zones.querySelector('#zone-center').appendChild(wrap); wrap.style.display=''; el.classList.remove('panel-size-small','panel-size-large'); el.dataset.size='normal'; wrap.style.width=''; wrap.style.height=''; }
                }
                // Show all
                candidates.forEach(p=>{ const el=getWrapper(p.id); if(el){ el.style.display=''; } });
                list.querySelectorAll('.panel-vis').forEach(cb=> cb.checked = true);
                document.body.classList.remove('retro-mode');
                saveShellState(candidates);
            });
            document.getElementById('shell-retro').addEventListener('click', ()=>{ document.body.classList.toggle('retro-mode'); saveShellState(candidates); });
            const threeToggle = document.getElementById('shell-3d-toggle');
            if (threeToggle) threeToggle.addEventListener('click', ()=>{
                const entering = !document.body.classList.contains('in-3d');
                if (entering){ mountRetro3DContainer(); document.body.classList.add('in-3d'); if (typeof initRetro3D==='function') initRetro3D(); }
                else { document.body.classList.remove('in-3d'); }
            });
            document.getElementById('shell-tabs-mode').addEventListener('click', ()=>{ toggleTabMode(candidates, crucial); });

            function movePanel(id, delta){
                const el = getWrapper(id);
                if (!el || !el.parentNode) return;
                const parent = el.parentNode;
                const siblings = Array.from(parent.children).filter(n=> n.classList && n.classList.contains('tool-window'));
                const idx = siblings.indexOf(el);
                const newIdx = Math.max(0, Math.min(siblings.length-1, idx + delta));
                if (newIdx === idx) return;
                const ref = siblings[newIdx + (delta>0? 1:0)] || (delta<0? siblings[0]: null);
                parent.insertBefore(el, ref);
            }

            function movePanelToZone(id, zone){
                const wrap = getWrapper(id);
                const container = document.getElementById(`zone-${zone}`) || document.getElementById('zone-center');
                if (wrap && container){ container.appendChild(wrap); }
            }
            function setPanelSize(id, size){
                const el = document.getElementById(id);
                const wrap = getWrapper(id);
                if (!el || !wrap) return;
                el.classList.remove('panel-size-small','panel-size-large');
                if (size==='small') el.classList.add('panel-size-small');
                else if (size==='large') el.classList.add('panel-size-large');
                el.dataset.size = size;
                // Optional: snap wrapper min width/height by size
                wrap.style.minWidth = (size==='small')? '200px' : (size==='large')? '280px':'220px';
                wrap.style.minHeight = (size==='small')? '100px' : (size==='large')? '180px':'120px';
            }

            // Helpers: wrap panels and add resizers
            function ensureWrapped(id){
                const panel = document.getElementById(id);
                if (!panel) return null;
                const existing = getWrapper(id);
                if (existing) return existing;
                const wrap = document.createElement('div');
                wrap.className = 'tool-window';
                wrap.dataset.panelId = id;
                // Insert wrap before panel, then move panel inside
                panel.parentNode.insertBefore(wrap, panel);
                wrap.appendChild(panel);
                attachResizers(wrap);
                return wrap;
            }
            function getWrapper(id){ return document.querySelector(`.tool-window[data-panel-id="${id}"]`); }
            function attachResizers(wrap){
                ['nw','ne','sw','se'].forEach(c=>{
                    const h = document.createElement('div'); h.className = `resize-handle rh-${c}`; wrap.appendChild(h);
                    h.addEventListener('mousedown', (e)=> startResize(e, wrap, c));
                });
            }
            function startResize(e, wrap, corner){
                e.preventDefault();
                const startX = e.clientX, startY = e.clientY;
                const rect = wrap.getBoundingClientRect();
                const startW = rect.width, startH = rect.height;
                const startL = rect.left, startT = rect.top;
                function onMove(ev){
                    const dx = ev.clientX - startX;
                    const dy = ev.clientY - startY;
                    let newW = startW, newH = startH;
                    if (corner.includes('e')) newW = Math.max(180, startW + dx);
                    if (corner.includes('s')) newH = Math.max(100, startH + dy);
                    if (corner.includes('w')) newW = Math.max(180, startW - dx);
                    if (corner.includes('n')) newH = Math.max(100, startH - dy);
                    wrap.style.width = newW + 'px';
                    wrap.style.height = newH + 'px';
                    // If this is the orbits panel, re-fit canvas
                    if (wrap.dataset.panelId === 'harmony-orbits') fitOrbitsCanvas();
                }
                function onUp(){
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('mouseup', onUp);
                }
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp);
            }

            // ===== Persistence helpers =====
            function currentShellState(cands){
                const state = { retro: document.body.classList.contains('retro-mode'), panels: [] };
                const zonesMap = { left: document.getElementById('zone-left'), center: document.getElementById('zone-center'), right: document.getElementById('zone-right'), bottom: document.getElementById('zone-bottom') };
                cands.forEach(p=>{
                    const wrap = getWrapper(p.id); const el = document.getElementById(p.id);
                    if (!wrap || !el) return;
                    const zone = Object.entries(zonesMap).find(([,node])=> node && wrap.parentElement===node)?.[0] || 'center';
                    const visible = getComputedStyle(wrap).display !== 'none';
                    state.panels.push({ id:p.id, zone, visible, size: el.dataset.size||'normal' });
                });
                // Order by zone
                state.order = {
                    left: Array.from(zonesMap.left?.children||[]).map(w=> w.dataset.panelId),
                    center: Array.from(zonesMap.center?.children||[]).map(w=> w.dataset.panelId),
                    right: Array.from(zonesMap.right?.children||[]).map(w=> w.dataset.panelId),
                    bottom: Array.from(zonesMap.bottom?.children||[]).map(w=> w.dataset.panelId)
                };
                return state;
            }
            function saveShellState(cands){ try { localStorage.setItem(SHELL_KEY, JSON.stringify(currentShellState(cands))); } catch(e){} }
            function loadShellState(){ try { return JSON.parse(localStorage.getItem(SHELL_KEY)||'null'); } catch(e){ return null; } }
            function applyShellState(state, cands){
                if (!state) return;
                document.body.classList.toggle('retro-mode', !!state.retro);
                const zonesMap = { left: document.getElementById('zone-left'), center: document.getElementById('zone-center'), right: document.getElementById('zone-right'), bottom: document.getElementById('zone-bottom') };
                (state.panels||[]).forEach(p=>{
                    const wrap = getWrapper(p.id); const el = document.getElementById(p.id);
                    if (!wrap || !el) return;
                    const zoneNode = zonesMap[p.zone] || zonesMap.center;
                    if (zoneNode) zoneNode.appendChild(wrap);
                    wrap.style.display = p.visible? '' : 'none';
                    setPanelSize(p.id, p.size||'normal');
                });
                // Apply order within zones
                ['left','center','right','bottom'].forEach(z=>{
                    const ids = state.order?.[z]||[]; const container = zonesMap[z];
                    ids.forEach(id=>{ const w=getWrapper(id); if (w && container) container.appendChild(w); });
                });
                // Sync menu checkboxes and selects
                syncMenuFromState(state);
            }
            function syncMenuFromState(state){
                const list = document.getElementById('shell-list'); if (!list) return;
                list.querySelectorAll('.panel-item').forEach(row=>{
                    const id = row.dataset.pid; const p = (state.panels||[]).find(x=> x.id===id);
                    if (!p) return;
                    const cb = row.querySelector('.panel-vis'); if (cb && !cb.disabled) cb.checked = !!p.visible;
                    const zoneSel = row.querySelector('.zone'); if (zoneSel) zoneSel.value = p.zone||'center';
                    const sizeSel = row.querySelector('.size'); if (sizeSel) sizeSel.value = p.size||'normal';
                });
            }
            function applyMenuOrderToZones(){
                // Reorder wrappers within their current zones according to menu item order
                const list = document.getElementById('shell-list'); const rows = Array.from(list.children);
                const order = rows.map(r=> r.dataset.pid);
                const zonesMap = { left: document.getElementById('zone-left'), center: document.getElementById('zone-center'), right: document.getElementById('zone-right'), bottom: document.getElementById('zone-bottom') };
                order.forEach(id=>{
                    const w = getWrapper(id); if (!w) return;
                    const zone = Object.entries(zonesMap).find(([,node])=> node && w.parentElement===node)?.[0] || 'center';
                    const container = zonesMap[zone]; if (container) container.appendChild(w);
                });
            }

            // ===== Tabs (Tab Mode) =====
            const TABS_KEY = 'bh_shell_tabs_v1';
            function initTabsBar(cands, crucial){
                const bar = document.getElementById('tool-tabs'); if (!bar) return;
                bar.innerHTML = '';
                cands.forEach(p=>{
                    const btn = document.createElement('button'); btn.className='tab'; btn.dataset.pid=p.id; btn.textContent=p.label; bar.appendChild(btn);
                    btn.addEventListener('click', ()=>{ activateTab(p.id, cands, crucial); });
                });
                // Restore mode
                const st = loadTabsState(); if (st?.mode){ setTabMode(st.mode, cands, crucial); if (st.active) activateTab(st.active, cands, crucial); }
            }
            function setTabMode(on, cands, crucial){
                document.body.classList.toggle('tab-mode', !!on);
                saveTabsState({ mode: !!on, active: getActiveTabId() });
                if (on){
                    // default to first non-crucial or first candidate
                    const first = cands.find(p=> !crucial.has(p.id))?.id || cands[0]?.id; if (first) activateTab(first, cands, crucial);
                } else {
                    // show all according to shell state
                    const saved = loadShellState(); if (saved) applyShellState(saved, cands);
                    const bar = document.getElementById('tool-tabs'); bar.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
                }
            }
            function toggleTabMode(cands, crucial){ const st=loadTabsState(); setTabMode(!(st?.mode), cands, crucial); }
            function activateTab(id, cands, crucial){
                const bar = document.getElementById('tool-tabs'); bar.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.pid===id));
                // Show essentials and selected; hide others
                cands.forEach(p=>{
                    const w=getWrapper(p.id); if (!w) return;
                    if (crucial.has(p.id) || p.id===id) { w.style.display=''; } else { w.style.display='none'; }
                });
                saveTabsState({ mode: true, active: id });
            }
            function getActiveTabId(){ const st=loadTabsState(); return st?.active||null; }
            function saveTabsState(obj){ try{ localStorage.setItem(TABS_KEY, JSON.stringify(obj)); }catch(e){} }
            function loadTabsState(){ try{ return JSON.parse(localStorage.getItem(TABS_KEY)||'null'); }catch(e){ return null; } }
        }

        // ============== Harmony Orbits Visualization ==============
        function ensureOrbitsPanel(){
            let panel = document.getElementById('harmony-orbits');
            if (panel) return panel;
            panel = document.createElement('section');
            panel.id = 'harmony-orbits';
            panel.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                    <div style="font-weight:700;">Harmony Orbits</div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button id="orbits-play" class="tag">Play</button>
                        <label class="muted">Depth <input id="orbits-depth" type="range" min="0" max="1" step="0.01" value="0.35" style="vertical-align:middle"></label>
                        <label class="muted">Labels <input id="orbits-labels" type="checkbox" checked></label>
                        <label class="muted">Expanded <input id="orbits-expanded" type="checkbox"></label>
                    </div>
                </div>
                <canvas id="orbits-canvas" style="width:100%;height:420px;display:block;border-radius:8px;background:radial-gradient(ellipse at center,#0b1020,#05070f);"></canvas>
                <div class="muted" style="margin-top:6px;">Planets = scale degrees around tonic (sun). Moons = functional relations (ii of, V of...). Colors: masculine, feminine, tendency.</div>
            `;
            // Put panel into DOM so UI shell can wrap it
            const anchor = document.querySelector('#layout-zones #zone-center') || document.body;
            anchor.appendChild(panel);
            return panel;
        }

        let ORBITS = { running:false, lastT:0, hits:[] };
        function initHarmonyOrbits(){
            const panel = ensureOrbitsPanel();
            // ensure wrapped for resizing/menu
            const wrap = (typeof ensureWrapped==='function')? ensureWrapped('harmony-orbits') : null;
            fitOrbitsCanvas();
            const playBtn = document.getElementById('orbits-play');
            playBtn.onclick = ()=>{ ORBITS.running = !ORBITS.running; playBtn.textContent = ORBITS.running? 'Pause':'Play'; if (ORBITS.running) requestAnimationFrame(tickOrbits); };
            // live re-render on state changes
            window.addEventListener('resize', fitOrbitsCanvas);
            // initial draw
            drawOrbits(0);
            // Tooltip setup and interactions
            ensureOrbitsTooltip();
            const c = document.getElementById('orbits-canvas');
            c.addEventListener('mousemove', onOrbitsHover);
            c.addEventListener('mouseleave', ()=> hideOrbitsTooltip());
            c.addEventListener('click', onOrbitsClick);
        }
        function fitOrbitsCanvas(){
            const c = document.getElementById('orbits-canvas'); if (!c) return;
            const rect = c.parentElement.getBoundingClientRect();
            const W = Math.max(280, Math.floor(rect.width));
            const H = Math.max(240, Math.floor(rect.height - 64));
            if (c.width !== W || c.height !== H){ c.width = W; c.height = H; }
        }
        function tickOrbits(ts){
            if (!ORBITS.running) return;
            const dt = ORBITS.lastT? (ts-ORBITS.lastT)/1000 : 0; ORBITS.lastT = ts;
            drawOrbits(dt);
            requestAnimationFrame(tickOrbits);
        }
        function degreeClass(deg, N){
            // Matches updateCurrentNumbers classification
            let cls = 'fem';
            const d = ((deg-1)%N)+1;
            if (d===1 || d===5) cls='masc';
            if (d===3 || d===7) cls='tend';
            return cls;
        }
        function colorsFor(cls){
            if (cls==='masc') return { fill:'#60a5fa', stroke:'#93c5fd' };
            if (cls==='tend') return { fill:'#f59e0b', stroke:'#fcd34d' };
            return { fill:'#a78bfa', stroke:'#c4b5fd' }; // fem
        }
        function getScaleDegreeCount(){
            return (AppState.numberType==='barry8')? 8 : (AppState.numberType==='extended')? 7 : scaleLength();
        }
        function functionalMoonsForDegree(deg){
            // Core diatonic set plus optional expanded chromatic relations mapped back to nearest degree
            const N = getScaleDegreeCount();
            const wrap = (x)=> ((x-1)%N+N)%N + 1;
            const core = [
                { label:'ii of',  d: wrap(deg+1) },
                { label:'V of',   d: wrap(deg+4) },
                { label:'IV of',  d: wrap(deg+3) },
                { label:'VI of',  d: wrap(deg+5) }
            ];
            const expanded = !!document.getElementById('orbits-expanded')?.checked;
            if (!expanded) return core;
            // Compute via semitone notes
            const parentNote = degreeToNote(deg);
            const Vnote = MusicTheory.getNoteFromInterval(parentNote, 7);
            const rels = [
                { label:'bII (TT sub) of', note: MusicTheory.getNoteFromInterval(Vnote, 6) },
                { label:'bVII (backdoor) of', note: MusicTheory.getNoteFromInterval(parentNote, 10) },
                { label:'bVI (borrowed) of', note: MusicTheory.getNoteFromInterval(parentNote, 8) },
                { label:'bIII (borrowed) of', note: MusicTheory.getNoteFromInterval(parentNote, 3) }
            ];
            const mapped = rels.map(r=> ({ label:r.label, d: nearestDegreeForNote(r.note) })).filter(x=> x.d);
            return core.concat(mapped);
        }
        function degreeToNote(deg){
            const scaleNotes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale) || [];
            return scaleNotes[((deg-1) % (scaleNotes.length||1))];
        }
        function noteToDegree(note){
            const scaleNotes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale) || [];
            const idx = scaleNotes.indexOf(note);
            return idx>=0 ? (idx+1) : null;
        }
        function nearestDegreeForNote(note){
            const nSemi = NAME_TO_SEMI[note];
            const scaleNotes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale) || [];
            let best=null, bd=1e9;
            scaleNotes.forEach((sn, i)=>{
                const d = Math.min( ( (NAME_TO_SEMI[sn]-nSemi+12)%12 ), ( (nSemi-NAME_TO_SEMI[sn]+12)%12 ) );
                if (d<bd){ bd=d; best=i+1; }
            });
            return best;
        }

        // ============== Toolflow (Left‚ÜíRight chain) ==============
        function ensureToolflowPanel(){
            let panel = document.getElementById('toolflow'); if (panel) return panel;
            panel = document.createElement('section'); panel.id='toolflow';
            panel.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                    <div style="font-weight:700;">Toolflow</div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button class="tag" id="flow-zoom-in">Zoom +</button>
                        <button class="tag" id="flow-zoom-out">Zoom ‚àí</button>
                        <button class="tag" id="flow-center">Center</button>
                    </div>
                </div>
                <canvas id="flow-canvas" style="width:100%;height:320px;display:block;border-radius:8px;background:linear-gradient(180deg,#0b1020,#05070f);"></canvas>
            `;
            const anchor = document.querySelector('#layout-zones #zone-center') || document.body; anchor.appendChild(panel);
            return panel;
        }
        </script>
        
        <!-- Fallback: ensure core actions work even if earlier scripts failed to execute -->
        <script>
        (function(){
            if (!window.AppState) window.AppState = { currentKey:'C', currentScale:'major', currentNumbers:[], numberType:'diatonic', keyScaleSet:true };
            if (!window.MusicTheory){
                const CH=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
                const nameTo={}; CH.forEach((n,i)=> nameTo[n]=i); Object.assign(nameTo,{Db:1,Eb:3,Gb:6,Ab:8,Bb:10});
                const scales={ major:[0,2,4,5,7,9,11] };
                window.MusicTheory={
                    getNoteFromInterval:(root,semi)=> CH[( (nameTo[root]??0)+semi)%12],
                    getScaleNotes:(key,kind)=> (scales[kind]||scales.major).map(iv=> CH[( (nameTo[key]??0)+iv)%12])
                };
            }
            if (typeof window.scaleLength !== 'function') window.scaleLength = ()=> (MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale)?.length||7);
            if (typeof window.updateAllResults !== 'function') window.updateAllResults = function(){
                try{
                    const nums = (AppState.currentNumbers||[]).slice();
                    const notes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale)||[];
                    const toNote=(v)=> typeof v==='number'? notes[( (v-1)%(notes.length||1)+ (notes.length||1))%(notes.length||1)] : String(v);
                    const nd=document.getElementById('numbers-display'); const cn=document.getElementById('current-numbers');
                    if (nd) nd.textContent = nums.join(', ');
                    if (cn) cn.textContent = nums.join(', ');
                    const ksc=document.getElementById('key-scale-context'); if (ksc) ksc.textContent = `${AppState.currentKey} ${AppState.currentScale}`;
                    const notesOut=document.getElementById('notes-result'); if (notesOut) notesOut.textContent = nums.map(toNote).join(', ');
                }catch(e){ /* silent */ }
            };
            if (typeof window.updateScaleTools !== 'function') window.updateScaleTools = function(){ /* no-op fallback */ };
            if (typeof window.mountRetro3DContainer !== 'function') window.mountRetro3DContainer = function(){};
            // ===== Fallback Piano (renderPianoAccurate) =====
            function ensurePianoStage(){
                let host = document.getElementById('piano-inline') || document.getElementById('piano-stage');
                if (!host){
                    // Try to find a reasonable place: after results on the right column if exists
                    host = document.createElement('div'); host.id='piano-stage'; host.style.cssText='margin-top:10px;';
                    const right = document.getElementById('zone-right') || document.body;
                    right.appendChild(host);
                }
                return host;
            }
            if (typeof window.renderPianoAccurate !== 'function') window.renderPianoAccurate = function(activeNames, rolesMap){
                const host = ensurePianoStage();
                const names = Array.isArray(activeNames)? activeNames : [];
                const role = rolesMap||{};
                const KEYS = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
                const octaves = 2; // simple 2-octave display
                const whiteOrder = ['C','D','E','F','G','A','B'];
                const isBlack = (n)=> n.includes('#');
                // Build SVG
                const W = 420, H = 120, WWHITE = W/(whiteOrder.length*octaves);
                let svg = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" style="display:block;background:#0b1324;border-radius:8px">`;
                // White keys
                let x = 0; const whitePos = {};
                for (let o=0;o<octaves;o++){
                    for (const wn of whiteOrder){
                        const label = wn + (o===0? '' : (o===1? '‚Ä≤' : ''));
                        svg += `<rect x="${x}" y="0" width="${WWHITE}" height="${H}" fill="#f8fafc" stroke="#cbd5e1"/>`;
                        whitePos[wn+o] = x;
                        const fullName = wn; const active = names.includes(fullName);
                        if (active){ svg += `<rect x="${x+2}" y="2" width="${WWHITE-4}" height="${H-4}" fill="#e0f2fe" stroke="#38bdf8"/>`; }
                        x += WWHITE;
                    }
                }
                // Black keys (positioned between whites)
                function wp(name){ return whitePos[name]; }
                const blackMap = { 'C#':['C','D'], 'D#':['D','E'], 'F#':['F','G'], 'G#':['G','A'], 'A#':['A','B'] };
                for (let o=0;o<octaves;o++){
                    for (const [bn, between] of Object.entries(blackMap)){
                        const left = wp(between[0]+o); const right = wp(between[1]+o);
                        if (left===undefined || right===undefined) continue;
                        const bx = left + (right-left)*0.7; const bw = (right-left)*0.6; const bh = H*0.6;
                        const fullName = bn; const active = names.includes(fullName);
                        svg += `<rect x="${bx}" y="0" width="${bw}" height="${bh}" rx="2" fill="#0f172a" stroke="#334155"/>`;
                        if (active){ svg += `<rect x="${bx+1}" y="1" width="${bw-2}" height="${bh-2}" fill="#1e293b" stroke="#38bdf8"/>`; }
                    }
                }
                svg += `</svg>`;
                host.innerHTML = svg;
                // Simple click handling via overlay divs
                host.onclick = (ev)=>{
                    const rect = host.getBoundingClientRect(); const px = ev.clientX - rect.left; const py = ev.clientY - rect.top;
                    // Map to nearest white key for simplicity
                    const idx = Math.floor(px / WWHITE);
                    const wIdx = idx % whiteOrder.length; const o = Math.floor(idx / whiteOrder.length);
                    const name = whiteOrder[wIdx];
                    const n = name; // octave ignored for naming
                    const i = names.indexOf(n);
                    if (i>=0) names.splice(i,1); else names.push(n);
                    window.VL_STATE = window.VL_STATE || {}; VL_STATE.voicing = names.slice();
                    window.renderPianoAccurate(names, role);
                };
            };
            // ===== Fallback Harmony Orbits =====
            function ensureOrbitsPanel(){
                let panel = document.getElementById('harmony-orbits');
                if (!panel){ panel = document.createElement('section'); panel.id='harmony-orbits'; panel.innerHTML = `<div class="result-label">Harmony Orbits</div><canvas id="orbits-canvas" style="width:100%;height:220px;display:block;background:#0b1020;border-radius:8px"></canvas>`; (document.getElementById('zone-center')||document.body).appendChild(panel); }
                if (!panel.querySelector('#orbits-canvas')){ const c=document.createElement('canvas'); c.id='orbits-canvas'; c.style.cssText='width:100%;height:220px;display:block;background:#0b1020;border-radius:8px'; panel.appendChild(c); }
                return panel.querySelector('#orbits-canvas');
            }
            function fitCanvas(c){ const r = c.getBoundingClientRect(); c.width = Math.max(200, Math.floor(r.width)); c.height = Math.max(160, Math.floor(r.height)); }
            if (typeof window.initHarmonyOrbits !== 'function') window.initHarmonyOrbits = function(){
                const c = ensureOrbitsPanel(); fitCanvas(c);
                const ctx = c.getContext('2d');
                function draw(){
                    ctx.clearRect(0,0,c.width,c.height);
                    // simple circle of degrees
                    const N = (typeof scaleLength==='function')? scaleLength(): 7;
                    const cx = c.width/2, cy = c.height/2, R = Math.min(cx,cy)-20;
                    ctx.fillStyle = '#0b1020'; ctx.fillRect(0,0,c.width,c.height);
                    ctx.strokeStyle = '#334155'; ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();
                    for(let d=1; d<=N; d++){
                        const ang = -Math.PI/2 + (Math.PI*2)*(d-1)/N;
                        const x = cx + R*Math.cos(ang), y = cy + R*Math.sin(ang);
                        ctx.fillStyle = '#38bdf8'; ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.fill();
                        ctx.fillStyle='#e2e8f0'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(String(d), x, y);
                    }
                }
                draw();
                // click -> set active degree
                c.onclick = (ev)=>{
                    const rect = c.getBoundingClientRect(); const px = ev.clientX-rect.left, py=ev.clientY-rect.top;
                    const N = (typeof scaleLength==='function')? scaleLength(): 7;
                    const cx = c.width/2, cy = c.height/2, R = Math.min(cx,cy)-20;
                    for(let d=1; d<=N; d++){
                        const ang = -Math.PI/2 + (Math.PI*2)*(d-1)/N;
                        const x = cx + R*Math.cos(ang), y = cy + R*Math.sin(ang);
                        const dist = Math.hypot(px-x, py-y);
                        if (dist<=12){ window.AppState = window.AppState||{}; AppState.activeDegree=d; if (typeof updateAllResults==='function') updateAllResults(); break; }
                    }
                };
                window.addEventListener('resize', ()=>{ fitCanvas(c); draw(); });
            };
            // Note: DOMContentLoaded handlers consolidated above
            (function(){
                // Do NOT enable minimal mode - keep all tools visible
                // document.body.classList.add('minimal-mode');
                // REMOVED: Numbers Strip (was duplicative)
                // Keep all controls in Step 1 (left panel) - single source of truth
                (function skipNumbersStrip(){
                    if (false && document.getElementById('numbers-strip')) return;
                    const header = document.querySelector('.header');
                    const strip = null; // document.createElement('div'); strip.id='numbers-strip';
                    strip.innerHTML = `
                        <div class="row">
                            <div class="label">Current Numbers</div>
                            <div class="value" id="ns-numbers">‚Äî</div>
                            <span class="spacer"></span>
                            <select id="ns-number-type" class="btn-step" style="min-width:150px">
                                <option value="diatonic">Diatonic (1-7)</option>
                                <option value="barry8">Barry Harris 8-Tone</option>
                                <option value="extended">Extended (1-14)</option>
                                <option value="chromatic">Chromatic/Altered</option>
                            </select>
                            <input id="ns-number-len" type="number" min="2" max="12" value="4" class="btn-step" style="width:64px">
                            <button class="btn-step btn-generate" id="ns-generate">Generate</button>
                        </div>
                        <div class="row" id="ns-transforms">
                            <button class="btn-step" id="ns-retrograde" title="Reverse order">Retrograde</button>
                            <button class="btn-step" id="ns-invert" title="Degree complement within scale">Invert</button>
                            <button class="btn-step" id="ns-rot-left" title="Rotate left">‚ü≤</button>
                            <button class="btn-step" id="ns-rot-right" title="Rotate right">‚ü≥</button>
                            <input id="ns-rotate-n" type="number" min="1" max="32" value="1" class="btn-step" style="width:72px" title="Rotate by N" />
                            <button class="btn-step" id="ns-rotate-n-btn">Rotate N</button>
                            <select id="ns-invert-axis" class="btn-step" style="min-width:120px" title="Invert around axis N">
                                <option value="auto" selected>Axis: Auto</option>
                                <option value="7">Axis: 7</option>
                                <option value="8">Axis: 8</option>
                                <option value="14">Axis: 14</option>
                            </select>
                            <button class="btn-step" id="ns-randomize" title="Randomize with constraints">Randomize</button>
                        </div>
                        <div class="row"><div id="piano-inline" style="width:100%"></div></div>
                        <div class="row" id="ns-tools">
                            <button class="btn-step" id="ns-undo">Undo</button>
                            <button class="btn-step" id="ns-history">History</button>
                            <span class="spacer"></span>
                            <button class="btn-step" id="ns-save">Save</button>
                            <button class="btn-step" id="ns-load">Load</button>
                            <button class="btn-step" id="ns-export">Export MIDI</button>
                            <span class="spacer"></span>
                            <button class="btn-step" id="ns-prev-voicing">‚óÄ Prev Voicing</button>
                            <button class="btn-step" id="ns-next-voicing">Next Voicing ‚ñ∂</button>
                            <button class="btn-step" id="ns-lock-voices">Lock</button>
                            <button class="btn-step" id="ns-clear-voicing">Clear Voicing</button>
                        </div>
                    `;
                    header.parentNode.insertBefore(strip, header.nextSibling);
                    // Sync initial selects from originals if present
                    const typeOrig = document.getElementById('number-type');
                    if (typeOrig) document.getElementById('ns-number-type').value = typeOrig.value;
                    const lenOrig = document.getElementById('number-seq-len');
                    if (lenOrig) document.getElementById('ns-number-len').value = lenOrig.value;
                    // Wire Generate in strip
                    document.getElementById('ns-generate').onclick = ()=>{
                        const t = document.getElementById('ns-number-type').value;
                        const l = document.getElementById('ns-number-len').value;
                        if (typeOrig) typeOrig.value = t; if (lenOrig) lenOrig.value = l;
                        document.getElementById('btn-gen-numbers')?.click();
                        setTimeout(()=>{ if (typeof window.__updateInlineNumbersDisplay==='function') window.__updateInlineNumbersDisplay(); }, 30);
                    };
                    // Do NOT move originals; use proxy buttons to trigger them
                    const click = (id)=>{ const el=document.getElementById(id); if (el) el.click(); };
                    const setVal = (srcId, dstId)=>{ const s=document.getElementById(srcId); const d=document.getElementById(dstId); if (s&&d) d.value = s.value; };
                    const bindProxy = (proxyId, origId, withValue)=>{
                        const b=document.getElementById(proxyId); if (!b) return;
                        b.onclick = ()=>{
                            if (withValue){ setVal('ns-rotate-n','rotate-n'); setVal('ns-invert-axis','invert-axis'); }
                            click(origId);
                            setTimeout(()=>{ if (typeof window.__updateInlineNumbersDisplay==='function') window.__updateInlineNumbersDisplay(); }, 30);
                        };
                    };
                    bindProxy('ns-retrograde','btn-retrograde');
                    bindProxy('ns-invert','btn-invert');
                    bindProxy('ns-rot-left','btn-rot-left');
                    bindProxy('ns-rot-right','btn-rot-right');
                    bindProxy('ns-rotate-n-btn','btn-rotate-n', true);
                    bindProxy('ns-randomize','btn-randomize');
                    // Tool proxies (session/voicing)
                    const bindTool = (btnId, targetId, toggleText)=>{
                        const b=document.getElementById(btnId); if (!b) return;
                        b.onclick = ()=>{
                            if (toggleText && targetId==='lock-voices'){
                                const t=document.getElementById('lock-voices'); if (t){ t.click(); b.textContent = t.textContent.replace('Lock: ','Lock ');} else { b.textContent = (b.textContent.includes('On')?'Lock':'Lock On'); }
                            } else { click(targetId); }
                        };
                    };
                    bindTool('ns-undo','btn-undo-numbers');
                    bindTool('ns-history','btn-history-numbers');
                    bindTool('ns-save','save-session');
                    bindTool('ns-load','load-session');
                    bindTool('ns-export','export-midi');
                    bindTool('ns-prev-voicing','prev-voicing');
                    bindTool('ns-next-voicing','next-voicing');
                    bindTool('ns-lock-voices','lock-voices', true);
                    bindTool('ns-clear-voicing','clear-voicing');
                    // Initial paint
                    // setTimeout(()=>{ if (typeof window.__updateInlineNumbersDisplay==='function') window.__updateInlineNumbersDisplay(); }, 10);
                })(); // Numbers Strip disabled - controls live in Step 1 only
                // Build a compact Results Toolbar under the Results panel Current Numbers
                (function buildResultsToolbar(){
                    if (document.getElementById('results-toolbar')) return;
                    const cn = document.getElementById('current-numbers');
                    const host = cn?.closest('.result-section');
                    if (!host) return;
                    const bar = document.createElement('div'); bar.id = 'results-toolbar';
                    bar.innerHTML = `
                        <div class="row" style="margin-bottom:8px;">
                            <span style="font-weight:700;color:#334155;">Container Chords:</span>
                            <button class="btn-step rtb-filter" data-filter="all">All</button>
                            <button class="btn-step rtb-filter" data-filter="scale">In Scale</button>
                            <button class="btn-step rtb-filter" data-filter="triads">Triads</button>
                            <button class="btn-step rtb-filter" data-filter="7ths">7ths</button>
                            <button class="btn-step rtb-filter" data-filter="extended">Extended</button>
                        </div>
                        <div class="row"><div id="container-results-inline" style="width:100%;min-height:60px;"></div></div>
                    `;
                    host.appendChild(bar);
                    // Container filters - mark active and render
                    bar.querySelectorAll('.rtb-filter').forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            bar.querySelectorAll('.rtb-filter').forEach(b=> b.classList.remove('active'));
                            btn.classList.add('active');
                            window.AppState = window.AppState || {};
                            AppState.currentFilter = btn.dataset.filter;
                            if (typeof window.renderContainerChordsInline==='function') window.renderContainerChordsInline();
                        });
                    });
                    // Mark first filter as active
                    const firstFilter = bar.querySelector('.rtb-filter');
                    if (firstFilter) firstFilter.classList.add('active');
                })();
                // Reorganize panels: group related tools inline
                (function reorganizePanels(){
                    // Numbers tab: Generate + Transforms + Results
                    const step1 = document.getElementById('step-1'); if (step1 && false){
                        const sec = document.createElement('div'); sec.className='panel-section';
                        sec.innerHTML = `
                            <div class="section-title">Generate Numbers</div>
                            <div class="controls-row">
                                <select id="number-type-inline" class="btn-step" style="flex:1;min-width:140px">
                                    <option value="diatonic">Diatonic (1-7)</option>
                                    <option value="barry8">Barry Harris 8-Tone</option>
                                    <option value="extended">Extended (1-14)</option>
                                    <option value="chromatic">Chromatic/Altered</option>
                                </select>
                                <input id="number-seq-len-inline" type="number" min="2" max="12" value="4" class="btn-step" style="width:60px">
                                <button class="btn-step btn-generate" id="btn-gen-inline">Generate</button>
                            </div>
                            <div class="result-block">
                                <div class="label">Current Numbers</div>
                                <div class="value" id="numbers-display-inline">‚Äî</div>
                            </div>
                            <div class="section-title" style="margin-top:12px">Transforms</div>
                            <div class="controls-row" id="transforms-inline"></div>
                            <div class="section-title" style="margin-top:12px">Piano</div>
                            <div id="piano-inline" class="result-block" style="padding:0"></div>
                        `;
                        step1.appendChild(sec);
                        // Wire Generate inline
                        document.getElementById('btn-gen-inline').onclick = ()=>{
                            const typeInline = document.getElementById('number-type-inline');
                            const lenInline = document.getElementById('number-seq-len-inline');
                            const typeOrig = document.getElementById('number-type');
                            const lenOrig = document.getElementById('number-seq-len');
                            if (typeOrig && typeInline) typeOrig.value = typeInline.value;
                            if (lenOrig && lenInline) lenOrig.value = lenInline.value;
                            document.getElementById('btn-gen-numbers')?.click();
                            // Update inline display
                            setTimeout(()=>{
                                const nums = window.AppState?.currentNumbers || [];
                                const disp = document.getElementById('numbers-display-inline');
                                if (disp) disp.textContent = nums.length? nums.join(', ') : '‚Äî';
                            }, 50);
                        };
                        // Transforms live in Numbers Strip now
                    }
                    // Key/Scale tab: Apply + Scale Tools + Results
                    const step2 = document.getElementById('step-2'); if (step2){
                        const sec = document.createElement('div'); sec.className='panel-section';
                        sec.innerHTML = `
                            <div class="section-title">Set Key & Scale</div>
                            <div class="controls-row">
                                <select id="key-select-inline" class="btn-step" style="flex:1;min-width:100px"></select>
                                <select id="scale-select-inline" class="btn-step" style="flex:2;min-width:140px"></select>
                                <button class="btn-step btn-generate" id="btn-apply-inline">Apply</button>
                            </div>
                            <div class="result-block">
                                <div class="label">Active Key/Scale</div>
                                <div class="value" id="key-scale-display-inline">C major</div>
                            </div>
                        `;
                        step2.appendChild(sec);
                        // Clone options from original selects
                        const ks = document.getElementById('key-select'); const ksi = document.getElementById('key-select-inline');
                        if (ks && ksi) ksi.innerHTML = ks.innerHTML;
                        const ss = document.getElementById('scale-select'); const ssi = document.getElementById('scale-select-inline');
                        if (ss && ssi) ssi.innerHTML = ss.innerHTML;
                        // Wire Apply inline
                        document.getElementById('btn-apply-inline').onclick = ()=>{
                            const k = document.getElementById('key-select-inline')?.value || 'C';
                            const s = document.getElementById('scale-select-inline')?.value || 'major';
                            if (ks) ks.value = k; if (ss) ss.value = s;
                            document.getElementById('btn-set-keyscale')?.click();
                            const disp = document.getElementById('key-scale-display-inline'); if (disp) disp.textContent = `${k} ${s}`;
                            setTimeout(()=>{ if (typeof window.__updateInlineNumbersDisplay==='function') window.__updateInlineNumbersDisplay(); }, 50);
                            // After any transform action, refresh inline numbers and piano
                            ['btn-retrograde','btn-invert','btn-rot-left','btn-rot-right','btn-rotate-n','btn-randomize'].forEach(id=>{
                                const el = document.getElementById(id); if (el && !el.dataset.inlineSync){ el.dataset.inlineSync='1'; el.addEventListener('click', ()=> setTimeout(()=>{ if (typeof window.__updateInlineNumbersDisplay==='function') window.__updateInlineNumbersDisplay(); }, 30)); }
                            });
                            // Initialize piano with current scale degrees immediately
                            updateScaleDegreesOnPiano();

                            // Initialize fallbacks if originals weren't defined
                            if (typeof window.renderPianoAccurate === 'function'){ try { renderPianoAccurate([], {}); } catch(_){} }
                            if (typeof window.initHarmonyOrbits === 'function'){ try { initHarmonyOrbits(); } catch(_){} }
                        };
                    }
                    // Containers tab: Filters + Results
                    const cont = document.getElementById('container-section'); if (cont){
                        const sec = document.createElement('div'); sec.className='panel-section';
                        sec.innerHTML = `
                            <div class="section-title">Container Chords</div>
                            <div class="controls-row">
                                <button class="btn-step filter-toggle active" data-filter="all">All</button>
                                <button class="btn-step filter-toggle" data-filter="scale">Scale</button>
                                <button class="btn-step filter-toggle" data-filter="triads">Triads</button>
                                <button class="btn-step filter-toggle" data-filter="7ths">7ths</button>
                                <button class="btn-step filter-toggle" data-filter="extended">Extended</button>
                            </div>
                            <div class="result-block" id="container-results-inline">‚Äî</div>
                        `;
                        cont.appendChild(sec);
                        // Wire filters and real render
                        sec.querySelectorAll('.filter-toggle').forEach(btn=>{
                            btn.onclick = ()=>{
                                sec.querySelectorAll('.filter-toggle').forEach(b=> b.classList.remove('active'));
                                btn.classList.add('active');
                                // Optional: mirror any legacy filter
                                const orig = document.querySelector(`.container-filter-bar .filter-toggle[data-filter="${btn.dataset.filter}"]`);
                                if (orig) orig.click();
                                if (typeof window.renderContainerChordsInline==='function') window.renderContainerChordsInline();
                            };
                        });
                    }
                    // Explore tab: Mode cards inline
                    const step4 = document.getElementById('step-4'); if (step4){
                        const sec = document.createElement('div'); sec.className='panel-section';
                        sec.innerHTML = `
                            <div class="section-title">Exploration Mode</div>
                            <div class="controls-row">
                                <button class="btn-step" data-explore="progressions">Progressions</button>
                                <button class="btn-step" data-explore="reharmonization">Reharmonization</button>
                                <button class="btn-step" data-explore="voicing">Voicings</button>
                                <button class="btn-step" data-explore="numbers_progression">Numbers‚ÜíProgression</button>
                                <button class="btn-step" data-explore="analysis">Analysis</button>
                            </div>
                            <div class="result-block" id="explore-results-inline" style="min-height:80px">Select a mode to explore.</div>
                        `;
                        step4.appendChild(sec);
                        // Wire mode buttons
                        sec.querySelectorAll('[data-explore]').forEach(btn=>{
                            btn.onclick = ()=>{
                                const orig = document.querySelector(`#step-4 .option-card[data-explore="${btn.dataset.explore}"]`);
                                if (orig) orig.click();
                            };
                        });
                    }
                })();
                // Inline display updater: sync numbers text and piano highlights
                window.__updateInlineNumbersDisplay = function(){
                    try{
                        const nums = (window.AppState?.currentNumbers||[]).slice();
                        const disp = document.getElementById('numbers-display-inline');
                        if (disp) disp.textContent = nums.length? nums.join(', ') : '‚Äî';
                        const notes = (window.MusicTheory?.getScaleNotes?.(AppState.currentKey, AppState.currentScale)) || [];
                        const toName = (v)=> typeof v==='number' && notes.length? notes[( (v-1)%(notes.length)+notes.length)%notes.length] : null;
                        const names = nums.map(toName).filter(Boolean);
                        if (typeof window.renderPianoAccurate==='function') window.renderPianoAccurate(names, {});
                    }catch(_){}
                };
                // Provide robust inline updates (numbers text, piano, container chords)
                if (typeof window.__updateInlineNumbersDisplay !== 'function'){
                    window.__updateInlineNumbersDisplay = function(){
                        try{
                            const nums = (window.AppState?.currentNumbers||[]).slice();
                            const ns = document.getElementById('ns-numbers'); if (ns) ns.textContent = nums.length? nums.join(', ') : '‚Äî';
                            const notes = (window.MusicTheory?.getScaleNotes?.(AppState.currentKey, AppState.currentScale)) || [];
                            const toName = (v)=> typeof v==='number' && notes.length? notes[((v-1)%notes.length+notes.length)%notes.length] : null;
                            const names = nums.map(toName).filter(Boolean);
                            // Render piano in strip container if available
                            if (typeof window.renderPianoAccurate==='function') window.renderPianoAccurate(names, {});
                            if (typeof window.renderContainerChordsInline==='function') window.renderContainerChordsInline();
                        }catch(_){ /* noop */ }
                    };
                }

                if (typeof window.renderContainerChordsInline !== 'function'){
                    window.renderContainerChordsInline = function(){
                        // This function is now handled by updateContainerChordsForSelection
                        // which is called from updateInteractiveTools
                        updateInteractiveTools();
                    };
                }

                // Enhanced chord wheel visualization
                window.renderChordWheel = function(chords, targetNames){
                    // This is now handled by updateChordCircleForSelection
                    // which creates a visual representation of scale degrees
                    updateChordCircleForSelection(targetNames || []);
                };
                // Inject Focus Mode bar
                (function buildFocusBar(){
                    if (document.getElementById('focus-bar')) return;
                    const bar = document.createElement('div'); bar.id='focus-bar';
                    bar.innerHTML = `
                        <button class="fb-btn" id="fb-exit">Exit</button>
                        <button class="fb-btn" id="fb-prev">‚óÄ Back</button>
                        <div class="fb-title" id="fb-title">Numbers</div>
                        <button class="fb-btn" id="fb-next">Next ‚ñ∂</button>
                        <span style="margin-left:auto;opacity:.8;font-size:12px">Shortcuts: F toggle ‚Ä¢ ‚Üê/‚Üí navigate</span>
                    `;
                    document.body.insertBefore(bar, document.body.firstChild);
                })();

                // Focus Mode logic
                const steps = [
                    { id:'step-1', label:'Numbers' },
                    { id:'step-2', label:'Key & Scale' },
                    { id:'container-section', label:'Container Chords' },
                    { id:'step-4', label:'Exploration' },
                    { id:'harmony-orbits', label:'Harmony Orbits' },
                ].filter(s=> document.getElementById(s.id));
                let focusIdx = 0;
                function setFocus(idx){
                    focusIdx = Math.max(0, Math.min(steps.length-1, idx));
                    const active = steps[focusIdx];
                    // Hide all tool windows except the active one
                    document.querySelectorAll('.tool-window').forEach(w=> w.style.display='none');
                    const wrap = document.querySelector(`.tool-window[data-panel-id="${active.id}"]`) || document.getElementById(active.id)?.closest?.('.tool-window');
                    if (wrap){ wrap.style.display=''; }
                    document.body.classList.add('focus-mode');
                    const title = document.getElementById('fb-title'); if (title) title.textContent = active.label;
                    // Ensure panel is visible
                    document.getElementById(active.id)?.scrollIntoView({behavior:'smooth', block:'center'});
                }
                function exitFocus(){ document.body.classList.remove('focus-mode'); document.querySelectorAll('.tool-window').forEach(w=> w.style.display=''); }
                function next(){ setFocus(focusIdx+1); }
                function prev(){ setFocus(focusIdx-1); }
                // Bind buttons
                const fbExit = document.getElementById('fb-exit'); if (fbExit) fbExit.onclick = exitFocus;
                const fbNext = document.getElementById('fb-next'); if (fbNext) fbNext.onclick = next;
                const fbPrev = document.getElementById('fb-prev'); if (fbPrev) fbPrev.onclick = prev;
                // Keyboard shortcuts
                window.addEventListener('keydown', (e)=>{
                    if (e.key==='F' || e.key==='f'){ if (document.body.classList.contains('focus-mode')) exitFocus(); else setFocus(focusIdx); }
                    if (!document.body.classList.contains('focus-mode')) return;
                    if (e.key==='ArrowRight') next(); else if (e.key==='ArrowLeft') prev();
                });
                // Add a toggle in mini-toolbar
                (function addFocusToggle(){
                    const mt = document.getElementById('mini-toolbar'); if (!mt) return;
                    const btn = document.createElement('button'); btn.className='mt-btn'; btn.id='mt-focus'; btn.textContent='Focus';
                    btn.onclick = ()=>{ if (document.body.classList.contains('focus-mode')) exitFocus(); else setFocus(0); };
                    mt.appendChild(btn);
                })();
                // Restore original transform controls to Step 1 if they were moved
                (function restoreTransformButtons(){
                    const container = document.querySelector('#step-1 .step-controls'); if (!container) return;
                    ['btn-retrograde','btn-invert','btn-rot-left','btn-rot-right','rotate-n','btn-rotate-n','invert-axis','btn-randomize'].forEach(id=>{
                        const el = document.getElementById(id); if (el && el.parentElement && el.parentElement.id==='ns-transforms'){ container.appendChild(el); }
                    });
                })();
                // Ensure container chords update after any change
                if (typeof window.updateAllResults === 'function'){
                    const __orig = window.updateAllResults;
                    window.updateAllResults = function(){
                        try{ __orig.apply(this, arguments); }catch(_){ }
                        try{ if (typeof window.renderContainerChordsInline==='function') window.renderContainerChordsInline(); }catch(_){ }
                    };
                }
                // Build sticky mini-toolbar for primary actions
                (function buildMiniToolbar(){
                    if (document.getElementById('mini-toolbar')) return;
                    const bar = document.createElement('div'); bar.id='mini-toolbar';
                    bar.innerHTML = `
                        <button class="mt-btn primary" id="mt-generate">Generate</button>
                        <button class="mt-btn" id="mt-apply">Apply Key/Scale</button>
                        <button class="mt-btn" id="mt-undo">Undo</button>
                        <button class="mt-btn danger" id="mt-clear">Clear</button>
                        <span class="sep"></span>
                        <div class="transform-menu" id="mt-more">
                            <button class="mt-btn" id="mt-more-btn">‚ãØ</button>
                            <div class="tm-panel">
                                <div class="tm-row" id="tm-slot"></div>
                            </div>
                        </div>
                    `;
                    const container = document.querySelector('.container') || document.body;
                    container.parentNode.insertBefore(bar, container);
                    const click = (id)=>{ const el=document.getElementById(id); el&&el.click(); };
                    document.getElementById('mt-generate').onclick = ()=> click('btn-gen-numbers');
                    document.getElementById('mt-apply').onclick = ()=> click('btn-set-keyscale');
                    document.getElementById('mt-undo').onclick = ()=> click('btn-undo-numbers');
                    document.getElementById('mt-clear').onclick = ()=> click('btn-clear-numbers');
                    // Toggle more menu
                    const more=document.getElementById('mt-more');
                    const moreBtn = document.getElementById('mt-more-btn');
                    moreBtn.onclick = ()=> more.classList.toggle('open');
                    document.addEventListener('click', (e)=>{ if (!more.contains(e.target)) more.classList.remove('open'); }, true);
                })();

                // Collapse Step-1 transforms into More menu (non-destructive)
                (function collapseTransforms(){
                    const slot = document.getElementById('tm-slot'); if (!slot) return;
                    const ids = ['btn-retrograde','btn-invert','btn-rot-left','btn-rot-right','rotate-n','btn-rotate-n','invert-axis','btn-randomize'];
                    let moved = 0;
                    ids.forEach(id=>{ const el=document.getElementById(id); if (el){ slot.appendChild(el); moved++; }});
                    if (moved>0){ document.body.classList.add('has-transform-menu'); }
                })();
                const gen=document.getElementById('btn-gen-numbers');
                if (gen && !gen.dataset.fallback){ gen.dataset.fallback='1'; gen.addEventListener('click', function(){
                    const type = document.getElementById('number-type')?.value || 'diatonic';
                    let len = parseInt(document.getElementById('number-seq-len')?.value||'4',10); if (!Number.isFinite(len)||len<1) len=4;
                    const N = scaleLength(); const out=[]; for(let i=0;i<len;i++){ out.push(type==='barry8'? (Math.floor(Math.random()*8)+1) : type==='extended'? (Math.floor(Math.random()*14)+1) : (Math.floor(Math.random()*N)+1)); }
                    AppState.numberType=type; AppState.currentNumbers=out; updateAllResults();
                    // Sync inline display
                    if (typeof window.__updateInlineNumbersDisplay==='function') window.__updateInlineNumbersDisplay();
                }); }
                document.getElementById('btn-set-keyscale').addEventListener('click', function() {
                    const key = document.getElementById('key-select').value;
                    const scale = document.getElementById('scale-select').value;

                    AppState.currentKey = key;
                    AppState.currentScale = scale;
                    AppState.keyScaleSet = true;
                    AppState.completedSteps = [1, 2];

                    // Show scale degrees on piano
                    updateScaleDegreesOnPiano();

                    // Update all results
                    updateAllResults();
                    updateNumberTypeLabels();
                });

                function updateScaleDegreesOnPiano() {
                    const scaleNotes = MusicTheory.getScaleNotes(AppState.currentKey, AppState.currentScale) || [];
                    const scaleNoteNames = scaleNotes.map(note => {
                        // Convert semitones back to note names in the correct octave
                        const noteValue = MusicTheory.noteValues[note];
                        return MusicTheory.chromaticNotes[noteValue];
                    });

                    // Highlight scale degrees on piano with green highlighting
                    const roles = {};
                    scaleNoteNames.forEach(note => {
                        roles[note] = 'key-scale';
                    });

                    renderPianoAccurate(scaleNoteNames, roles);
                    document.getElementById('voicing-label').textContent = `Scale: ${AppState.currentKey} ${AppState.currentScale.replace(/_/g, ' ')}`;
                }
            });
        })();

        // Initialize piano with scale degrees on page load
        updateScaleDegreesOnPiano();
        </script>
    </body>
    </html>
