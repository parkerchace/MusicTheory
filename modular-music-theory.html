<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Music Theory Tools</title>
    <link rel="stylesheet" href="unified-chord-explorer.css">
    <link rel="stylesheet" href="modular-music-theory.css">
    <link rel="stylesheet" href="modular-styles.css">
</head>
<body data-theme="clean-daw">
    <!-- TOP CONTROL DECK - SIMPLIFIED -->
    <div class="control-deck">
        <!-- App Brand -->
        <div class="app-brand" style="display: flex; align-items: center; gap: 8px;">
            <button id="return-to-landing" style="display: flex; flex-direction: column; align-items: center; gap: 2px; background: transparent; border: 1px solid var(--border-light); padding: 6px 12px; cursor: pointer; color: var(--text-main); font-family: var(--font-tech); transition: all 0.2s ease; border-radius: 2px;">
                <span style="font-size: 1.2rem;">üè†</span>
                <span style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px;">Home</span>
            </button>
            <span>THEORY_STUDIO</span>
        </div>
        
        <!-- Primary Input Section -->
        <div class="primary-input-section" style="display:flex; align-items:center; gap:12px;">
            <!-- Input Mode Toggle -->
            <div class="input-mode-toggle" style="display:flex; gap:4px;">
                <button id="input-mode-words" class="input-mode-btn active" title="Word Input Mode">üìù</button>
                <button id="input-mode-numbers" class="input-mode-btn" title="Number Input Mode">üî¢</button>
            </div>
            
            <!-- Main Input Field -->
            <input type="text" id="global-word-input" 
                   class="form-input word-mode-input" 
                   placeholder="Enter words: chase, woods, dark..."
                   style="width:300px; padding:6px 12px; font-size:0.8rem;">
            
            <input type="text" id="global-manual-numbers" 
                   class="form-input number-mode-input" 
                   placeholder="Enter degrees/chords..."
                   style="display:none; width:200px; padding:6px 12px; font-size:0.8rem; text-align:center;">
            
            <!-- Quick Actions -->
            <div class="quick-actions" style="display:flex; gap:6px;">
                <button id="word-randomize-btn" class="btn-icon" title="Randomize">üé≤</button>
                <button id="word-regenerate-btn" class="btn-icon" title="Regenerate">üîÑ</button>
                <button id="word-send-sheet-btn" class="btn-icon" title="To Sheet Music">üéº</button>
            </div>
        </div>
        
        <!-- Grading Mode (Simplified) -->
        <div class="grading-section" style="display:flex; align-items:center; gap:8px;">
            <select id="global-grading-type" class="form-input" style="font-size:0.75rem; padding:4px 8px; min-width:120px;">
                <option value="functional">Functional</option>
                <option value="emotional">Emotional</option>
                <option value="color">Color</option>
            </select>
        </div>
        
        <div style="flex: 1;"></div> <!-- Spacer -->
        
        <!-- Secondary Controls -->
        <div class="secondary-controls" style="display:flex; align-items:center; gap:8px;">
            <!-- Settings Menu -->
            <div class="settings-dropdown" style="position: relative;">
                <button id="settings-dropdown-btn" class="btn-icon" title="Settings & Options">‚öôÔ∏è</button>
                <div id="settings-dropdown-panel" class="tools-dropdown-panel">
                    <!-- Grading Settings -->
                    <div style="padding:8px; border-bottom:1px solid var(--border-light); margin-bottom:8px;">
                        <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:6px;">GRADING INFLUENCE</div>
                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                            <span style="font-size:0.65rem; width:40px;">Visual</span>
                            <input type="range" id="visual-influence" min="0" max="100" value="80" style="width:60px; height:8px;">
                            <span id="visual-influence-value" style="font-size:0.65rem; width:30px;">80%</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span style="font-size:0.65rem; width:40px;">Logic</span>
                            <input type="range" id="behavior-influence" min="0" max="100" value="60" style="width:60px; height:8px;">
                            <span id="behavior-influence-value" style="font-size:0.65rem; width:30px;">60%</span>
                        </div>
                    </div>
                    
                    <!-- Word Analysis Settings -->
                    <div class="module-toggle-item">
                        <button id="word-settings-btn" style="width:100%; text-align:left; background:transparent; border:none; color:var(--text-muted); padding:6px; cursor:pointer;">
                            üìä Word Analysis Settings
                        </button>
                    </div>
                    
                    <!-- Module Toggles -->
                    <div style="border-top:1px solid var(--border-light); margin-top:8px; padding-top:8px;">
                        <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:6px;">MODULES</div>
                        <div class="module-toggle-item">
                            <input type="checkbox" id="toggle-mod-input" data-module="input" checked>
                            <label for="toggle-mod-input">Number Generator</label>
                        </div>
                        <div class="module-toggle-item">
                            <input type="checkbox" id="toggle-mod-ref" data-module="ref" checked>
                            <label for="toggle-mod-ref">Circle of Fifths</label>
                        </div>
                        <div class="module-toggle-item">
                            <input type="checkbox" id="toggle-mod-tool" data-module="tool" checked>
                            <label for="toggle-mod-tool">Container Chord</label>
                        </div>
                        <div class="module-toggle-item">
                            <input type="checkbox" id="toggle-mod-score" data-module="score" checked>
                            <label for="toggle-mod-score">Sheet Music</label>
                        </div>
                        <div class="module-toggle-item">
                            <input type="checkbox" id="toggle-mod-chord" data-module="chord" checked>
                            <label for="toggle-mod-chord">Chord Explorer</label>
                        </div>
                        <div class="module-toggle-item">
                            <input type="checkbox" id="toggle-mod-solar" data-module="solar">
                            <label for="toggle-mod-solar">Solar System</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- View Controls -->
            <button class="btn-icon" id="theme-switcher" title="Theme">üé®</button>
            <button class="btn-icon" id="toggle-layout" title="Layout">‚äû</button>
            
            <!-- Help & Tutorial -->
            <div class="help-dropdown" style="position: relative;">
                <button id="help-dropdown-btn" class="btn-icon" title="Help & Tutorials">?</button>
                <div id="help-dropdown-panel" class="tools-dropdown-panel">
                    <div class="module-toggle-item">
                        <button id="easy-mode-btn" style="width:100%; text-align:left; background:transparent; border:none; color:var(--text-muted); padding:6px; cursor:pointer;">
                            üéì Easy Mode
                        </button>
                    </div>
                    <div class="module-toggle-item">
                        <button id="demo-mode-btn" style="width:100%; text-align:left; background:transparent; border:none; color:var(--text-muted); padding:6px; cursor:pointer;">
                            üí° Demo Mode
                        </button>
                    </div>
                    <div class="module-toggle-item">
                        <button id="grading-tutorial-btn" style="width:100%; text-align:left; background:transparent; border:none; color:var(--text-muted); padding:6px; cursor:pointer;">
                            üìö Grading Tutorial
                        </button>
                    </div>
                    <div class="module-toggle-item">
                        <button id="grading-preview-btn" style="width:100%; text-align:left; background:transparent; border:none; color:var(--text-muted); padding:6px; cursor:pointer;">
                            üëÅÔ∏è Grading Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden elements for compatibility -->
        <div style="display:none;">
            <div id="grading-key-legend"></div>
            <div id="global-undo-btn"></div>
            <div id="global-redo-btn"></div>
            <div id="tools-dropdown-btn"></div>
            <div id="tools-dropdown-panel"></div>
        </div>
    </div>
    

    
    <!-- Tutorial System Elements -->
    <div id="tutorial-overlay" class="tutorial-overlay"></div>
    <div id="tutorial-highlight" class="tutorial-highlight" style="display: none;"></div>
    <div id="tutorial-tooltip" class="tutorial-tooltip">
        <div class="tutorial-tooltip-title" id="tutorial-title"></div>
        <div class="tutorial-tooltip-content" id="tutorial-content"></div>
        <div class="tutorial-tooltip-actions">
            <button class="btn" id="tutorial-skip">Skip Tutorial</button>
            <button class="btn-primary" id="tutorial-next">Next</button>
        </div>
    </div>
    <div id="tutorial-progress" class="tutorial-progress"></div>
    <div id="demo-tooltip" class="demo-tooltip">
        <div class="demo-tooltip-title" id="demo-tooltip-title"></div>
        <div id="demo-tooltip-content"></div>
    </div>

    <!-- Word Analysis Panel -->
    <div id="word-analysis-panel" class="word-analysis-panel">
        <div class="panel-header">
            <span>üìä Word Analysis</span>
            <button id="copy-lexical-log-btn" class="btn-icon" title="Copy lexical analysis log to clipboard" style="font-size: 0.7rem; padding: 2px 8px; margin-right: 8px;">üìã Copy Log</button>
            <button id="debug-log-btn" class="btn-icon" title="Show debug information" style="font-size: 0.7rem; padding: 2px 8px; margin-right: 8px;">üîç Debug</button>
            <button class="btn-icon" onclick="isUserDismissingPanel = true; document.getElementById('word-analysis-panel').classList.remove('active')">‚úï</button>
        </div>
        <div class="panel-content">
            <div id="word-analysis-content">
                <div class="analysis-empty">Enter words above to see analysis...</div>
            </div>
                <!-- Session Log: shows recent translations with quick actions -->
                <div id="lexical-session-log" style="margin-top:12px; border-top:1px solid rgba(255,255,255,0.03); padding-top:8px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;">
                        <div style="font-weight:700; color:var(--accent-primary);">üóÇÔ∏è Session Log</div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button id="export-lexical-log-btn" class="btn" style="font-size:0.75rem; padding:4px 8px;">Export JSON</button>
                            <button id="clear-lexical-log-btn" class="btn" style="font-size:0.75rem; padding:4px 8px;">Clear</button>
                        </div>
                    </div>
                    <div id="lexical-log-list" style="max-height:220px; overflow:auto; padding-right:6px;"></div>
                </div>
        </div>
    </div>

    <!-- Word Settings Panel -->
    <div id="word-settings-panel" class="word-settings-panel">
        <div class="panel-header">
            <span>‚öôÔ∏è Lexical Engine Settings</span>
            <button class="btn-icon" onclick="document.getElementById('word-settings-panel').classList.remove('active')">‚úï</button>
        </div>
        <div class="panel-content">
            <div class="setting-group">
                <label>Emotional Weight</label>
                <input type="range" id="weight-emotional" min="0" max="100" value="30" class="weight-slider">
                <span class="weight-value">30%</span>
            </div>
            <div class="setting-group">
                <label>Syllabic/Rhythm Weight</label>
                <input type="range" id="weight-syllabic" min="0" max="100" value="20" class="weight-slider">
                <span class="weight-value">20%</span>
            </div>
            <div class="setting-group">
                <label>Phonetic/Color Weight</label>
                <input type="range" id="weight-phonetic" min="0" max="100" value="15" class="weight-slider">
                <span class="weight-value">15%</span>
            </div>
            <div class="setting-group">
                <label>Semantic Context Weight</label>
                <input type="range" id="weight-semantic" min="0" max="100" value="25" class="weight-slider">
                <span class="weight-value">25%</span>
            </div>
            <div class="setting-group">
                <label>Archetype Matching Weight</label>
                <input type="range" id="weight-archetype" min="0" max="100" value="10" class="weight-slider">
                <span class="weight-value">10%</span>
            </div>
            <div class="setting-group">
                <button class="btn-primary" id="reset-weights-btn">Reset to Defaults</button>
            </div>
                <div class="setting-group">
                    <label><input type="checkbox" id="weight-aggressive"> Prefer dramatic / darker mappings</label>
                </div>
                <div class="setting-group">
                    <label><input type="checkbox" id="weight-key-variety" checked> Enable dynamic key selection (more variety)</label>
                </div>
                <div class="setting-group">
                    <label><input type="checkbox" id="weight-auto-send" checked> Auto-send to sheet music (immediate playback)</label>
                </div>
                <div class="setting-group" style="font-size: 0.7rem; opacity: 0.7; line-height: 1.3;">
                    <strong>Weight Guide:</strong><br>
                    ‚Ä¢ <strong>Emotional</strong>: Valence/arousal drive mode & key brightness<br>
                    ‚Ä¢ <strong>Semantic</strong>: Word meaning influences scale/chord choices<br>
                    ‚Ä¢ <strong>Phonetic</strong>: Sound color affects voicing & extensions<br>
                    ‚Ä¢ <strong>Syllabic</strong>: Rhythm patterns from word structure<br>
                    ‚Ä¢ <strong>Archetype</strong>: Pre-built phrase patterns boost
                </div>
        </div>
    </div>

    <!-- LANDING PAGE / MODULE SELECTOR -->
    <div id="landing-page" class="landing-page" style="display: none; width: 100%; height: 100vh; overflow-y: auto; background: var(--bg-app); padding: 20px; box-sizing: border-box;">
        <div style="max-width: 1200px; margin: 0 auto; position: relative;">
            <!-- Theme Toggle (Top Right) -->
            <button id="landing-theme-toggle" style="position: absolute; top: -10px; right: 0; background: transparent; border: 1px solid var(--border-light); padding: 8px 14px; cursor: pointer; color: var(--text-main); font-family: var(--font-tech); transition: all 0.2s ease; border-radius: 4px; font-size: 1.1rem;" title="Change Theme">
                üé®
            </button>
            
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 40px;">
                <h1 style="font-size: 2.5rem; color: var(--text-main); margin: 0 0 10px 0;">Music Theory Studio</h1>
                <p style="color: var(--text-muted); font-size: 1rem; margin: 0;">Select your learning path or dive into the full workspace</p>
            </div>

            <!-- Intent Search Bar -->
            <div style="margin-bottom: 30px; text-align: center;">
                <input type="text" id="intent-search" placeholder="What do you want to do? (e.g., 'learn scales', 'improvise', 'reharmonize')" 
                    style="width: 90%; max-width: 500px; padding: 12px 16px; background: var(--bg-panel); border: 1px solid var(--border-light); color: var(--text-main); border-radius: 4px; font-family: var(--font-ui); font-size: 0.95rem;">
                <div id="intent-results" style="margin-top: 15px; color: var(--text-muted); font-size: 0.85rem; min-height: 20px;"></div>
            </div>

            <!-- Instrument Preference Selector -->
            <div id="instrument-selector" style="display: flex; justify-content: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
                <span style="color: var(--text-muted); align-self: center; font-size: 0.9rem;">Visualize on:</span>
                <button class="instrument-btn" data-instrument="piano" style="padding: 10px 20px; background: var(--accent-primary); color: #000; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">üéπ Piano</button>
                <button class="instrument-btn" data-instrument="guitar" style="padding: 10px 20px; background: transparent; border: 2px solid var(--accent-primary); color: var(--text-main); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">üé∏ Guitar</button>
            </div>

            <!-- Skill Level Selector -->
            <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 40px; flex-wrap: wrap;">
                <button class="skill-level-btn" data-level="beginner" style="padding: 10px 20px; background: var(--accent-primary); color: #000; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">Beginner</button>
                <button class="skill-level-btn" data-level="intermediate" style="padding: 10px 20px; background: transparent; border: 2px solid var(--accent-primary); color: var(--text-main); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">Intermediate</button>
                <button class="skill-level-btn" data-level="advanced" style="padding: 10px 20px; background: transparent; border: 2px solid var(--accent-primary); color: var(--text-main); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">Advanced</button>
                <button class="skill-level-btn" data-level="all" style="padding: 10px 20px; background: transparent; border: 2px solid var(--accent-secondary); color: var(--text-main); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">Show All</button>
            </div>

            <!-- Beginner Path -->
            <div id="beginner-section" style="display: block; text-align: center; padding: 30px; background: rgba(52, 211, 153, 0.1); border: 2px solid var(--accent-secondary); border-radius: 8px; margin-bottom: 40px;">
                <h3 style="color: var(--text-main); margin-top: 0;">üéπ Start Here: Learn Music Fundamentals</h3>
                <p style="color: var(--text-muted); margin: 0 0 20px 0; font-size: 0.9rem;">Master the basics with structured, interactive lessons before exploring the full studio.</p>
                <button id="launch-learn-piano-btn" style="padding: 12px 30px; background: var(--accent-secondary); color: #000; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.95rem;">Learn Piano Notes</button>
                <div style="margin-top: 18px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
                    <button id="launch-learn-scales-btn" style="padding: 10px 24px; background: transparent; border: 2px solid var(--accent-secondary); color: var(--text-main); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">Learn Scales</button>
                    <button id="launch-learn-chords-btn" style="padding: 10px 24px; background: transparent; border: 2px solid var(--accent-secondary); color: var(--text-main); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">Learn Chords</button>
                    <button id="launch-learn-inversions-btn" style="padding: 10px 24px; background: transparent; border: 2px solid var(--accent-primary); color: var(--text-highlight); cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem;">Learn Inversions</button>
                </div>
            </div>

            <!-- Module Grid -->
            <div id="module-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
                <!-- Modules will be populated here by JavaScript -->
            </div>

            <!-- Ready to Dive In -->
            <div style="text-align: center; padding: 30px; background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border-light); border-radius: 4px;">
                <h3 style="color: var(--text-main); margin-top: 0;">Ready to dive in?</h3>
                <p style="color: var(--text-muted); margin: 0 0 20px 0; font-size: 0.9rem;">Select modules above to customize your experience, or launch the full studio.</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button id="launch-selected-btn" style="padding: 12px 30px; background: var(--accent-secondary); color: #000; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.95rem; display: none;">Launch Selected Modules</button>
                    <button id="launch-workspace-btn" style="padding: 12px 30px; background: var(--accent-primary); color: #000; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.95rem;">Launch Full Studio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LEARN PIANO VIEW (separate from full studio) -->
    <div id="learn-piano-page" style="display:none; padding: 14px; overflow:auto;">
        <div id="learn-piano-notes-container"></div>
    </div>

    <!-- LEARN SCALES VIEW (separate from full studio) -->
    <div id="learn-scales-page" style="display:none; padding: 14px; overflow:auto;">
        <div id="learn-scales-container"></div>
    </div>

    <!-- LEARN CHORDS VIEW (separate from full studio) -->
    <div id="learn-chords-page" style="display:none; padding: 14px; overflow:auto;">
        <div id="learn-chords-container"></div>
    </div>

    <!-- LEARN INVERSIONS VIEW (separate from full studio) -->
    <div id="learn-inversions-page" style="display:none; padding: 14px; overflow:auto;">
        <div id="learn-inversions-container"></div>
    </div>

    <!-- MAIN WORKSPACE -->
    <div class="workspace">
        <!-- LEFT SIDEBAR: GENERATOR & REFERENCE -->
        <div class="workspace-column left-sidebar">
            <div class="studio-module mod-input">
                <div class="module-header">
                    <span>INPUT::NUMBER_GEN</span>
                    <button class="btn-icon" onclick="document.getElementById('number-generator-container').classList.toggle('collapsed')">[-]</button>
                </div>
                <div class="module-content">
                    <div id="number-generator-container"></div>
                </div>
            </div>

            <div class="studio-module mod-input">
                <div class="module-header">
                    <span>CONTEXT::KEY_SCALE</span>
                    <button class="btn-icon" onclick="document.getElementById('scale-library-container').classList.toggle('collapsed')">[-]</button>
                </div>
                <div class="module-content">
                    <div id="scale-library-container"></div>
                </div>
            </div>

            <div class="studio-module mod-ref">
                <div class="module-header">
                    <span>REF::CIRCLE_OF_FIFTHS</span>
                </div>
                <div class="module-content">
                    <div id="scale-circle-container"></div>
                </div>
            </div>

            <div class="studio-module mod-tool fill-height">
                <div class="module-header">
                    <span>TOOL::CONTAINER_CHORD</span>
                </div>
                <div class="module-content">
                    <div id="container-chord-container"></div>
                </div>
            </div>

            <div class="studio-module mod-tool fill-height">
                <div class="module-header">
                    <span>TOOL::SCALE_RELATIONSHIPS</span>
                </div>
                <div class="module-content">
                    <div id="scale-relationship-container"></div>
                </div>
            </div>

                <!-- LearnPianoNotes module removed - connectors now integrated into main piano -->
        </div>

        <!-- CENTER STAGE: COMPOSITION -->
        <div class="workspace-column center-stage">
            <!-- Mini Chord Strip (Sticky) -->
            <div id="mini-chord-strip" class="mini-chord-strip" style="position: sticky; top: 0; z-index: 5; margin: 0; padding: 8px 12px; background: rgba(0,0,0,0.9); border-bottom: 1px solid var(--border-light);"></div>

            <div class="studio-module mod-score">
                <div class="module-header">
                    <span>VISUAL::SHEET_MUSIC</span>
                    <button class="btn-icon">[PRINT]</button>
                </div>
                <div class="module-content">
                    <div id="sheet-music-container">
                        <!-- Backwards-compatible alias for piano connectors -->
                        <div id="piano-sheet-music"></div>
                    </div>
                </div>
            </div>

            <div class="studio-module mod-db">
                <div class="module-header">
                    <span>DB::CHORD_EXPLORER</span>
                    <button class="btn-icon">[OPTS]</button>
                </div>
                <div class="module-content" style="padding: 5px;">
                    <div id="chord-explorer-container"></div>
                </div>
            </div>

            <div class="studio-module mod-prog">
                <div class="module-header">
                    <span>SEQ::PROGRESSION_BUILDER</span>
                </div>
                <div class="module-content" style="padding: 8px;">
                    <div id="progression-builder-container"></div>
                </div>
            </div>
            
            <div class="studio-module mod-solar">
                <div class="module-header">
                    <span>SYS::SOLAR_VISUALIZER</span>
                    <button class="btn-icon" id="dock-solar">[UNDOCK]</button>
                </div>
                <div class="module-content" style="padding: 0; min-height: 300px; position: relative;">
                    <div id="solar-dock-viewport" style="width: 100%; min-height: 300px;"></div>
                    <!-- Hidden sun container for logic -->
                    <div class="sun" style="display: none;"><div id="sun-viewport"></div></div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDEBAR: TOOLS -->
        <div class="workspace-column right-sidebar">
            <div class="studio-module mod-ref">
                <div class="module-header">
                    <span>REF::GRADING_KEY</span>
                </div>
                <div class="module-content" id="grading-key-sidebar">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="studio-module mod-ref">
                <div class="module-header">
                    <span>VISUAL::GUITAR_FRETBOARD</span>
                </div>
                <div class="module-content">
                    <div id="guitar-fretboard-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTTOM DECK: PIANO -->
    <div class="bottom-deck">
        <div class="bottom-deck-label">
            <span class="deck-icon">üéπ</span>
            <span class="deck-title">PIANO VISUALIZER</span>
            <span class="deck-status" id="piano-deck-status">READY</span>
        </div>
        <div id="piano-wrapper" style="position: relative; display: flex; flex-direction: column; gap: 4px;">
            <!-- Piano Container -->
            <div id="piano-container"></div>
        </div>
    </div>

    <!-- Hidden/Utility Containers -->
    <div id="mini-piano-visualize-container" style="display: none;"></div>
    <div id="solar-docked-module" class="hidden"></div> <!-- Logic placeholder -->

    <!-- Module Scripts -->
        <style>
            /* Remove leftover mini solar containers */
            #solar-condensed, #solar-under-grading, .solar-condensed { display: none !important; }
            /* Keep grading sidebar compact and scrollable so it doesn't push layout */
            #grading-key-sidebar { max-height: 48vh; overflow: auto; font-size: 0.9rem; }
            #grading-key-sidebar .module-header { font-size: 0.78rem; }
        </style>
    <script src="music-theory-engine.js?v=3"></script>
    <script src="word-database.js"></script>
    
    <!-- NEW: Comprehensive Scale Intelligence System -->
    <script src="scale-intelligence-engine.js"></script>
    
    <!-- NEW: Generative Word-to-Music System -->
    <!-- <script src="phonetic-analyzer.js"></script> -->
    <script src="learn-inversions.js"></script>
    <script src="chord-attribute-engine.js"></script>
    <script src="semantic-api-engine.js"></script>
    <script src="voice-leading-engine.js"></script>
    <script src="learn-piano-notes.js"></script>
    <script src="learn-scales.js"></script>
    <script src="learn-chords.js"></script>
    <!-- <script src="generative-word-mapper.js"></script> -->
    
    <script src="simple-word-engine.js?v=5"></script>
    <script src="sheet-music-generator.js"></script>
    <script src="number-generator.js"></script>
    <script src="scale-library.js"></script>
    <script src="piano-visualizer.js?v=2"></script>
    <script src="guitar-fretboard-visualizer.js"></script>
    <script src="container-chord-tool.js"></script>
    <script src="scale-relationship-explorer.js"></script>
    <script src="progression-builder.js"></script>
    <script src="scale-circle-explorer.js"></script>
    <script src="solar-system-visualizer.v2.js"></script>
    <script src="audio-visualizer.js"></script>
    <script src="unified-chord-explorer.js"></script>
    <script src="module-selector.js"></script>
    <!-- <script src="grading-legend-help-system.js"></script> -->
    <!-- <script src="word-grading-visualization.js"></script> -->
    <script src="bitwig-midi.js"></script>
    
    <!-- Modular components extracted from inline code -->
    <script src="chord-explorer-inline.js"></script>
    <script src="simple-audio-engine.js"></script>
    <script src="enhanced-audio-engine.js"></script>
    <script src="scale-helper.js"></script>
    <script src="piano-sample-engine.js"></script>
    <script src="midi-input-manager.js"></script>
    <script src="theme-switcher.js" defer></script>
    <script src="tutorial-system.js" defer></script>
    <script src="lexical-integration.js" defer></script>

    <script src="modular-app.js" defer></script>
    <script>
(function() {
    // Interaction log buffer
    window.__interactionLog = window.__interactionLog || [];
    function logInteraction(type, details) {
        const entry = {
            type,
            details,
            timestamp: new Date().toISOString()
        };
        window.__interactionLog.push(entry);
        console.log('[InteractionLog]', entry);
    }
    // Handle clicks outside word input to dismiss panel
    document.addEventListener('click', function(e) {
        const wordInput = document.getElementById('global-word-input');
        const analysisPanel = document.getElementById('word-analysis-panel');
        
        // If clicking outside word input and analysis panel, mark as dismissing
        if (wordInput && analysisPanel && 
            !wordInput.contains(e.target) && 
            !analysisPanel.contains(e.target) &&
            analysisPanel.classList.contains('active')) {
            isUserDismissingPanel = true;
        }
    });
    
    // Click logger
    document.addEventListener('click', function(e) {
        let target = e.target;
        let info = {
            tag: target.tagName,
            id: target.id,
            class: target.className,
            text: target.innerText,
            value: target.value || null
        };
        logInteraction('click', info);
    }, true);
    // Key logger (skip manual input which has its own richer logger)
    document.addEventListener('keydown', function(e) {
        try {
            if (e.target && e.target.id === 'manual-numbers') return; // manual input logged separately
            logInteraction('keydown', {
                key: e.key,
                code: e.code,
                target: e.target.tagName,
                id: e.target.id,
                value: e.target.value || null
            });
        } catch (err) { console.warn('key logger failed', err); }
    }, true);
    // Error logger
    window.addEventListener('error', function(e) {
        logInteraction('error', {
            message: e.message,
            filename: e.filename,
            lineno: e.lineno,
            colno: e.colno,
            error: e.error ? e.error.stack : null
        });
    });
    // Chord commit logger (for ModularMusicTheoryApp)
    window.addEventListener('chordCommitted', function(e) {
        // If a richer UI logger already recorded this commit, skip duplicate
        try {
            if (e.detail && e.detail._loggedByUI) return;
        } catch (_) {}
        logInteraction('chordCommitted', e.detail);
    });
    // Explorer action logger
    window.addEventListener('explorerAction', function(e) {
        logInteraction('explorerAction', e.detail);
    });
    // Sheet music state logger
    window.addEventListener('sheetMusicUpdated', function(e) {
        logInteraction('sheetMusicUpdated', e.detail);
    });
    // Save log to file (File System Access API or download)
    async function saveLogToFile() {
        const logStr = JSON.stringify(window.__interactionLog, null, 2);
        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'interaction-log.json',
                    types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
                });
                const writable = await handle.createWritable();
                await writable.write(logStr);
                await writable.close();
                logInteraction('save', { method: 'FileSystemAccessAPI', success: true });
            } catch (err) {
                logInteraction('save', { method: 'FileSystemAccessAPI', success: false, error: err });
            }
        } else {
            const blob = new Blob([logStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'interaction-log.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 1000);
            logInteraction('save', { method: 'download', success: true });
        }
    }
    window.addEventListener('DOMContentLoaded', function() {
        const btn = document.createElement('button');
        btn.innerText = 'üíæ';
        btn.title = 'Save Interaction Log';
        btn.style.position = 'fixed';
        btn.style.top = '8px';
        btn.style.right = '12px';
        btn.style.zIndex = 9999;
        btn.style.background = 'rgba(0, 0, 0, 0.6)';
        btn.style.color = 'var(--accent-primary)';
        btn.style.border = '1px solid var(--border-light)';
        btn.style.borderRadius = '0';
        btn.style.padding = '4px 8px';
        btn.style.fontSize = '14px';
        btn.style.cursor = 'pointer';
        btn.style.opacity = '0.5';
        btn.style.transition = 'opacity 0.2s ease';
        btn.onmouseenter = () => btn.style.opacity = '1';
        btn.onmouseleave = () => btn.style.opacity = '0.5';
        btn.onclick = saveLogToFile;
        document.body.appendChild(btn);
    });
    // Utility: fire custom events from app code
    window.logChordCommit = function(detail) {
        // Log UI state at chord commit
        const chordNames = Array.from(document.querySelectorAll('div.chord-name')).map(e => e.textContent);
        const chordCards = Array.from(document.querySelectorAll('div.chord-card')).map(e => e.textContent);
        const sheetMusicSVG = Array.from(document.querySelectorAll('div.sheet-music-svg-host')).map(e => e.innerHTML);
        if (!window.__interactionLog) window.__interactionLog = [];
        try { detail = Object.assign({}, detail, { _loggedByUI: true }); } catch(_) {}
        window.__interactionLog.push({
            type: 'chordCommitted',
            details: detail,
            uiState: {
                chordNames,
                chordCards,
                sheetMusicSVG
            },
            timestamp: new Date().toISOString()
        });
        console.debug('[InteractionLog][UI] chordCommitted logged with uiState', { chordNames, chordCards, sheetMusicSVG });
        window.dispatchEvent(new CustomEvent('chordCommitted', { detail }));
    };
    // Preview tokens logger (used during manual typing/preview)
    window.logPreviewTokens = function(detail) {
        // Capture UI state at preview time
        const chordNames = Array.from(document.querySelectorAll('div.chord-name')).map(e => e.textContent);
        const chordCards = Array.from(document.querySelectorAll('div.chord-card')).map(e => e.textContent);
        const sheetMusicSVG = Array.from(document.querySelectorAll('div.sheet-music-svg-host')).map(e => e.innerHTML);
        if (!window.__interactionLog) window.__interactionLog = [];
        window.__interactionLog.push({
            type: 'previewTokens',
            details: detail,
            uiState: {
                chordNames,
                chordCards,
                sheetMusicSVG
            },
            timestamp: new Date().toISOString()
        });
        console.debug('[InteractionLog][UI] previewTokens logged', { detail, chordNames, chordCards });
        try { window.dispatchEvent(new CustomEvent('previewTokens', { detail })); } catch(_) {}
    };
    window.logExplorerAction = function(detail) {
        window.dispatchEvent(new CustomEvent('explorerAction', { detail }));
    };
    window.logSheetMusicUpdate = function(detail) {
        window.dispatchEvent(new CustomEvent('sheetMusicUpdated', { detail }));
    };
    // Also log manual input changes (keydown) with UI state
    const manualInput = document.getElementById('manual-numbers');
    if (manualInput) {
        manualInput.addEventListener('keydown', function(e) {
            const chordNames = Array.from(document.querySelectorAll('div.chord-name')).map(el => el.textContent);
            const chordCards = Array.from(document.querySelectorAll('div.chord-card')).map(el => el.textContent);
            const sheetMusicSVG = Array.from(document.querySelectorAll('div.sheet-music-svg-host')).map(el => el.innerHTML);
            if (!window.__interactionLog) window.__interactionLog = [];
            const kdDetail = { key: e.key, code: e.code, target: e.target.tagName, id: e.target.id, value: e.target.value };
            try { kdDetail._loggedByUI = true; } catch(_) {}
            window.__interactionLog.push({
                type: 'keydown',
                details: kdDetail,
                uiState: {
                    chordNames,
                    chordCards,
                    sheetMusicSVG
                },
                timestamp: new Date().toISOString()
            });
            console.debug('[InteractionLog][UI] manual keydown logged', kdDetail, { chordNames, chordCards });
        });
    }

    // ==================== THEME SWITCHER ====================
    const themeSwitcher = document.getElementById('theme-switcher');
    const themeNames = ['clean-daw', 'channel-strip', 'matrix-fx', 'steam-2000'];
    const themeLabels = {
        'clean-daw': 'Clean DAW',
        'channel-strip': 'Channel Strip',
        'matrix-fx': 'Matrix FX',
        'steam-2000': 'Steam 2000'
    };
    
    // Load saved theme or use default
    let currentThemeIndex = 0;
    const savedTheme = localStorage.getItem('music-theory-theme');
    if (savedTheme && themeNames.includes(savedTheme)) {
        currentThemeIndex = themeNames.indexOf(savedTheme);
        document.body.setAttribute('data-theme', savedTheme);
    }
    
    // Update button text to show current theme
    themeSwitcher.textContent = `[${themeLabels[themeNames[currentThemeIndex]]}]`;
    
    // Cycle through themes on click
    themeSwitcher.addEventListener('click', () => {
        currentThemeIndex = (currentThemeIndex + 1) % themeNames.length;
        const newTheme = themeNames[currentThemeIndex];
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('music-theory-theme', newTheme);
        themeSwitcher.textContent = `[${themeLabels[newTheme]}]`;
        console.log('Theme switched to:', newTheme);
    });
    
    // Setup landing page theme button
    const landingThemeBtn = document.getElementById('landing-theme-toggle');
    if (landingThemeBtn) {
        landingThemeBtn.addEventListener('click', () => {
            currentThemeIndex = (currentThemeIndex + 1) % themeNames.length;
            const newTheme = themeNames[currentThemeIndex];
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('music-theory-theme', newTheme);
            themeSwitcher.textContent = `[${themeLabels[newTheme]}]`;
            console.log('Theme switched to:', newTheme);
        });
    }
})();

// ==================== TUTORIAL SYSTEM ====================
(function() {
    'use strict';
    
    const tutorialSteps = [
        {
            title: 'Welcome to Music Theory Studio',
            content: 'This tool helps you learn music theory step by step. Let\'s start with the basics: scales are collections of notes that sound good together.',
            target: '#scale-library-container',
            action: null
        },
        {
            title: 'Step 1: Choose Your Scale',
            content: 'Start with C Major - the simplest scale with no sharps or flats. Click the dropdown and select "C Major" to begin.',
            target: '#scale-library-container',
            action: () => {
                // Highlight scale dropdown
            }
        },
        {
            title: 'Step 2: See the Notes',
            content: 'Look at the Circle of Fifths on the left. The highlighted notes show which notes are in your chosen scale. C Major has: C, D, E, F, G, A, B.',
            target: '#scale-circle-container',
            action: null
        },
        {
            title: 'Step 3: Generate Numbers',
            content: 'Music uses numbers (degrees) to represent scale positions. Try the Number Generator to create a simple melody pattern like "1-3-5-1".',
            target: '#number-generator-container',
            action: null
        },
        {
            title: 'Step 4: Build Chords',
            content: 'Chords are multiple notes played together. The Sheet Music area shows chords built from your scale. These are the building blocks of harmony.',
            target: '[data-module="score"]',
            action: null
        },
        {
            title: 'Step 5: Play It',
            content: 'Click on the piano keys below to hear your scale and chords. The highlighted keys show which notes belong to your current scale.',
            target: '#piano-container',
            action: null
        },
        {
            title: 'Step 6: Explore Progressions',
            content: 'Try the manual input box at the top. Type chord numbers like "1 4 5 1" to create a classic chord progression. Press Enter to hear it!',
            target: '#global-manual-numbers',
            action: null
        },
        {
            title: 'You\'re Ready!',
            content: 'Now you understand the basics! Enable Demo Mode (button at top) to see explanations when you hover over any tool. Happy composing!',
            target: '#demo-mode-btn',
            action: null
        }
    ];
    
    const demoTooltips = {
        '#scale-library-container': {
            title: 'Scale Selector',
            content: 'Choose from hundreds of scales across different musical traditions. Each scale has a unique character and emotional quality.'
        },
        '#scale-circle-container': {
            title: 'Circle of Fifths',
            content: 'Visual reference showing all 12 notes. Highlighted notes belong to your current scale. Adjacent scales are closely related.'
        },
        '#number-generator-container': {
            title: 'Number Generator',
            content: 'Create melodies and progressions using scale degrees. Use patterns, random generation, or manual input to explore musical ideas.'
        },
        '#container-chord-container': {
            title: 'Container Chord Tool',
            content: 'Find what scales contain specific chords. Great for understanding chord-scale relationships and harmonic possibilities.'
        },
        '[data-module="score"]': {
            title: 'Sheet Music Generator',
            content: 'Visual notation of your progression. Shows chord symbols, staff notation, and harmonic analysis. Export as MIDI for your DAW.'
        },
        '[data-module="chord"]': {
            title: 'Chord Explorer',
            content: 'Interactive map of all diatonic chords in your scale. Click to hear, see voice leadings, and understand functional harmony.'
        },
        '#piano-container': {
            title: 'Piano Visualizer',
            content: 'Click keys to play notes and chords. Highlighted keys show your current scale. Visual feedback helps connect theory to sound.'
        },
        '#global-manual-numbers': {
            title: 'Manual Chord Input',
            content: 'Type chord progressions directly: "1 4 5 1" or "Cmaj7 Fmaj7". Supports Roman numerals, numbers, and chord symbols.'
        },
        '#global-grading-type': {
            title: 'Grading View',
            content: 'Change how chords are colored: Functional (tonic/dominant), Emotional (happy/sad), or Color (synesthesia-inspired).'
        },
        '#theme-switcher': {
            title: 'Theme Switcher',
            content: 'Cycle through visual themes: Clean DAW, Channel Strip, Matrix FX, or Steam 2000. Find your preferred workspace aesthetic.'
        },
        '#toggle-layout': {
            title: 'Layout Toggle',
            content: 'Switch between column layout and grid layout. Grid mode lets you drag-and-drop modules to customize your workspace.'
        },
        '.module-toggle-item': {
            title: 'Module Visibility',
            content: 'Show or hide individual modules. Customize your workspace to focus on the tools you\'re currently using.'
        }
    };
    
    let currentStep = 0;
    let easyModeActive = false;
    let demoModeActive = false;
    
    const overlay = document.getElementById('tutorial-overlay');
    const highlight = document.getElementById('tutorial-highlight');
    const tooltip = document.getElementById('tutorial-tooltip');
    const tooltipTitle = document.getElementById('tutorial-title');
    const tooltipContent = document.getElementById('tutorial-content');
    const progress = document.getElementById('tutorial-progress');
    const nextBtn = document.getElementById('tutorial-next');
    const skipBtn = document.getElementById('tutorial-skip');
    const demoTooltip = document.getElementById('demo-tooltip');
    const demoTooltipTitle = document.getElementById('demo-tooltip-title');
    const demoTooltipContent = document.getElementById('demo-tooltip-content');
    
    const easyModeBtn = document.getElementById('easy-mode-btn');
    const demoModeBtn = document.getElementById('demo-mode-btn');
    
    // Easy Mode Button
    easyModeBtn.addEventListener('click', () => {
        easyModeActive = !easyModeActive;
        
        if (easyModeActive) {
            startTutorial();
            easyModeBtn.style.color = 'var(--accent-secondary)';
            easyModeBtn.style.borderColor = 'var(--accent-secondary)';
            
            // Add badge
            if (!document.querySelector('.easy-mode-badge')) {
                const badge = document.createElement('div');
                badge.className = 'easy-mode-badge';
                badge.textContent = 'Easy Mode Active';
                document.body.appendChild(badge);
            }
        } else {
            stopTutorial();
            easyModeBtn.style.color = '';
            easyModeBtn.style.borderColor = '';
            
            const badge = document.querySelector('.easy-mode-badge');
            if (badge) badge.remove();
        }
    });
    
    // Demo Mode Button
    demoModeBtn.addEventListener('click', () => {
        demoModeActive = !demoModeActive;
        
        if (demoModeActive) {
            enableDemoMode();
            demoModeBtn.style.color = 'var(--accent-primary)';
            demoModeBtn.style.borderColor = 'var(--accent-primary)';
            
            // Add badge
            if (!document.querySelector('.demo-mode-badge')) {
                const badge = document.createElement('div');
                badge.className = 'demo-mode-badge';
                badge.textContent = 'Demo Mode Active';
                document.body.appendChild(badge);
            }
        } else {
            disableDemoMode();
            demoModeBtn.style.color = '';
            demoModeBtn.style.borderColor = '';
            
            const badge = document.querySelector('.demo-mode-badge');
            if (badge) badge.remove();
        }
    });
    
    function startTutorial() {
        currentStep = 0;
        showTutorialStep();
    }
    
    function stopTutorial() {
        overlay.classList.remove('active');
        highlight.style.display = 'none';
        tooltip.classList.remove('active');
        progress.classList.remove('active');
        easyModeActive = false;
    }
    
    function showTutorialStep() {
        if (currentStep >= tutorialSteps.length) {
            stopTutorial();
            return;
        }
        
        const step = tutorialSteps[currentStep];
        
        // Update content
        tooltipTitle.textContent = step.title;
        tooltipContent.textContent = step.content;
        
        // Update progress
        progress.textContent = `Step ${currentStep + 1} of ${tutorialSteps.length}`;
        progress.classList.add('active');
        
        // Show overlay
        overlay.classList.add('active');
        tooltip.classList.add('active');
        
        // Highlight target element
        if (step.target) {
            const target = document.querySelector(step.target);
            if (target) {
                const rect = target.getBoundingClientRect();
                highlight.style.display = 'block';
                highlight.style.left = rect.left + 'px';
                highlight.style.top = rect.top + 'px';
                highlight.style.width = rect.width + 'px';
                highlight.style.height = rect.height + 'px';
                
                // Position tooltip near target
                positionTooltip(tooltip, rect);
                
                // Allow clicking through overlay on target
                target.style.position = 'relative';
                target.style.zIndex = '10000';
            }
        }
        
        // Execute action if any
        if (step.action) {
            step.action();
        }
        
        // Update button text
        if (currentStep === tutorialSteps.length - 1) {
            nextBtn.textContent = 'Finish';
        } else {
            nextBtn.textContent = 'Next';
        }
    }
    
    function positionTooltip(tooltip, targetRect) {
        const tooltipRect = tooltip.getBoundingClientRect();
        const padding = 20;
        
        // Try to position to the right
        let left = targetRect.right + padding;
        let top = targetRect.top;
        
        // If doesn't fit on right, try left
        if (left + tooltipRect.width > window.innerWidth) {
            left = targetRect.left - tooltipRect.width - padding;
        }
        
        // If doesn't fit on left either, position below
        if (left < 0) {
            left = targetRect.left;
            top = targetRect.bottom + padding;
        }
        
        // Keep within viewport
        left = Math.max(padding, Math.min(left, window.innerWidth - tooltipRect.width - padding));
        top = Math.max(padding, Math.min(top, window.innerHeight - tooltipRect.height - padding));
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
    }
    
    nextBtn.addEventListener('click', () => {
        // Reset previous target z-index
        const prevStep = tutorialSteps[currentStep];
        if (prevStep && prevStep.target) {
            const prevTarget = document.querySelector(prevStep.target);
            if (prevTarget) {
                prevTarget.style.zIndex = '';
            }
        }
        
        currentStep++;
        showTutorialStep();
    });
    
    skipBtn.addEventListener('click', () => {
        stopTutorial();
    });
    
    // Demo Mode: Hover tooltips
    function enableDemoMode() {
        Object.keys(demoTooltips).forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                el.addEventListener('mouseenter', handleDemoHover);
                el.addEventListener('mouseleave', handleDemoLeave);
            });
        });
    }
    
    function disableDemoMode() {
        Object.keys(demoTooltips).forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                el.removeEventListener('mouseenter', handleDemoHover);
                el.removeEventListener('mouseleave', handleDemoLeave);
            });
        });
        demoTooltip.classList.remove('show');
    }
    
    function handleDemoHover(e) {
        const el = e.currentTarget;
        
        // Find matching tooltip data
        let tooltipData = null;
        for (const selector in demoTooltips) {
            if (el.matches(selector)) {
                tooltipData = demoTooltips[selector];
                break;
            }
        }
        
        if (!tooltipData) return;
        
        demoTooltipTitle.textContent = tooltipData.title;
        demoTooltipContent.textContent = tooltipData.content;
        
        // Position tooltip
        const rect = el.getBoundingClientRect();
        let left = rect.right + 10;
        let top = rect.top;
        
        // Keep within viewport
        if (left + 300 > window.innerWidth) {
            left = rect.left - 310;
        }
        if (left < 10) {
            left = rect.left;
            top = rect.bottom + 10;
        }
        
        demoTooltip.style.left = left + 'px';
        demoTooltip.style.top = top + 'px';
        demoTooltip.classList.add('show');
    }
    
    function handleDemoLeave() {
        demoTooltip.classList.remove('show');
    }
    
    // Check if user is first-time visitor
    const hasVisited = localStorage.getItem('music-theory-visited');
    if (!hasVisited) {
        setTimeout(() => {
            if (confirm('Welcome! Would you like a guided tour to learn the basics?')) {
                easyModeActive = true;
                startTutorial();
                easyModeBtn.style.color = 'var(--accent-secondary)';
                easyModeBtn.style.borderColor = 'var(--accent-secondary)';
                
                const badge = document.createElement('div');
                badge.className = 'easy-mode-badge';
                badge.textContent = 'Easy Mode Active';
                document.body.appendChild(badge);
            }
            localStorage.setItem('music-theory-visited', 'true');
        }, 1000);
    }

    // ========================================
    // LEXICAL MUSIC ENGINE INTEGRATION
    // ========================================
    
    // Initialize simple word engine
    let lexicalEngine = null;
    let lexicalWeights = {
        emotional: 0.30,
        syllabic: 0.20,
        phonetic: 0.15,
        semantic: 0.25,
        archetype: 0.10
    };
    let lexicalSettings = {
        aggressiveMapping: false,
        keyVariety: true,  // Enable dynamic key selection by default
        autoSend: true     // Auto-send to sheet music by default
    };
    
    // Global undo/redo history
    let globalHistory = [];
    let globalHistoryIndex = -1;
    const MAX_HISTORY = 50;

    // Wait for MusicTheoryEngine to be ready
    function initLexicalSystem() {
        if (typeof MusicTheoryEngine === 'undefined' || typeof SimpleWordEngine === 'undefined') {
            console.warn('[LexicalIntegration] Waiting for engine classes...');
            setTimeout(initLexicalSystem, 100);
            return;
        }
        
        try {
            const musicTheory = new MusicTheoryEngine();
            lexicalEngine = new SimpleWordEngine(musicTheory);
            lexicalEngine.debug = true; // Enable debug logging
            
            console.log('[LexicalIntegration] ‚úÖ SIMPLE WORD ENGINE INITIALIZED - direct word-to-music mapping');
            console.log('[LexicalIntegration] Engine type:', typeof lexicalEngine);
            console.log('[LexicalIntegration] Engine constructor:', lexicalEngine.constructor.name);
        } catch (err) {
            console.error('[LexicalIntegration] Initialization failed:', err);
        }
    }
    
    // Start initialization
    setTimeout(initLexicalSystem, 500);

    // Input mode toggle
    const inputModeWords = document.getElementById('input-mode-words');
    const inputModeNumbers = document.getElementById('input-mode-numbers');
    const globalWordInput = document.getElementById('global-word-input');
    const globalManualNumbers = document.getElementById('global-manual-numbers');

    if (inputModeWords && inputModeNumbers && globalWordInput && globalManualNumbers) {
        inputModeWords.addEventListener('click', () => {
            inputModeWords.classList.add('active');
            inputModeNumbers.classList.remove('active');
            globalWordInput.style.display = '';
            globalManualNumbers.style.display = 'none';
        });

        inputModeNumbers.addEventListener('click', () => {
            inputModeNumbers.classList.add('active');
            inputModeWords.classList.remove('active');
            globalManualNumbers.style.display = '';
            globalWordInput.style.display = 'none';
        });
    }

    // Word settings panel toggle
    const wordSettingsBtn = document.getElementById('word-settings-btn');
    const wordSettingsPanel = document.getElementById('word-settings-panel');
    
    if (wordSettingsBtn && wordSettingsPanel) {
        wordSettingsBtn.addEventListener('click', () => {
            wordSettingsPanel.classList.toggle('active');
            // Close analysis panel if open
            const analysisPanel = document.getElementById('word-analysis-panel');
            if (analysisPanel) analysisPanel.classList.remove('active');
        });
    }

    // Weight sliders
    const weightSliders = {
        emotional: document.getElementById('weight-emotional'),
        syllabic: document.getElementById('weight-syllabic'),
        phonetic: document.getElementById('weight-phonetic'),
        semantic: document.getElementById('weight-semantic'),
        archetype: document.getElementById('weight-archetype')
    };

    // Initialize sliders with current lexicalWeights values and add event listeners
    Object.keys(weightSliders).forEach(key => {
        const slider = weightSliders[key];
        if (slider) {
            // Sync slider with current lexicalWeights value
            const currentWeight = lexicalWeights[key] || 0;
            const sliderValue = Math.round(currentWeight * 100);
            slider.value = sliderValue;
            
            const valueDisplay = slider.nextElementSibling;
            if (valueDisplay) valueDisplay.textContent = sliderValue + '%';
            
            // Add event listener for changes
            slider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                if (valueDisplay) valueDisplay.textContent = value + '%';
                lexicalWeights[key] = value / 100;
            });
        }
    });

    // Reset weights button
    const resetWeightsBtn = document.getElementById('reset-weights-btn');
    if (resetWeightsBtn) {
        resetWeightsBtn.addEventListener('click', () => {
            const defaults = { emotional: 30, syllabic: 20, phonetic: 15, semantic: 25, archetype: 10 };
            Object.keys(defaults).forEach(key => {
                const slider = weightSliders[key];
                if (slider) {
                    slider.value = defaults[key];
                    const valueDisplay = slider.nextElementSibling;
                    if (valueDisplay) valueDisplay.textContent = defaults[key] + '%';
                    lexicalWeights[key] = defaults[key] / 100;
                }
            });
        });
    }
    
    // Copy Lexical Log button
    const copyLexicalLogBtn = document.getElementById('copy-lexical-log-btn');
    if (copyLexicalLogBtn) {
        copyLexicalLogBtn.addEventListener('click', () => {
            copyLexicalLogToClipboard();
        });
    }

    // Debug Log button
    const debugLogBtn = document.getElementById('debug-log-btn');
    if (debugLogBtn) {
        debugLogBtn.addEventListener('click', () => {
            showDebugLog();
        });
    }
    // Export / Clear session log buttons (session log UI)
    const exportLexicalLogBtn = document.getElementById('export-lexical-log-btn');
    if (exportLexicalLogBtn) {
        exportLexicalLogBtn.addEventListener('click', () => exportLexicalLog());
    }
    const clearLexicalLogBtn = document.getElementById('clear-lexical-log-btn');
    if (clearLexicalLogBtn) {
        clearLexicalLogBtn.addEventListener('click', () => {
            if (!confirm('Clear lexical session log?')) return;
            window.__lexicalLog = [];
            try { renderLexicalLog(); } catch(_) {}
        });
    }
    
    // Randomize button
    const randomizeBtn = document.getElementById('word-randomize-btn');
    if (randomizeBtn) {
        randomizeBtn.addEventListener('click', () => {
            console.log('[LexicalIntegration] Randomizing weights...');
            
            // Generate random weights that sum to 100
            let remaining = 100;
            const keys = Object.keys(lexicalWeights);
            const randomWeights = {};
            
            keys.forEach((key, idx) => {
                if (idx === keys.length - 1) {
                    // Last one gets the remainder
                    randomWeights[key] = remaining;
                } else {
                    // Random value between 5 and 40
                    const value = Math.floor(Math.random() * 36) + 5;
                    randomWeights[key] = Math.min(value, remaining - (keys.length - idx - 1) * 5);
                    remaining -= randomWeights[key];
                }
            });
            
            // Apply random weights to sliders
            Object.keys(randomWeights).forEach(key => {
                const slider = weightSliders[key];
                if (slider) {
                    slider.value = randomWeights[key];
                    const valueDisplay = slider.nextElementSibling;
                    if (valueDisplay) valueDisplay.textContent = randomWeights[key] + '%';
                    lexicalWeights[key] = randomWeights[key] / 100;
                }
            });
            
            // Reprocess current input with new weights
            if (globalWordInput && globalWordInput.value.trim()) {
                console.log('[LexicalIntegration] Reprocessing with new weights:', lexicalWeights);
                processWordsInput(globalWordInput.value.trim());
            }
        });
    }

    // Aggressive mapping checkbox handling
    const aggressiveCheckbox = document.getElementById('weight-aggressive');
    if (aggressiveCheckbox) {
        aggressiveCheckbox.addEventListener('change', (e) => {
            lexicalSettings.aggressiveMapping = !!e.target.checked;
            console.log('[LexicalIntegration] aggressiveMapping set to', lexicalSettings.aggressiveMapping);
        });
    }

    // Key variety checkbox handling
    const keyVarietyCheckbox = document.getElementById('weight-key-variety');
    if (keyVarietyCheckbox) {
        keyVarietyCheckbox.addEventListener('change', (e) => {
            const enabled = !!e.target.checked;
            console.log('[LexicalIntegration] Key variety set to', enabled);
            lexicalSettings.keyVariety = enabled;
        });
    }
    
    // Auto-send checkbox handling
    const autoSendCheckbox = document.getElementById('weight-auto-send');
    if (autoSendCheckbox) {
        autoSendCheckbox.addEventListener('change', (e) => {
            lexicalSettings.autoSend = !!e.target.checked;
            console.log('[LexicalIntegration] Auto-send set to', lexicalSettings.autoSend);
        });
    }

    // Regenerate button (re-run translate with current weights)
    const regenerateBtn = document.getElementById('word-regenerate-btn');
    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', () => {
            if (!globalWordInput || !globalWordInput.value.trim()) return;
            console.log('[LexicalIntegration] Regenerate pressed - using weights:', lexicalWeights);
            processWordsInput(globalWordInput.value.trim());
        });
    }

    // Send to Sheet button - uses latest lexical result to update NumberGenerator / Sheet
    const sendSheetBtn = document.getElementById('word-send-sheet-btn');
    if (sendSheetBtn) {
        sendSheetBtn.addEventListener('click', () => {
            const last = window.__lastLexicalResult;
            if (!last) {
                alert('No translation result available to send. Please generate one first.');
                return;
            }
            try {
                console.log('[LexicalIntegration] Sending latest result to sheet music');
                updateNumberGenerator(last);
                // Optional visual feedback
                const toast = document.createElement('div');
                toast.textContent = 'Sent to Sheet Music';
                toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:8px 12px;border-radius:4px;font-size:13px;z-index:10000;';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 1500);
            } catch (e) {
                console.error('[LexicalIntegration] Send to sheet failed', e);
                alert('Failed to send to sheet. See console.');
            }
        });
    }

    // Word input processing with debouncing
    let wordInputTimeout = null;
    let isUserDismissingPanel = false;
    let lastEnterTime = 0;
    
    if (globalWordInput) {
        // Remove any existing listeners to prevent duplicates
        if (globalWordInput._inputHandler) {
            globalWordInput.removeEventListener('input', globalWordInput._inputHandler);
        }
        if (globalWordInput._keydownHandler) {
            globalWordInput.removeEventListener('keydown', globalWordInput._keydownHandler);
        }
        if (globalWordInput._blurHandler) {
            globalWordInput.removeEventListener('blur', globalWordInput._blurHandler);
        }
        
        // Input event - just clear empty state, don't process
        globalWordInput._inputHandler = (e) => {
            const words = e.target.value.trim();
            
            if (!words) {
                // Clear analysis panel
                const analysisContent = document.getElementById('word-analysis-content');
                if (analysisContent) {
                    analysisContent.innerHTML = '<div class="analysis-empty">Enter words above to see analysis...</div>';
                }
            }
        };
        globalWordInput.addEventListener('input', globalWordInput._inputHandler);
        
        // Enter key - process immediately
        globalWordInput._keydownHandler = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(wordInputTimeout);
                const words = e.target.value.trim();
                if (words) {
                    console.log('[LexicalIntegration] Enter key pressed, processing immediately');
                    lastEnterTime = Date.now(); // Track when Enter was pressed
                    isUserDismissingPanel = false; // Enter key should show panel
                    processWordsInput(words);
                }
            }
        };
        globalWordInput.addEventListener('keydown', globalWordInput._keydownHandler);
        
        // Blur event - DISABLED to prevent double processing
        // Only process on Enter key, not on blur
        globalWordInput._blurHandler = (e) => {
            console.log('[LexicalIntegration] Blur event fired but processing DISABLED to prevent double processing');
            // Just set the dismissing flag, don't process
            isUserDismissingPanel = true;
        };
        globalWordInput.addEventListener('blur', globalWordInput._blurHandler);
    }

    /**
     * Global Undo/Redo System
     */
    function captureGlobalState() {
        try {
            return {
                timestamp: Date.now(),
                lexicalResult: window.__lastLexicalResult ? JSON.parse(JSON.stringify(window.__lastLexicalResult)) : null,
                wordInput: globalWordInput ? globalWordInput.value : '',
                weights: { ...lexicalWeights },
                settings: { ...lexicalSettings }
            };
        } catch (e) {
            console.warn('[Undo/Redo] Failed to capture state:', e);
            return null;
        }
    }
    
    function saveToHistory() {
        const state = captureGlobalState();
        if (!state) return;
        
        // Remove any future history if we're not at the end
        if (globalHistoryIndex < globalHistory.length - 1) {
            globalHistory = globalHistory.slice(0, globalHistoryIndex + 1);
        }
        
        globalHistory.push(state);
        if (globalHistory.length > MAX_HISTORY) {
            globalHistory.shift();
        } else {
            globalHistoryIndex++;
        }
        
        updateUndoRedoButtons();
        console.log('[Undo/Redo] Saved state', globalHistoryIndex, '/', globalHistory.length);
    }
    
    function restoreState(state) {
        if (!state) return;
        
        try {
            // Restore word input
            if (globalWordInput && state.wordInput !== undefined) {
                globalWordInput.value = state.wordInput;
            }
            
            // Restore weights
            if (state.weights) {
                Object.assign(lexicalWeights, state.weights);
                Object.keys(weightSliders).forEach(key => {
                    const slider = weightSliders[key];
                    if (slider && state.weights[key] !== undefined) {
                        slider.value = Math.round(state.weights[key] * 100);
                        const valueDisplay = slider.nextElementSibling;
                        if (valueDisplay) valueDisplay.textContent = Math.round(state.weights[key] * 100) + '%';
                    }
                });
            }
            
            // Restore settings
            if (state.settings) {
                Object.assign(lexicalSettings, state.settings);
            }
            
            // Restore and display result
            if (state.lexicalResult) {
                window.__lastLexicalResult = state.lexicalResult;
                updateAnalysisPanel(state.lexicalResult);
                if (lexicalSettings.autoSend) {
                    updateNumberGenerator(state.lexicalResult);
                }
            }
            
            console.log('[Undo/Redo] Restored state');
        } catch (e) {
            console.error('[Undo/Redo] Failed to restore state:', e);
        }
    }
    
    function globalUndo() {
        if (globalHistoryIndex <= 0) {
            console.log('[Undo/Redo] No more undo history');
            return;
        }
        
        globalHistoryIndex--;
        const state = globalHistory[globalHistoryIndex];
        restoreState(state);
        updateUndoRedoButtons();
        
        // Visual feedback
        showToast('‚Ü∂ Undo', '#64C8FF');
    }
    
    function globalRedo() {
        if (globalHistoryIndex >= globalHistory.length - 1) {
            console.log('[Undo/Redo] No more redo history');
            return;
        }
        
        globalHistoryIndex++;
        const state = globalHistory[globalHistoryIndex];
        restoreState(state);
        updateUndoRedoButtons();
        
        // Visual feedback
        showToast('‚Ü∑ Redo', '#10b981');
    }
    
    function updateUndoRedoButtons() {
        const undoBtn = document.getElementById('global-undo-btn');
        const redoBtn = document.getElementById('global-redo-btn');
        
        if (undoBtn) {
            undoBtn.disabled = globalHistoryIndex <= 0;
            undoBtn.style.opacity = globalHistoryIndex <= 0 ? '0.3' : '1';
        }
        
        if (redoBtn) {
            redoBtn.disabled = globalHistoryIndex >= globalHistory.length - 1;
            redoBtn.style.opacity = globalHistoryIndex >= globalHistory.length - 1 ? '0.3' : '1';
        }
    }
    
    function showToast(message, color = '#64C8FF') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `position:fixed;bottom:20px;right:20px;background:${color};color:#fff;padding:12px 20px;border-radius:6px;font-size:14px;font-weight:700;z-index:10000;box-shadow:0 4px 16px rgba(0,0,0,0.4);`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 1500);
    }
    
    // Wire up undo/redo buttons
    const undoBtn = document.getElementById('global-undo-btn');
    const redoBtn = document.getElementById('global-redo-btn');
    if (undoBtn) undoBtn.addEventListener('click', globalUndo);
    if (redoBtn) redoBtn.addEventListener('click', globalRedo);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            globalUndo();
        } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
            e.preventDefault();
            globalRedo();
        }
    });

    function copyLexicalLogToClipboard() {
        try {
            const logText = buildCompactLexicalLog();
            navigator.clipboard.writeText(logText).then(() => {
                console.log('[Lexical] Log copied to clipboard:\n' + logText);
                // Toast notification if available
                try {
                    const toast = document.createElement('div');
                    toast.textContent = 'Lexical log copied';
                    toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#64C8FF;color:#000;padding:12px 20px;border-radius:4px;font-size:14px;z-index:10000;animation:fadeInOut 2s;';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2000);
                } catch(_) {}
            }).catch(err => {
                alert('Failed to copy log. See console.');
                console.warn('[Lexical] Copy failed', err);
            });
        } catch (e) {
            alert('Failed to build log. See console.');
            console.error('[Lexical] Build log error', e);
        }
    }
    
    function buildCompactLexicalLog() {
        if (!window.__lexicalLog || window.__lexicalLog.length === 0) {
            return '[Lexical] No translations logged yet.';
        }
        
        const lines = [];
        lines.push('[Lexical Analysis Log]');
        lines.push('='.repeat(60));
        lines.push('');
        
        window.__lexicalLog.forEach((entry, idx) => {
            const time = new Date(entry.timestamp).toLocaleTimeString();
            lines.push(`#${idx + 1} [${time}] "${entry.input}"`);
            
            if (entry.result.scale) {
                const scaleStr = typeof entry.result.scale === 'object' 
                    ? `${entry.result.scale.root || entry.result.scale.key} ${entry.result.scale.name || entry.result.scale.scale}`
                    : entry.result.scale;
                lines.push(`  Scale: ${scaleStr}`);
            }
            
            if (entry.result.progression && entry.result.progression.length > 0) {
                const progStr = entry.result.progression.map(c => {
                    const name = c.fullName || c;
                    const degree = c.degree ? ` (${c.degree})` : '';
                    const func = c.function ? ` [${c.function}]` : '';
                    const tier = c.tier ? ` T${c.tier}` : '';
                    return name + degree + func + tier;
                }).join(' ‚Üí ');
                lines.push(`  Progression: ${progStr}`);
            }
            
            if (entry.result.complexity) {
                const cplx = entry.result.complexity;
                if (typeof cplx === 'object') {
                    lines.push(`  Complexity: H=${Math.round(cplx.harmonic*100)}% R=${Math.round(cplx.rhythmic*100)}% E=${Math.round(cplx.emotional*100)}% (${cplx.overall})`);
                } else {
                    lines.push(`  Complexity: ${cplx}`);
                }
            }
            
            if (entry.result.reasoning) {
                lines.push(`  Reasoning: ${entry.result.reasoning}`);
            }
            
            if (entry.weights) {
                const w = entry.weights;
                lines.push(`  Weights: Emotional=${w.emotional}% Semantic=${w.semantic}% Phonetic=${w.phonetic}% Arch=${w.archetype}%`);
            }
            
            lines.push('');
        });
        
        lines.push('='.repeat(60));
        lines.push(`Total translations: ${window.__lexicalLog.length}`);
        
        return lines.join('\n');
    }

    // Render in-page lexical session log with per-entry actions
    function renderLexicalLog() {
        const list = document.getElementById('lexical-log-list');
        if (!list) return;
        list.innerHTML = '';
        if (!window.__lexicalLog || window.__lexicalLog.length === 0) {
            list.innerHTML = '<div style="color:#999; font-size:12px; padding:6px;">No translations logged yet.</div>';
            return;
        }

        window.__lexicalLog.slice().reverse().forEach((entry, revIdx) => {
            const idx = window.__lexicalLog.length - 1 - revIdx;
            const item = document.createElement('div');
            item.style.padding = '8px';
            item.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';

            const left = document.createElement('div');
            left.style.flex = '1';
            left.innerHTML = `<div style="font-size:12px; color:var(--text-highlight); font-weight:600;">${entry.input}</div>` +
                `<div style="font-size:11px; color:#aaa; margin-top:4px;">${(entry.result.scale && (entry.result.scale.root || entry.result.scale.key) ? (entry.result.scale.root || entry.result.scale.key) + ' ' + (entry.result.scale.name || entry.result.scale.scale || '') : '')} ${entry.result.progression && entry.result.progression.length ? '¬∑ ' + entry.result.progression.map(c=>c.fullName||c).join(' ‚Üí ') : ''}</div>`;

            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '6px';

            const sendBtn = document.createElement('button');
            sendBtn.className = 'btn';
            sendBtn.style.fontSize = '0.75rem';
            sendBtn.textContent = 'Send';
            sendBtn.onclick = () => sendLogEntry(idx);

            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn';
            exportBtn.style.fontSize = '0.75rem';
            exportBtn.textContent = 'Export';
            exportBtn.onclick = () => exportLogEntry(idx);

            actions.appendChild(sendBtn);
            actions.appendChild(exportBtn);

            item.appendChild(left);
            item.appendChild(actions);
            list.appendChild(item);
        });
    }

    function sendLogEntry(index) {
        if (!window.__lexicalLog || !window.__lexicalLog[index]) {
            alert('Log entry not found');
            return;
        }
        const entry = window.__lexicalLog[index];
        // Reconstruct a compatible result object for updateNumberGenerator
        const res = {
            scale: entry.result.scale,
            progression: entry.result.progression
        };
        try {
            window.__lastLexicalResult = res;
            updateNumberGenerator(res);
            alert('Sent translation to sheet');
        } catch (err) {
            console.error('Failed to send log entry to sheet', err);
            alert('Failed to send to sheet. See console.');
        }
    }

    function exportLexicalLog() {
        if (!window.__lexicalLog || window.__lexicalLog.length === 0) {
            alert('No lexical log to export');
            return;
        }
        
        // Enhanced JSON export with grading metadata preservation
        const exportData = {
            format: 'JSON',
            version: '1.0',
            timestamp: new Date().toISOString(),
            gradingMetadata: {
                mode: window.musicEngine ? window.musicEngine.gradingMode : 'functional',
                preservationLevel: 'full',
                exportType: 'lexical-log'
            },
            data: {
                lexicalLog: window.__lexicalLog.map(entry => {
                    // Enhance each log entry with grading information if available
                    const enhancedEntry = { ...entry };
                    
                    // Add grading context if musical elements are present
                    if (entry.scale && window.musicEngine) {
                        try {
                            const context = {
                                key: entry.key || 'C',
                                scaleType: entry.scale,
                                elementType: 'scale'
                            };
                            const tier = window.musicEngine.calculateElementGrade(entry.scale, context);
                            const tierInfo = window.musicEngine.getGradingTierInfo(tier);
                            
                            enhancedEntry.grading = {
                                tier,
                                mode: window.musicEngine.gradingMode,
                                label: tierInfo.label,
                                color: tierInfo.color,
                                name: tierInfo.name,
                                explanation: window.musicEngine.getGradingExplanation ? 
                                    window.musicEngine.getGradingExplanation(entry.scale, tier, context) : 
                                    `${entry.scale} receives ${tierInfo.name} grade in ${window.musicEngine.gradingMode} mode`
                            };
                        } catch (e) {
                            // Grading failed, continue without it
                        }
                    }
                    
                    // Add grading for chord progressions if present
                    if (entry.chords && Array.isArray(entry.chords) && window.musicEngine) {
                        enhancedEntry.chordGrading = entry.chords.map(chord => {
                            try {
                                const context = {
                                    key: entry.key || 'C',
                                    scaleType: entry.scale || 'major',
                                    elementType: 'chord'
                                };
                                const tier = window.musicEngine.calculateElementGrade(chord, context);
                                const tierInfo = window.musicEngine.getGradingTierInfo(tier);
                                
                                return {
                                    chord,
                                    tier,
                                    label: tierInfo.label,
                                    color: tierInfo.color,
                                    name: tierInfo.name
                                };
                            } catch (e) {
                                return { chord, tier: 2, label: 'Good', color: '#fbbf24', name: 'Good' };
                            }
                        });
                    }
                    
                    return enhancedEntry;
                })
            },
            metadata: {
                totalEntries: window.__lexicalLog.length,
                exportedAt: new Date().toISOString(),
                gradingMode: window.musicEngine ? window.musicEngine.gradingMode : 'functional',
                gradingVersion: '1.0'
            }
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lexical-log-enhanced-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // Enhanced JSON export for musical data with grading metadata preservation
    function exportMusicalDataToJSON(musicalData, options = {}) {
        if (!musicalData) {
            console.warn('No musical data provided for export');
            return null;
        }
        
        const exportData = {
            format: 'JSON',
            version: '1.0',
            timestamp: new Date().toISOString(),
            gradingMetadata: {
                mode: window.musicEngine ? window.musicEngine.gradingMode : 'functional',
                preservationLevel: options.preservationLevel || 'full',
                exportType: options.exportType || 'musical-data'
            },
            data: {}
        };

        // Process different types of musical data
        if (musicalData.progression && Array.isArray(musicalData.progression)) {
            exportData.data.progression = musicalData.progression.map((chord, index) => {
                const enhancedChord = { ...chord };
                
                // Add grading information if music engine is available
                if (window.musicEngine && typeof window.musicEngine.calculateElementGrade === 'function') {
                    try {
                        const context = {
                            key: musicalData.key || chord.key || 'C',
                            scaleType: musicalData.scale || chord.scale || 'major',
                            elementType: 'chord',
                            progressionIndex: index
                        };
                        
                        const chordName = chord.name || chord.root + (chord.chordType || '');
                        const tier = window.musicEngine.calculateElementGrade(chordName, context);
                        const tierInfo = window.musicEngine.getGradingTierInfo(tier);
                        
                        enhancedChord.grading = {
                            tier,
                            mode: window.musicEngine.gradingMode,
                            label: tierInfo.label,
                            color: tierInfo.color,
                            name: tierInfo.name,
                            short: tierInfo.short,
                            explanation: window.musicEngine.getGradingExplanation ? 
                                window.musicEngine.getGradingExplanation(chordName, tier, context) : 
                                `${chordName} receives ${tierInfo.name} grade in ${window.musicEngine.gradingMode} mode`
                        };
                    } catch (e) {
                        console.warn('Failed to add grading for chord:', chord, e);
                    }
                }
                
                return enhancedChord;
            });
        }

        // Process scale information
        if (musicalData.scale) {
            exportData.data.scale = {
                name: musicalData.scale,
                key: musicalData.key || 'C'
            };
            
            if (window.musicEngine) {
                try {
                    const context = {
                        key: musicalData.key || 'C',
                        scaleType: musicalData.scale,
                        elementType: 'scale'
                    };
                    const tier = window.musicEngine.calculateElementGrade(musicalData.scale, context);
                    const tierInfo = window.musicEngine.getGradingTierInfo(tier);
                    
                    exportData.data.scale.grading = {
                        tier,
                        mode: window.musicEngine.gradingMode,
                        label: tierInfo.label,
                        color: tierInfo.color,
                        name: tierInfo.name,
                        explanation: window.musicEngine.getGradingExplanation ? 
                            window.musicEngine.getGradingExplanation(musicalData.scale, tier, context) : 
                            `${musicalData.scale} receives ${tierInfo.name} grade in ${window.musicEngine.gradingMode} mode`
                    };
                } catch (e) {
                    console.warn('Failed to add grading for scale:', musicalData.scale, e);
                }
            }
        }

        // Add any additional musical data
        if (musicalData.notes && Array.isArray(musicalData.notes)) {
            exportData.data.notes = musicalData.notes.map(note => {
                const enhancedNote = typeof note === 'string' ? { name: note } : { ...note };
                
                if (window.musicEngine) {
                    try {
                        const context = {
                            key: musicalData.key || 'C',
                            scaleType: musicalData.scale || 'major',
                            elementType: 'note'
                        };
                        const noteName = enhancedNote.name || note;
                        const tier = window.musicEngine.calculateElementGrade(noteName, context);
                        const tierInfo = window.musicEngine.getGradingTierInfo(tier);
                        
                        enhancedNote.grading = {
                            tier,
                            mode: window.musicEngine.gradingMode,
                            label: tierInfo.label,
                            color: tierInfo.color,
                            name: tierInfo.name
                        };
                    } catch (e) {
                        console.warn('Failed to add grading for note:', note, e);
                    }
                }
                
                return enhancedNote;
            });
        }

        // Add metadata about the export
        exportData.metadata = {
            exportedAt: new Date().toISOString(),
            gradingMode: window.musicEngine ? window.musicEngine.gradingMode : 'functional',
            gradingVersion: '1.0',
            dataIntegrity: validateGradingMetadata(exportData),
            originalDataKeys: Object.keys(musicalData)
        };

        return exportData;
    }

    // Grading metadata validation for export integrity
    function validateGradingMetadata(exportData) {
        const validation = {
            hasGradingMode: false,
            hasGradingData: false,
            gradingConsistency: true,
            validTiers: true,
            errors: []
        };

        try {
            // Check if grading mode is present
            if (exportData.gradingMetadata && exportData.gradingMetadata.mode) {
                validation.hasGradingMode = true;
            } else {
                validation.errors.push('Missing grading mode in metadata');
            }

            // Check if any grading data exists
            const checkForGrading = (obj) => {
                if (obj && typeof obj === 'object') {
                    if (obj.grading) {
                        validation.hasGradingData = true;
                        
                        // Validate tier range
                        if (obj.grading.tier < 0 || obj.grading.tier > 4) {
                            validation.validTiers = false;
                            validation.errors.push(`Invalid tier: ${obj.grading.tier}`);
                        }
                        
                        // Check required grading fields
                        const requiredFields = ['tier', 'label', 'color', 'name'];
                        requiredFields.forEach(field => {
                            if (!obj.grading[field]) {
                                validation.gradingConsistency = false;
                                validation.errors.push(`Missing grading field: ${field}`);
                            }
                        });
                    }
                    
                    // Recursively check nested objects
                    Object.values(obj).forEach(value => {
                        if (Array.isArray(value)) {
                            value.forEach(item => checkForGrading(item));
                        } else {
                            checkForGrading(value);
                        }
                    });
                }
            };

            checkForGrading(exportData.data);

        } catch (e) {
            validation.errors.push(`Validation error: ${e.message}`);
        }

        validation.isValid = validation.hasGradingMode && validation.hasGradingData && 
                           validation.gradingConsistency && validation.validTiers && 
                           validation.errors.length === 0;

        return validation;
    }

    // Enhanced sharing functionality with grading metadata preservation
    function shareMusicalDataWithGrading(musicalData, shareFormat = 'JSON', options = {}) {
        if (!musicalData) {
            console.warn('No musical data provided for sharing');
            return null;
        }

        let sharedData;
        const timestamp = new Date().toISOString();

        try {
            switch (shareFormat.toUpperCase()) {
                case 'JSON':
                    sharedData = exportMusicalDataToJSON(musicalData, {
                        ...options,
                        exportType: 'shared-data'
                    });
                    break;
                    
                case 'MIDI':
                    // For MIDI sharing, we need to work with the sheet music generator
                    if (window.sheetMusicGenerator && typeof window.sheetMusicGenerator.buildMidiFile === 'function') {
                        try {
                            const midiData = window.sheetMusicGenerator.buildMidiFile(options);
                            sharedData = {
                                format: 'MIDI',
                                data: midiData,
                                gradingMetadata: {
                                    mode: window.musicEngine ? window.musicEngine.gradingMode : 'functional',
                                    preservedInMidi: true,
                                    version: '1.0'
                                }
                            };
                        } catch (e) {
                            console.warn('MIDI generation failed, falling back to JSON:', e);
                            sharedData = exportMusicalDataToJSON(musicalData, options);
                        }
                    } else {
                        console.warn('MIDI export not available, using JSON format');
                        sharedData = exportMusicalDataToJSON(musicalData, options);
                    }
                    break;
                    
                default:
                    console.warn(`Unsupported share format: ${shareFormat}, using JSON`);
                    sharedData = exportMusicalDataToJSON(musicalData, options);
            }

            // Add sharing metadata
            if (sharedData) {
                sharedData.sharingInfo = {
                    sharedAt: timestamp,
                    format: shareFormat,
                    gradingPreserved: true,
                    gradingMode: window.musicEngine ? window.musicEngine.gradingMode : 'functional',
                    shareId: generateShareId(),
                    integrity: validateGradingMetadata(sharedData)
                };
            }

        } catch (e) {
            console.error('Sharing failed:', e);
            return null;
        }

        return sharedData;
    }

    // Generate a unique share ID for tracking
    function generateShareId() {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substr(2, 5);
        return `share_${timestamp}_${random}`;
    }

    // Export shared data as downloadable file
    function downloadSharedData(sharedData, filename) {
        if (!sharedData) {
            console.warn('No shared data to download');
            return;
        }

        const blob = new Blob([JSON.stringify(sharedData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || `shared-musical-data-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function showDebugLog() {
        let debugInfo = [];
        
        // Check ScaleIntelligenceEngine availability
        debugInfo.push('=== SCALE INTELLIGENCE ENGINE DEBUG ===');
        debugInfo.push(`ScaleIntelligenceEngine defined: ${typeof ScaleIntelligenceEngine !== 'undefined' ? '‚úÖ YES' : '‚ùå NO'}`);
        
        if (typeof ScaleIntelligenceEngine !== 'undefined') {
            try {
                const testEngine = new ScaleIntelligenceEngine();
                debugInfo.push(`ScaleIntelligenceEngine creation: ‚úÖ SUCCESS`);
                debugInfo.push(`Scale database size: ${Object.keys(testEngine.scaleDatabase || {}).length} scales`);
                
                // Test scale selection
                const testResult = testEngine.selectScale({
                    darkness: 0.6, energy: 0.57, mystery: 0.23, brightness: 0, tension: 0.5,
                    words: ['chase', 'woods', 'danger']
                });
                debugInfo.push(`Test selection: ${testResult.name} (${Math.round(testResult.score * 100)}%)`);
                debugInfo.push(`Test reason: ${testResult.primaryReason}`);
                
            } catch (error) {
                debugInfo.push(`ScaleIntelligenceEngine creation: ‚ùå FAILED - ${error.message}`);
            }
        }
        
        // Check SimpleWordEngine status
        debugInfo.push('');
        debugInfo.push('=== SIMPLE WORD ENGINE DEBUG ===');
        debugInfo.push(`lexicalEngine defined: ${lexicalEngine ? '‚úÖ YES' : '‚ùå NO'}`);
        
        if (lexicalEngine) {
            debugInfo.push(`Engine type: ${lexicalEngine.constructor.name}`);
            debugInfo.push(`Scale Intelligence available: ${lexicalEngine.scaleIntelligence ? '‚úÖ YES' : '‚ùå NO'}`);
            debugInfo.push(`Debug mode: ${lexicalEngine.debug ? '‚úÖ ON' : '‚ùå OFF'}`);
            debugInfo.push(`Word mappings: ${Object.keys(lexicalEngine.wordMappings || {}).length} entries`);
        }
        
        // Check recent translations
        debugInfo.push('');
        debugInfo.push('=== RECENT TRANSLATIONS ===');
        if (window.__lexicalLog && window.__lexicalLog.length > 0) {
            const recent = window.__lexicalLog.slice(-3);
            recent.forEach((entry, i) => {
                debugInfo.push(`${i + 1}. "${entry.input}" ‚Üí ${entry.result?.scale?.root || 'unknown'} ${entry.result?.scale?.name || 'unknown'}`);
            });
        } else {
            debugInfo.push('No translations logged yet');
        }
        
        // Show in a modal
        const debugText = debugInfo.join('\\n');
        
        // Create a simple modal-like display
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #1a1a1a; border: 2px solid var(--accent-primary);
            padding: 20px; border-radius: 8px; z-index: 10000;
            max-width: 600px; max-height: 80vh; overflow: auto;
            font-family: monospace; font-size: 12px; color: #fff;
        `;
        
        modal.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: var(--accent-primary);">üîç Debug Information</h3>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #fff; font-size: 18px; cursor: pointer;">‚úï</button>
            </div>
            <pre style="margin: 0; white-space: pre-wrap; line-height: 1.4;">${debugInfo.join('\\n')}</pre>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="navigator.clipboard.writeText(\`${debugText}\`); alert('Debug info copied to clipboard!')" 
                        style="padding: 8px 16px; background: var(--accent-primary); color: #000; border: none; border-radius: 4px; cursor: pointer;">
                    üìã Copy to Clipboard
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Also log to console for backup
        console.log('[DEBUG LOG]\\n' + debugText);
    }

    function exportLogEntry(index) {
        if (!window.__lexicalLog || !window.__lexicalLog[index]) {
            alert('Log entry not found');
            return;
        }
        const entry = window.__lexicalLog[index];
        const blob = new Blob([JSON.stringify(entry, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lexical-entry-${index + 1}-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // Prevent rapid successive calls and processing locks
    let lastProcessTime = 0;
    let lastProcessWords = '';
    let isProcessing = false;
    let globalProcessingBlock = false;
    
    async function processWordsInput(words) {
        const now = Date.now();
        
        // Debug: Track function calls with detailed stack trace
        console.log('[DEBUG] ========================================');
        console.log('[DEBUG] processWordsInput called with:', words);
        console.log('[DEBUG] Timestamp:', now);
        console.log('[DEBUG] Last process time:', lastProcessTime);
        console.log('[DEBUG] Time since last:', now - lastProcessTime, 'ms');
        console.log('[DEBUG] Last words:', lastProcessWords);
        console.log('[DEBUG] Is processing:', isProcessing);
        console.log('[DEBUG] Full stack trace:');
        console.log(new Error().stack);
        console.log('[DEBUG] ========================================');
        
        // Prevent duplicate calls within 500ms with same words (increased from 200ms)
        if (words === lastProcessWords && (now - lastProcessTime) < 500) {
            console.log('[DEBUG] ‚ùå BLOCKED: Duplicate call within 500ms');
            return;
        }
        
        // Prevent overlapping processing
        if (isProcessing) {
            console.log('[DEBUG] ‚ùå BLOCKED: Already processing');
            return;
        }
        
        // Global processing block check
        if (globalProcessingBlock) {
            console.log('[DEBUG] ‚ùå BLOCKED: Global processing block active');
            return;
        }
        
        console.log('[DEBUG] ‚úÖ PROCEEDING with processing');
        isProcessing = true;
        globalProcessingBlock = true;
        lastProcessTime = now;
        lastProcessWords = words;
        
        // Set a timer to release the global block
        setTimeout(() => {
            globalProcessingBlock = false;
            console.log('[DEBUG] üîì Global processing block released');
        }, 1000); // 1 second block
        
        if (!lexicalEngine) {
            console.warn('[LexicalIntegration] Engine not initialized');
            return;
        }



        try {
            console.log('[LexicalIntegration] Processing words:', words);
            console.log('[LexicalIntegration] Current weights:', lexicalWeights);
            
            // Translate words to music with current weights (now async)
            const result = await lexicalEngine.translateWords(words, { 
                weights: lexicalWeights, 
                aggressive: lexicalSettings.aggressiveMapping,
                dynamicKeys: lexicalSettings.keyVariety 
            });
            console.log('[LexicalIntegration] Translation result:', result);

            // Expose latest result for Send-to-Sheet and other quick actions
            try { window.__lastLexicalResult = result; } catch(_) {}
            
            // Log to global lexical log
            if (!window.__lexicalLog) window.__lexicalLog = [];
            window.__lexicalLog.push({
                type: 'translateWords',
                timestamp: new Date().toISOString(),
                input: words,
                weights: { ...lexicalWeights },
                result: {
                    scale: result.scale,
                    progression: result.progression ? result.progression.map(c => ({
                        fullName: c.fullName || c,
                        degree: c.degree,
                        function: c.function,
                        tier: c.tier
                    })) : [],
                    complexity: result.complexity,
                    reasoning: result.reasoning ? result.reasoning.summary : null
                }
            });
            // Keep log manageable
            if (window.__lexicalLog.length > 50) window.__lexicalLog.shift();
            // Refresh in-page log (if present)
            try { renderLexicalLog(); } catch(_) {}

            // Update analysis panel
            updateAnalysisPanel(result);

            // Extract chord degrees and update NumberGenerator
            if (result.progression && result.progression.length > 0) {
                // Only auto-send if setting is enabled
                if (lexicalSettings.autoSend) {
                    updateNumberGenerator(result);
                    console.log('[LexicalIntegration] Auto-sent to sheet music');
                } else {
                    console.log('[LexicalIntegration] Auto-send disabled, use üéº button');
                }
            } else {
                console.warn('[LexicalIntegration] No progression generated');
            }
            
            // Save to undo/redo history
            saveToHistory();

        } catch (err) {
            console.error('[LexicalIntegration] Translation error:', err);
            console.error('[LexicalIntegration] Error stack:', err.stack);
        } finally {
            // Always reset processing flag
            isProcessing = false;
            console.log('[DEBUG] Processing flag reset');
        }
    }

    function updateAnalysisPanel(result) {
        const analysisContent = document.getElementById('word-analysis-content');
        const analysisPanel = document.getElementById('word-analysis-panel');
        
        console.log('[updateAnalysisPanel] Called with result:', result);
        console.log('[updateAnalysisPanel] analysisContent:', analysisContent);
        console.log('[updateAnalysisPanel] analysisPanel:', analysisPanel);
        
        if (!analysisContent || !result) {
            console.warn('[updateAnalysisPanel] Missing content or result');
            return;
        }

        let html = '';

        // CURRENT WEIGHTS DISPLAY (NEW!)
        html += `
            <div class="analysis-section" style="background: rgba(147,51,234,0.15); border-left: 3px solid #9333ea;">
                <div class="analysis-section-title">‚öñÔ∏è CURRENT WEIGHTS</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa;">Emotional:</span>
                        <span style="font-weight: bold; color: #64C8FF;">${Math.round((lexicalWeights.emotional || 0) * 100)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa;">Semantic:</span>
                        <span style="font-weight: bold; color: #10b981;">${Math.round((lexicalWeights.semantic || 0) * 100)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa;">Phonetic:</span>
                        <span style="font-weight: bold; color: #f59e0b;">${Math.round((lexicalWeights.phonetic || 0) * 100)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa;">Syllabic:</span>
                        <span style="font-weight: bold; color: #8b5cf6;">${Math.round((lexicalWeights.syllabic || 0) * 100)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa;">Archetype:</span>
                        <span style="font-weight: bold; color: #ec4899;">${Math.round((lexicalWeights.archetype || 0) * 100)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #aaa;">Aggressive:</span>
                        <span style="font-weight: bold; color: ${lexicalSettings.aggressiveMapping ? '#ef4444' : '#666'};">${lexicalSettings.aggressiveMapping ? 'ON' : 'OFF'}</span>
                    </div>
                </div>
                <div style="font-size: 10px; color: #666; margin-top: 8px; font-style: italic;">
                    üí° Tip: Click üé≤ to randomize weights or ‚öôÔ∏è to adjust manually
                </div>
            </div>
        `;

        // REASONING SECTION (NEW!)
        if (result.reasoning) {
            html += `
                <div class="analysis-section" style="background: rgba(100,200,255,0.1); border-left: 3px solid #64C8FF;">
                    <div class="analysis-section-title">üí° REASONING</div>
                    <div class="analysis-item" style="font-size: 13px; line-height: 1.6;">
                        ${result.reasoning.summary}
                    </div>
                </div>
            `;
        }

        // Scale section with reasoning
        if (result.scale) {
            html += `
                <div class="analysis-section">
                    <div class="analysis-section-title">üéµ Scale Suggestion</div>
                    <div class="analysis-item">
                        <span class="analysis-item-label">Key:</span>
                        <span class="analysis-item-value">${result.scale.root || result.scale.key || 'C'}</span>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-item-label">Scale:</span>
                        <span class="analysis-item-value">${result.scale.name || result.scale.scale || 'major'}</span>
                    </div>
                    ${result.reasoning && result.reasoning.scaleChoice ? `
                    <div class="analysis-item" style="font-size: 11px; color: #aaa; font-style: italic; margin-top: 4px;">
                        Why: ${result.reasoning.scaleChoice}
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Progression section WITH TIER INFO & FUNCTIONAL HARMONY
        if (result.progression && result.progression.length > 0) {
            html += `<div class="analysis-section">
                    <div class="analysis-section-title">üéπ Chord Progression</div>`;
            
            result.progression.forEach((chord) => {
                // Get tier info for color
                const tierColor = chord.tierInfo ? chord.tierInfo.color : '#666';
                const tierLabel = chord.tierInfo ? chord.tierInfo.label : '';
                const tierStars = chord.tier ? '‚òÖ'.repeat(chord.tier) : '';
                
                // Chord name
                let chordName;
                if (typeof chord === 'string') {
                    chordName = chord;
                } else if (chord.fullName) {
                    chordName = chord.fullName;
                } else if (chord.root && chord.chordType !== undefined) {
                    chordName = chord.root + chord.chordType;
                } else {
                    chordName = String(chord);
                }
                
                html += `
                    <div class="analysis-item" style="border-left: 3px solid ${tierColor}; padding-left: 8px; margin-bottom: 8px;">
                        <span class="analysis-item-value" style="font-weight: 500;">${chordName}</span>`;
                
                // Show function and tier
                if (chord.function && chord.tier) {
                    html += `<div style="font-size: 11px; color: #aaa; margin-top: 2px;">${chord.function}, Tier ${chord.tier} ${tierStars}</div>`;
                }
                
                // Show reasoning for this chord
                if (chord.reasoning) {
                    html += `<div style="font-size: 11px; color: #888; margin-top: 4px; font-style: italic;">‚Üí ${chord.reasoning}</div>`;
                }
                
                html += `</div>`;
            });
            
            // Show progression logic
            if (result.reasoning && result.reasoning.progressionLogic) {
                html += `<div class="analysis-item" style="font-size: 11px; color: #888; font-style: italic; margin-top: 8px;">
                    Progression Logic: ${result.reasoning.progressionLogic}
                </div>`;
            }
            
            html += `</div>`;
        }

        // Complexity section
        if (result.complexity) {
            const isNumeric = typeof result.complexity === 'object' && 
                             result.complexity.harmonic !== undefined;
            if (isNumeric) {
                html += `
                    <div class="analysis-section">
                        <div class="analysis-section-title">‚öôÔ∏è Complexity</div>
                        <div class="analysis-item">
                            <span class="analysis-item-label">Harmonic:</span>
                            <span class="analysis-item-value">${Math.round(result.complexity.harmonic * 100)}%</span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-item-label">Rhythmic:</span>
                            <span class="analysis-item-value">${Math.round(result.complexity.rhythmic * 100)}%</span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-item-label">Emotional:</span>
                            <span class="analysis-item-value">${Math.round(result.complexity.emotional * 100)}%</span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-item-label">Overall:</span>
                            <span class="analysis-item-value">${result.complexity.overall || 'moderate'}</span>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="analysis-section">
                        <div class="analysis-section-title">‚öôÔ∏è Complexity</div>
                        <div class="analysis-item">
                            <span class="analysis-item-value">${result.complexity}</span>
                        </div>
                    </div>
                `;
            }
        }

        // Archetype matches
        if (result.archetypeMatch) {
            html += `
                <div class="analysis-section">
                    <div class="analysis-section-title">üé≠ Archetype Match</div>
                    <div class="archetype-match">
                        <div class="archetype-match-title">${result.archetypeMatch.name}</div>
                        ${result.archetypeMatch.description ? `<div style="font-size: 11px; color: #aaa; font-style: italic; margin-top: 4px;">${result.archetypeMatch.description}</div>` : ''}
                    </div>
                </div>
            `;
        } else if (result.analyses && result.analyses.archetypes) {
            const archetypes = result.analyses.archetypes;
            if (archetypes.matches && archetypes.matches.length > 0) {
                const topMatch = archetypes.matches[0];
                html += `
                    <div class="analysis-section">
                        <div class="analysis-section-title">üé¨ Archetype Match</div>
                        <div class="archetype-match">
                            <div class="archetype-match-title">${topMatch.name}</div>
                            <div class="archetype-match-confidence">Confidence: ${Math.round(topMatch.confidence * 100)}%</div>
                        </div>
                    </div>
                `;
            }
        }

        // WORD-BY-WORD ANALYSIS (collapsible, NEW!)
        if (result.reasoning && result.reasoning.wordAnalyses && result.reasoning.wordAnalyses.length > 0) {
            html += `
                <details class="analysis-section" style="cursor: pointer;" open>
                    <summary style="font-weight: bold; cursor: pointer;">üìù WORD-BY-WORD ANALYSIS (Rich Attributes)</summary>
                    <div style="padding-left: 12px; margin-top: 8px; border-left: 2px solid #444;">`;
            
            result.reasoning.wordAnalyses.forEach(wa => {
                const ma = wa.musicalAttributes || {};
                html += `
                    <div style="margin-bottom: 16px; background: rgba(100,200,255,0.05); padding: 10px; border-radius: 4px;">
                        <div style="font-weight: 600; color: #64C8FF; margin-bottom: 6px; font-size: 13px;">"${wa.word}"</div>
                        <div style="font-size: 11px; color: #aaa; line-height: 1.6;">
                            <strong>Emotional:</strong> valence: ${wa.emotional.valence.toFixed(2)}, arousal: ${wa.emotional.arousal.toFixed(2)}, dominance: ${wa.emotional.dominance.toFixed(2)}<br>`;
                
                // Show musical attributes if available
                if (ma.tension !== undefined) {
                    html += `<strong>Tension:</strong> ${Math.round(ma.tension*100)}% `;
                    html += ma.tension > 0.6 ? '‚ö° high' : ma.tension < 0.3 ? 'üïäÔ∏è low' : '‚öñÔ∏è moderate';
                    html += '<br>';
                }
                
                if (ma.color) {
                    html += `<strong>Color:</strong> ${Math.round(ma.color.warmth*100)}% warm, ${Math.round(ma.color.brightness*100)}% bright<br>`;
                }
                
                if (ma.texture) {
                    html += `<strong>Texture:</strong> ${Math.round(ma.texture.density*100)}% density, ${Math.round(ma.texture.spread*100)}% spread<br>`;
                }
                
                if (ma.motion) {
                    const dir = ma.motion.direction > 0.3 ? '‚ÜóÔ∏è ascending' : ma.motion.direction < -0.3 ? '‚ÜòÔ∏è descending' : '‚ü∑ static';
                    html += `<strong>Motion:</strong> ${dir}, ${Math.round(ma.motion.smoothness*100)}% smooth<br>`;
                }
                
                if (ma.register) {
                    html += `<strong>Register:</strong> ${ma.register.preferred} (${ma.register.range.toFixed(1)} octaves), ${ma.register.emphasis} emphasis<br>`;
                }
                
                if (ma.intervals && ma.intervals.preferred && ma.intervals.preferred.length > 0) {
                    html += `<strong>Intervals:</strong> prefers ${ma.intervals.preferred.slice(0,3).join(', ')}<br>`;
                }
                
                html += `</div>`;
                
                if (wa.implications && wa.implications.reasoning && wa.implications.reasoning.length > 0) {
                    html += '<div style="margin-top: 6px; padding-left: 8px; border-left: 2px solid #444;"><ul style="margin: 4px 0; padding-left: 20px; font-size: 10px; color: #888;">';
                    wa.implications.reasoning.slice(0,3).forEach(r => {
                        html += `<li style="margin: 2px 0;">${r}</li>`;
                    });
                    html += '</ul></div>';
                }
                html += `</div>`;
            });
            
            html += `</div></details>`;
        }

        analysisContent.innerHTML = html || '<div class="analysis-empty">No analysis data available</div>';
        
        console.log('[updateAnalysisPanel] HTML length:', html.length);
        console.log('[updateAnalysisPanel] Will show panel:', !!(html && analysisPanel));
        
        // Auto-show panel if it has content
        if (html && analysisPanel) {
            console.log('[updateAnalysisPanel] Adding active class to panel');
            // Only show panel if user isn't trying to dismiss it
            if (!isUserDismissingPanel) {
                analysisPanel.classList.add('active');
            } else {
                console.log('[updateAnalysisPanel] User is dismissing panel, not auto-showing');
                // Reset flag after a short delay to allow normal operation later
                setTimeout(() => {
                    isUserDismissingPanel = false;
                }, 500);
            }
        } else {
            console.warn('[updateAnalysisPanel] Not showing panel - html:', !!html, 'panel:', !!analysisPanel);
        }
    }

    function updateNumberGenerator(result) {
        // Extract chord degrees from progression and send to sheet music
        if (!result.scale || !result.progression) {
            console.warn('[LexicalIntegration] Missing scale or progression');
            return;
        }

        try {
            // Get NumberGenerator instance
            const numGen = window.numberGenerator;
            
            if (!numGen) {
                console.warn('[LexicalIntegration] NumberGenerator not available');
                return;
            }

            // Set the scale first
            const scaleKey = result.scale.root || result.scale.key || 'C';
            const scaleName = result.scale.name || result.scale.scale || 'major';
            console.log('[LexicalIntegration] Setting scale:', scaleKey, scaleName);
            console.log('[LexicalIntegration] Full scale object:', result.scale);
            
            // Update scale library if available
            if (window.scaleLibrary) {
                // Set key first, then scale
                window.scaleLibrary.setKeyAndScale(scaleKey, scaleName);
            }
            
            // Build chord tokens (handle both strings and objects)
            const chordTokens = result.progression.map(chord => {
                if (typeof chord === 'string') return chord;
                if (chord.fullName) return chord.fullName;
                if (chord.root && chord.chordType !== undefined) return chord.root + chord.chordType;
                return String(chord);
            });
            
            console.log('[LexicalIntegration] Chord tokens:', chordTokens);
            
            // Update the manual numbers input field for visibility
            if (window.globalManualNumbers) {
                window.globalManualNumbers.value = chordTokens.join(' ');
            }
            
            // Use setDisplayTokens method - this is the proper way to update NumberGenerator
            if (typeof numGen.setDisplayTokens === 'function') {
                console.log('[LexicalIntegration] Calling setDisplayTokens with:', chordTokens);
                numGen.setDisplayTokens(chordTokens, { 
                    rawTokens: chordTokens,
                    render: true,
                    emit: true
                });
                console.log('[LexicalIntegration] ‚úì Successfully sent to sheet music');
                showToast('üéº Sent to sheet music', '#10b981');
            } else {
                console.warn('[LexicalIntegration] NumberGenerator.setDisplayTokens not available');
            }

        } catch (err) {
            console.error('[LexicalIntegration] Error updating NumberGenerator:', err);
            console.error('[LexicalIntegration] Stack:', err.stack);
        }
    }

})();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const invBtn = document.getElementById('launch-learn-inversions-btn');
            if (invBtn) {
                invBtn.addEventListener('click', () => {
                    const landing = document.getElementById('landing-page');
                    if(landing) landing.style.display = 'none';

                    const page = document.getElementById('learn-inversions-page');
                    if(page) page.style.display = 'block';
                    
                    if (!window.learnInversionsApp) {
                        // Try to reuse existing engine from global app if available
                        const engine = (window.modularApp && window.modularApp.musicTheory) 
                                       ? window.modularApp.musicTheory 
                                       : (window.musicTheory || new MusicTheoryEngine());
                        
                        window.learnInversionsApp = new LearnInversions(engine);
                        window.learnInversionsApp.mount('#learn-inversions-container');
                    }
                });
            }
        });
    </script>
</body>
</html>
